import{playSound as e}from"./audio.js";import{drawArrow as t,drawEmojiAtSquare as n,removeCanvas as o}from"./canvas.js";import{renderSettings as r}from"./settings.js";import{changeBoardTheme as i,currentThemeName as c,imgPieceMapping as l}from"./themes.js";import{displayQRCode as s,generateChess960StartingPos as a,getDate as d,hideQRCode as u,isUppercase as m,letterRange as p,lock as h,simpleClone as f,uuid as g}from"./utils.js";(()=>{const y={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"},v=function(){const e={};return e.onopen=()=>{setInterval(en,8e3)},e.onclose=()=>{alert("Connection to server lost... reloading page."),window.location.reload()},e}();v.onmessage=({data:t})=>{!function(t){let n;try{n=JSON.parse(t)}catch(e){console.error(e)}if(!n)return;const{type:o,data:r}=n;switch(o){case"s.room.in":!function(e){if(k=e,k){document.getElementById("btnVsBot")?.remove(),document.getElementById("btnUndo")?.remove();const e=document.querySelector(".fen");e&&(e.style.display="none"),document.querySelectorAll(".score").forEach((e=>{e.style.display="flex"}))}nn()?tn(v,{type:"c.name.get",data:nn()}):on()}(r);break;case"s.room.share-info":rn(r);break;case"c.rid.register":!function(e){localStorage.setItem("rid",e);const t=()=>{let e=prompt("Name");return e||(e=t()),/^[a-zA-Z ]{2,}$/.test(e.trim())||(alert("Name must be alphabet and contains at least 2 characters"),e=t()),e};w=t(),tn(v,{type:"c.name.set",data:{name:w,rid:nn()}})}(r);case"c.name.get":!function(e){if(e)return void(w=e);on()}(r),function(){if(!k)return;tn(v,{type:"c.room.join",data:nn()})}();break;case"c.play.move":!function(e){const{from:t,to:n,timeWhite:o,timeBlack:r}=e;$e(t,n,!0),W.length>=q&&(xt.style.display="inline-block");o&&r&&(E.timeWhite=o,E.timeBlack=r,mn())}(r);break;case"c.play.checkmate":!function({scores:e,aPgnArchive:t}){E.status="finished",E.scores=e,E.pgnArchive.unshift(t),an(e),Lt.style.display="block",xt.style.display="none",mn()}(r);break;case"c.rematch.request":!function(e){const t=confirm(`${e} wants to rematch. Do you ACCEPT?`);Lt.style.display="none",!1===t&&(E.status="closed");tn(v,{type:"c.rematch.response",data:t})}(r);break;case"c.rematch.response":!function(t){if(!t||!1===t)return void alert("Rematch Declined");ct(),we(),xe(),rn(t),e("gameStart")}(r);break;case"c.resign":!function({message:t,scores:n,aPgnArchive:o}){un(o),U=!1,E.status="finished",E.scores=n,E.pgnArchive.unshift(o),an(n),xt.style.display="none",Bt.style.display="none",e("gameEnd"),ee&&Yt();clearInterval(C),setTimeout((()=>{alert(t),Lt.style.display="block"}),1e3)}(r);break;case"c.time.set":ln(r);break;case"s.time.info":!function({timeWhite:e,timeBlack:t}){E.timeWhite=e,E.timeBlack=t,mn()}(r);break;case"c.time.out":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:i}){U=!1,E.status="finished",E.timeWhite=t,E.timeBlack=n,E.scores=i,E.pgnArchive.unshift(o),an(i),mn(),Ft(),e("gameEnd"),ee&&Yt();setTimeout((()=>{Lt.style.display="block",xt.style.display="none",Bt.style.display="none",alert(r),L&&L.release()}),500)}(r);break;case"c.draw.offer":confirm(`${r} offers a draw. Do you accept?`)?dn():tn(v,{type:"c.draw.declined",data:!0});break;case"c.draw.declined":!function(e){alert(`${e} does not want to draw.`)}(r);break;case"c.draw.accepted":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:i}){U=!1,E.status="finished",E.timeWhite=t,E.timeBlack=n,E.scores=i,E.pgnArchive.unshift(o),an(i),mn(),Ft(),e("gameEnd"),setTimeout((()=>{Lt.style.display="block",xt.style.display="none",Bt.style.display="none",alert(r),L&&L.release()}),500)}(r);break;case"s.error":!function(e){console.error(e),alert(e),"object"==typeof e&&alert(JSON.stringify(e))}(r)}}(t)};let w=null,k=!1,E=null,b=null,S=null;const q=20;let C=null,L=null;let I=new URLSearchParams(window.location.search).get("v");!I||"chess960"!==I&&"960"!==I||(I="chess960");let R=I??"standard",$="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",B=null,x=$.split(" "),A=x[0],T=!x[1]||"w"===x[1],M="e1",F="e8",N=[],P=[],H=[],O=null,j=null,_=null,U=!0,W=[],D=null,V=[],z="black",K=!1;const Q=25;let G=localStorage.getItem("search-time")??1;isNaN(G)?G=1:+G>9?G=9:+G<-1&&(G=-1),localStorage.setItem("search-time",G);let J=null,X=null,Y=[],Z=[],ee=!1,te=-1,ne=!1,oe=null,re=["g1","g8","c1","c8"];const ie="hl-hov-square",ce="hl-previous-move",le="hl-square",se="hl-legal-squares",ae="hl-capture";let de=!1,ue=!1;r(l,i,(e=>{G=e})),"chess960"===R&&Mt(),ye(),we(),ke(),ve(),H.push(wt()),document.getElementById("btnAutoFlip").addEventListener("click",(e=>{de=!de,de?e.target.classList.add("glow"):e.target.classList.remove("glow")}));const me=document.getElementById("btnReset");let pe,he=!1;function fe(){he=!1,clearTimeout(pe),me.innerText="Reset",me.style.removeProperty("color"),me.style.removeProperty("opacity")}function ge(){document.querySelector(".board").removeEventListener("pointerleave",Re);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].removeEventListener("pointermove",Ee),e[t].removeEventListener("pointerout",be),e[t].removeEventListener("pointerup",Se)}function ye(){const e=document.getElementsByClassName("square");for(let t=ue?63:0;ue?t>=0:t<e.length;ue?t--:t++){const n=ue?1+Math.floor(t/8):8-Math.floor(t/8),o=ue?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8);e[t].id=o+n}}function ve(){const e=document.getElementsByClassName("square"),t=e=>e.remove();document.querySelectorAll(".file").forEach(t),document.querySelectorAll(".rank").forEach(t);for(let t=ue?63:0;ue?t>=0:t<e.length;ue?t--:t++){const n=ue?1+Math.floor(t/8):8-Math.floor(t/8),o=ue?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),r=e[t];if(t>=56&&t<=64){const e=document.createElement("div");e.classList.add("file"),r.prepend(e),e.textContent=o}if((t+1)%8==1){const e=document.createElement("div");e.classList.add("rank"),r.prepend(e),e.textContent=n}}}function we(){P=[],W=[],H=[],N=[],O=null,D=null,z="black",V=[],Y=[],ee=!1,Z=[],ne=!1,j=null,_=null,U=!0,M="e1",F="e8","standard"===R&&(re=["g1","g8","c1","c8"])}function ke(){const t=document.getElementsByClassName("square"),n=function(e){return e.replace(/\d/g,(e=>"1".repeat(+e)))}(A).split("/");for(let e=ue?63:0;ue?e>=0:e<t.length;ue?e--:e++){const o=ue?1+Math.floor(e/8):8-Math.floor(e/8),r=ue?String.fromCharCode(104-e%8):String.fromCharCode(97+e%8),i=97-r.charCodeAt(0),c=t[e];c.id=r+o;let s="",a="",d="";const u=n[8-o].charAt(-i);if(isNaN(+u)?(s=m(u)?"white":"black",a=y[u.toLowerCase()],d=P.length===t.length?Fe(c.id).pieceId:g(),"king"===a&&("white"===s&&(M=c.id),"black"===s&&(F=c.id))):(s=null,a=null,d=null),P.length<t.length&&P.push({squareId:c.id,color:s,pieceType:a,pieceId:d}),c.querySelectorAll(".piece").forEach((e=>{e.remove()})),d){const e=document.createElement("div");e.id=d,e.dataset.color=s,e.classList.add("piece"),e.classList.add(a),e.addEventListener("pointerdown",Ce),e.addEventListener("pointermove",Le);const t=document.createElement("img");t.src=l[u],t.alt=u,t.setAttribute("draggable",!1),e.appendChild(t),c.appendChild(e)}}const o=wt(),r=document.querySelector(".fen");r&&(r.textContent=o),W.length||e("gameStart")}function Ee(e){if(!U||!j)return;Ie(e),e.preventDefault();const t=e.target;2===t.id.length?t.classList.add(ie):t.parentElement.classList.add(ie)}function be(e){U&&(e.preventDefault(),e.target.classList.remove(ie))}function Se(e){e.preventDefault(),ge();const t=e.currentTarget.id;if(j&&O===t&&N.length)return _=j,j.classList.remove("dragging"),document.getElementById(O).appendChild(j),function(e){const t=document.getElementById(e);t.querySelectorAll(`.${le}`).forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add(le),t.append(n)}(O),void(j=null);Te();j&&(j.classList.remove("dragging"),j=null,_=null,Ae(),$e(O,t))}function qe(e){if(e.preventDefault(),!sn())return;if(2===e.button)return;if(!_)return;document.querySelectorAll(`.${le}`).forEach((e=>e.remove()));const t=e.currentTarget.id;O!==t&&(document.querySelectorAll(".square").forEach((e=>{e.removeEventListener("pointerdown",qe)})),ge(),Te(),Ae(),_=null,N.includes(t)&&($e(O,t),Be(O,t)))}function Ce(e){if(!U||ee)return;if(2===e.button)return;if(!sn())return;let t=e.target;ye(),function(){document.querySelector(".board").addEventListener("pointerleave",Re);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].addEventListener("pointermove",Ee),e[t].addEventListener("pointerout",be),e[t].addEventListener("pointerup",Se),e[t].addEventListener("pointerdown",qe)}();let n=t.parentElement.id,o=Fe(n),r=o.color,i=o.pieceType;if(_){const e=_.parentElement.id,{color:c,pieceType:l}=Fe(e);let s=!1;if("chess960"!==R||"king"!==l||"rook"!==i||r!==c||ht(r,n)||(s=!0,N.includes(n)||N.push(n),t=_,_=null,n=t.parentElement.id,o=Fe(n),r=o.color,i=o.pieceType,document.querySelectorAll(`.${le}`).forEach((e=>e.remove()))),r!==c&&_.id!==t.id&&!s)return}O=n;if(T&&"white"===r||!T&&"black"===r){if(Ae(),Te(),j=t,Ie(e),N=[...He(n)],N=at(N,n,r,i),N=[...new Set(N)],"king"===i){const e=ot(n,r),t="white"===r?1:8,o="white"===r?M:F,i=ut(r),c=mt(r);let l=!1,s=!1;if(i){let e=["f"];"chess960"===R&&(e=p(o,"g")),e.forEach((e=>{l||(l=ot(`${e}${t}`,r))})),l||"chess960"!==R||("f"!==o.charAt(0)&&(N=N.filter((e=>e!==`g${t}`))),N.push(B?.kingRookFile+t))}if(c){let e=["d"];"chess960"===R&&(e=p("c",o)),"b"===o.charAt(0)&&e.push("b"),e.forEach((e=>{s||(s=ot(`${e}${t}`,r))})),s||"chess960"!==R||(["b","d"].includes(o.charAt(0))||(N=N.filter((e=>e!==`c${t}`))),N.push(B?.queenRookFile+t))}e&&(i||c)?N=N.filter((e=>!re.includes(e))):(l&&(N=N.filter((e=>e!==`g${t}`))),s&&(N=N.filter((e=>e!==`c${t}`))))}N.forEach((e=>{const{color:t}=Fe(e);let n=t&&t!==r;"king"===i&&re.includes(e)&&!pt(r)&&(n=!0,"chess960"===R&&ht(t,e)&&(n=!1)),function(e,t=!1){const n=document.getElementById(e);if(n.querySelector(`.${se}`))return;const o=document.createElement("div");o.classList.add(se),n.appendChild(o),t&&o.classList.add(ae)}(e,n)}))}}function Le(e){if(j){const e=j;e.classList.add("dragging"),document.body.append(e)}}function Ie(e){if(!j)return;const t=document.querySelector(".square"),n=j;let o=t.getBoundingClientRect().width,r=t.getBoundingClientRect().height;n.style.width=`${o}px`,n.style.height=`${r}px`;o=e.clientX-o/2,r=e.clientY-r/2,n.style.left=`${o}px`,n.style.top=`${r}px`}function Re(e){ge(),document.getElementById(O).append(j),j.classList.remove("dragging"),j=null,document.querySelectorAll(`.${se}`).forEach((e=>e.remove())),document.querySelectorAll(`.${ie}`).forEach((e=>e.classList.remove(ie)))}function $e(t,n,o=!1){ee&&Yt();let r=null;o&&3===n.length&&(r=n.slice(2,3),n=n.slice(0,2));const i=t,c=n,s=document.getElementById(c),{pieceId:a,pieceType:d,color:u}=Fe(i),{color:m,pieceType:p,pieceId:h}=Fe(c),f=document.getElementById(a);o&&N.push(n);const g=i===c,v=!N.includes(c);if(g||v)return document.getElementById(i).appendChild(f),N=[],void(i!==c&&e("illegal"));let w,E=null;if("king"===d){let e=!1;if("chess960"!==R||c.charAt(0)!==B?.queenRookFile&&c.charAt(0)!==B?.kingRookFile||(e=!0),ot(c,u)&&!e)return;if(re.includes(c)&&!pt(u)){const e=()=>{ft(u,c),w=!0};"chess960"===R?(E=Fe(i)?.pieceId,m===u&&"rook"===p&&(ht(m,c)||e())):e()}"white"===u?M=c:F=c}let b=!1;if(m)if(w&&"chess960"===R);else{if(m===u)return;{b=!0;const e=s.querySelector(".piece");e.classList.add("fade-out"),e.removeEventListener("pointerdown",Ce),e.removeEventListener("pointermove",Le),setTimeout((()=>{e.remove()}),250)}}if(D===c&&(!function(e){if(!D)return;const t="white"===e?-1:1,n=+D[1]+t,o=Fe(`${D[0]}${n}`);let r=document.getElementById(o.squareId).querySelector(".piece");r&&(r.remove(),r.removeEventListener("pointerdown",Ce),r.removeEventListener("pointermove",Le));r=document.getElementById(o.pieceId),r&&(r.remove(),r.removeEventListener("pointerdown",Ce),r.removeEventListener("pointermove",Le));o.color=null,o.pieceId=null,o.pieceType=null}(u),b=!0),!f)throw new Error(`[CHESS_ERROR] Unable to move piece with id (${a}) positioned at squareId: ${i}`);let S,q=null;if("chess960"===R&&w){const[e,t]=c.split("");if(e===B?.kingRookFile.charAt(0)?q=document.getElementById(`g${t}`):e===B?.queenRookFile.charAt(0)&&(q=document.getElementById(`c${t}`)),!q)throw new Error("[CHESS_ERROR] Unable to find castling square for Chess960");q.append(f),Ne(P,i,q.id),o||Be(i,q.id)}else s.appendChild(f);if(o&&Be(i,c),w&&"chess960"===R){const e=P.find((e=>e.squareId===q.id));e.color=u,e.pieceId=E,e.pieceType="king";const t="g"===q.id.charAt(0)?"f":"d",n="white"===u?1:8,o=P.find((e=>e.squareId===t+n));o.color=u,o.pieceId=h,o.pieceType="rook","white"===u?M=q.id:F=q.id}else Ne(P,i,c);if(N=[],D=null,"pawn"===d){const e="white"===u?2:7,t="white"===u?2:-2,n="white"===u?3:6;+i[1]===e&&+c[1]===e+t&&(D=`${c[0]}${n}`)}if("pawn"===d){const e="white"===u&&8==+c[1],t="black"===u&&1==+c[1];(e||t)&&(S="pending")}let C=c;if(w&&"chess960"===R&&(C=q.id),W.push({from:i,to:C,color:u,pieceType:d,hasCapture:b,castle:w,promotion:S}),Z.push(t+n),Tt(),e(w?"castle":b?"capture":"move"),Me(i,C),S)return o?(Z[Z.length-1]+=r,gt(r),void setTimeout((()=>{yt(u,y[r],c),vt(o)}),250)):(U=!1,void function(e){if(e.length>2)throw new Error("[CHESS_ERROR] Invalid square id. Unable to promote.");const{color:t}=Fe(e),n="white"===t?8:1;if(8!==n&&1!==n)return!1;if("white"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote white with squareId: ${e}`);if("black"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote black with squareId: ${e}`);const o=document.createElement("div"),r=document.createElement("div");o.classList.add("promotion-container"),r.classList.add("promotion-content"),o.append(r);let i=["Q","R","B","N"];"black"===t&&(i=i.map((e=>e.toLowerCase())));const c=document.getElementById(e);if(!c)throw new Error("[CHESS_ERROR] Board square was not found");const s=.95*c.getBoundingClientRect().height;i.forEach(((n,i)=>{const c=document.createElement("div"),a=document.createElement("img");a.src=l[n],a.alt=n,a.height=s,a.width=s,c.addEventListener("click",(()=>{if(yt(t,y[n.toLowerCase()],e),o.remove(),gt(n),Z[Z.length-1]+=n.toLowerCase(),U=!0,k){const{from:e,to:t}=W[W.length-1];cn(e,t)}vt()})),c.classList.add("promotion-square"),c.append(a),r.append(c),1===i&&r.append(document.createElement("br"))}));const a=document.querySelector(".board");if(!a)throw new Error("[CHESS_ERROR] Board was not found");a.append(o)}(c));k&&sn()&&!o&&!S&&cn(i,c),vt(o)}function Be(e,t){const n=document.getElementById(t),o=document.getElementById(e);if(!n||!o)return;const r=n.querySelector(".piece:not(.fade-out)");if(!r)return;let i=o.getBoundingClientRect().top,c=o.getBoundingClientRect().left;const l=o.getBoundingClientRect().width,s=n.getBoundingClientRect().top,a=n.getBoundingClientRect().left,d=r.style.transition,u=r.style.position,m=r.style.zIndex;r.style.position="fixed",r.style.zIndex="1000",r.style.top=i+"px",r.style.left=c+"px",r.style.height=l+"px",r.style.width=l+"px";let p=a-c,h=s-i;r.style.transition="transform 250ms ease-in-out",r.style.transform=`translate(${p}px, ${h}px)`,setTimeout((()=>{r.style.transition=d,r.style.transform="translate(0,0)",r.style.position=u,r.style.zIndex=m,r.style.top="auto",r.style.left="auto"}),250)}function xe(){document.querySelectorAll(`.${ce}`).forEach((e=>{e.remove()}))}function Ae(){const e=document.getElementsByClassName(se);for(;e.length>0;)e[0].remove()}function Te(){document.querySelectorAll(`.${ie}`).forEach((e=>e.classList.remove(ie)))}function Me(e,t){xe();const n=document.getElementById(e),o=document.getElementById(t),r=document.createElement("div"),i=document.createElement("div");r.classList.add(ce),i.classList.add(ce),n.appendChild(r),o.appendChild(i)}function Fe(e,t=P){const n=t.find((t=>t.squareId===e));if(!n)throw new Error(`[CHESS_ERROR] Square with squareId "${e}" was not found`);return n}function Ne(e,t,n){const o=e.findIndex((e=>e.squareId===t)),r=e.findIndex((e=>e.squareId===n)),i=e[o];e[r]={...i,squareId:n},i.color=null,i.pieceId=null,i.pieceType=null}function Pe(e){return[e.charAt(0),+e.charAt(1)]}function He(e,t=P){const{pieceId:n,color:o,pieceType:r}=Fe(e,t);if(!n)throw new Error(`[CHESS_ERROR] No piece identified at squareId: ${e}`);switch(r){case"pawn":return function(e,t,n=P){return[...je(e,t,n),..._e(e,t,n)]}(e,o,t);case"knight":return Ue(e,o,t);case"rook":return We(e,o,t);case"bishop":return De(e,o,t);case"queen":return Ve(e,o,t);case"king":return ze(e,o,t);default:throw new Error("[CHESS_ERROR] Unknown piece type")}}function Oe(e,t){return e.filter((e=>e.color===t)).flatMap((({squareId:t,color:n,pieceType:o})=>at(He(t,f(e)),t,n,o)))}function je(e,t,n=P){const[o,r]=Pe(e),i=[];let c=o,l=r,s=e;if(l+="white"===t?1:-1,l>8||l<1)return i;const a=[-1,1];for(const e of a)if(c=String.fromCharCode(o.toLowerCase().charCodeAt(0)+e),c>="a"&&c<="h"){s=`${c}${l}`;const{color:e}=Fe(s,n);e&&e!==t&&i.push(s),e||s!==D||i.push(s)}return i}function _e(e,t,n=P){const[o,r]=Pe(e),i=[];let c=o,l=r;l+="white"===t?1:-1;let s=`${c}${l}`,a=Fe(s,n);return a.pieceId?i:(i.push(s),"white"===t&&2===r&&l++,"black"===t&&7===r&&l--,s=`${c}${l}`,a=Fe(s,n),a.pieceId||i.push(s),i)}function Ue(e,t,n=P){return[...nt(e,t,[[-1,2],[1,2],[-2,1],[2,1],[-2,-1],[2,-1],[-1,-2],[1,-2]],n)]}function We(e,t,n=P){const o=Pe(e);return[...Qe(o,t,n),...Ge(o,t,n),...Je(o,t,n),...Xe(o,t,n)]}function De(e,t,n=P){const o=Pe(e);return[...Ye(o,t,n),...Ze(o,t,n),...et(o,t,n),...tt(o,t,n)]}function Ve(e,t,n=P){const o=Pe(e);return[...Qe(o,t,n),...Ge(o,t,n),...Je(o,t,n),...Xe(o,t,n),...Ye(o,t,n),...Ze(o,t,n),...et(o,t,n),...tt(o,t,n)]}function ze(e,t,n=P){const o="white"===t?1:8,r=[];return ut(t,n)&&r.push(`g${o}`),mt(t,n)&&r.push(`c${o}`),[...nt(e,t,[[-1,1],[0,1],[1,1],[-1,-1],[0,-1],[1,-1],[-1,0],[1,0]],n),...r]}function Ke({file:e,rank:t,color:n,legalSquares:o},r=P){const i=e+t,{color:c}=Fe(i,r);return(!c||c!==n)&&(o.push(i),!c||c===n)}function Qe(e,t,n=P){const o=e[0];let r=e[1];const i=[];for(;r<8;){r++;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ge(e,t,n=P){const o=e[0];let r=e[1];const i=[];for(;r>1;){r--;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Je(e,t,n=P){let o=e[0];const r=e[1],i=[];for(;o<"h";){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e);if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Xe(e,t,n=P){let o=e[0];const r=e[1],i=[];for(;o>"a";){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e);if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ye(e,t,n=P){let[o,r]=e;const i=[];for(;o<"h"&&r<8;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r++;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ze(e,t,n=P){let[o,r]=e;const i=[];for(;o>"a"&&r>1;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r--;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function et(e,t,n=P){let[o,r]=e;const i=[];for(;o>"a"&&r<8;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r++;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function tt(e,t,n=P){let[o,r]=e;const i=[];for(;o<"h"&&r>1;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r--;if(!Ke({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function nt(e,t,n,o=P){const[r,i]=Pe(e),c=[];let l=r,s=i;return n.forEach((([e,n])=>{l=String.fromCharCode(r.charCodeAt(0)+e),s=i+n;if(l<"a"||l>"h"||s>8||s<1)return;const a=l+s,{color:d}=Fe(a,o);t!==d&&c.push(a)})),c}function ot(e,t,n=P){for(const o of We(e,t,n)){const{pieceType:e,color:r}=Fe(o,n);switch(e){case"rook":case"queen":if(t!==r)return!0}}for(const o of De(e,t,n)){const{pieceType:e,color:r}=Fe(o,n);switch(e){case"bishop":case"queen":if(t!==r)return!0}}for(const o of Ue(e,t,n)){const{pieceType:e,color:r}=Fe(o,n);if("knight"===e)if(t!==r)return!0}for(const o of ze(e,t,n)){const{pieceType:e,color:r}=Fe(o,n);if("king"===e)if(t!==r)return!0}for(const o of je(e,t,n)){const{pieceType:e,color:r}=Fe(o,n);if("pawn"===e)if(t!==r)return!0}return!1}function rt(){const t=T?M:F,n=T?F:M,o=T?"white":"black",r=f(P),i=ot(t,o,r);if(!i)return!1;const c=Oe(r,o),l=ut(o)||mt(o),s=c.every((e=>re.includes(e))),a=i&&l&&c.length>0&&s;if(c.length>0&&!a)return!1;if(ct(),st(t,!0),it(t),it(n,"💎"),U=!1,k&&E){const e=T?E.black.rid:E.white.rid;tn(v,{type:"c.play.checkmate",data:e}),E.status="finished",mn()}return Ft(),e("gameEnd"),!0}function it(e,t="💢"){const{color:n}=Fe(e),o=document.getElementById(e);if("💢"===t&&c.includes("pink")&&(t="❤️"),!e)throw new Error(`[CHESS_ERROR] Unable to insert checkmate emblem in squareId: ${e}`);const r=document.createElement("div"),i=document.createElement("div"),l=.45*o.getBoundingClientRect().height;r.classList.add("checkmate-container"),i.textContent=t,i.classList.add("checkmate"),i.classList.add(n),i.style.height=l+"%",i.style.width=l+"%",r.append(i),o.append(r)}function ct(e=null){const t=document.getElementById(e);if(e&&t){const e=t.querySelector(".checkmate-container");if(!e)return;e.remove()}else document.querySelectorAll(".checkmate-container").forEach((e=>{e.remove()}));document.querySelectorAll(".bloody-check").forEach((e=>e.remove()))}function lt(e,t){const n=["😱","😨","🥵","😡","😤"].filter((e=>e!==oe)),o=Math.floor(Math.random()*n.length),r=t??n[o];ct(e),it(e,r),oe=r}function st(e,t=!1){const n=document.getElementById(e);if(n)if(n.querySelectorAll(".bloody-check").forEach((e=>e.remove())),t){const e=n.querySelector(".piece");e&&e.classList.add("bloody-checkmate")}else{const e=document.createElement("div");n.prepend(e),e.classList.add("bloody-check")}}function at(e,t,n,o){const r=T?M:F,i=f(P);let c=[...e];return c=[...new Set(c)],c.forEach((c=>{const l=f(i);Ne(l,t,c),"king"!==o&&ot(r,n,l)&&(e=e.filter((e=>e!==c))),"king"===o&&ot(c,n,l)&&(e=e.filter((e=>e!==c)))})),e}function dt({e:e,fileTrack:t,rank:n,castleType:o}){let r=e.squareId===t+n&&e.pieceId&&"king"!==e.pieceType;return r&&"rook"===e.pieceType&&"chess960"===R?"short"===o&&e.squareId!==B?.kingRookFile+n||"long"===o&&e.squareId!==B?.queenRookFile+n:r}function ut(e,t=P){const n="white"===e?1:8,o="white"===e?M:F;let r=p("f","g"),i="h";"chess960"===R&&(i=B?.kingRookFile,r=p(o.charAt(0),"g"),r.includes("f")||r.push("f"));return!(r.map((e=>t.find((t=>dt({e:t,fileTrack:e,rank:n,castleType:"short"}))))).some((e=>!!e))||pt(e)||ht(e,`${i}${n}`,t))}function mt(e,t=P){const n="white"===e?1:8,o="white"===e?M:F;let r=p("b","d"),i="a";"chess960"===R&&(i=B?.queenRookFile,r=p("c",o.charAt(0)),r.includes("d")||r.push("d"),"a"===i&&r.push("b"));return!(r.map((e=>t.find((t=>dt({e:t,fileTrack:e,rank:n,castleType:"long"}))))).some((e=>!!e))||pt(e)||ht(e,`${i}${n}`,t))}function pt(e){return!!W.find((t=>t.color===e&&"king"===t.pieceType))}function ht(e,t,n=P){const o=n.find((n=>n.squareId===t&&n.color===e&&"rook"===n.pieceType)),r=W.find((n=>n.color===e&&n.from===t&&"rook"===n.pieceType));return!o||r}function ft(e,t){const n="white"===e?1:8;let o=null,r=null,i="g",c="c";if("chess960"===R&&(i=B?.kingRookFile,c=B?.queenRookFile),t===`${i}${n}`){let e="h";"chess960"===R&&(e=B?.kingRookFile),o=`${e}${n}`,r=`f${n}`}if(t===`${c}${n}`){let e="a";"chess960"===R&&(e=B?.queenRookFile),o=`${e}${n}`,r=`d${n}`}const{pieceId:l}=Fe(o),s=document.getElementById(l),a=document.getElementById(r);s&&a&&a.append(s),Ne(P,o,r),Be(o,r)}function gt(t){const n=W.find((e=>"pending"===e.promotion));if(!n)throw new Error("[CHESS_ERROR] Unable to find promotion move state");n.promotion=t.toUpperCase(),Tt(),e("promote")}function yt(e,t,n){const o=document.getElementById(n);if(!o)throw new Error(`[CHESS_ERROR] Unable to create piece at ${n}`);const r=o.querySelector(".piece");r&&(r.removeEventListener("pointerdown",Ce),r.removeEventListener("pointermove",Le),r.remove());const i=g(),c=document.createElement("div");c.classList.add("piece"),c.classList.add(t.toLowerCase()),c.dataset.color=e,c.id=i,c.addEventListener("pointerdown",Ce),c.addEventListener("pointermove",Le);let s=t[0].toLowerCase();"knight"===t&&(s="n");const a=document.createElement("img");a.alt=s,s="white"===e?s.toUpperCase():s.toLowerCase(),a.src=l[s],c.append(a),o.append(c);const d=Fe(n);d.pieceId=i,d.pieceType=t,d.color=e}function vt(t=!1){!function(e=500){setTimeout((()=>{de&&Et()}),e)}(),ct(),o("analysis"),St(),T=!T,Y.push(function({color:t,castle:n,from:o,to:r,pieceType:i,hasCapture:c,promotion:l},s){const a=r[0];let d="";n&&("g"===a&&(d="O-O"),"c"===a&&(d="O-O-O"));const u=()=>{if("king"===i)return;const e=P.filter((e=>e.color===t&&e.pieceType===i&&e.squareId!==o));for(let n=0;n<e.length;n++){const c=e[n].squareId;let l=[];const s="white"===t?"black":"white";if("knight"===i?l=Ue(c,s):"bishop"===i?l=De(c,s):"rook"===i?l=We(c,s):"queen"===i&&(l=Ve(c,s)),l.includes(r)){const e=o.charAt(0)===c.charAt(0);d+=e?o.charAt(1):o.charAt(0);break}}};if("pawn"===i)d+="";else{let e=i.charAt(0).toUpperCase();"knight"===i&&(e="N"),n||(d+=e),u()}c&&("pawn"===i&&(d+=o.charAt(0)),d+="x");n||(d+=r);l&&(d+="="+l);const m="white"===t?"black":"white";let p="white"===m?M:F;rt()?s>=0&&s===W.length-1&&(d+="#"):ot(p,m)&&(d+="+",s===W.length-1&&(e("check"),lt(p),st(p)));return Rt(s,d,t),d}(W[W.length-1],W.length-1));const n="white"===z&&T,r="black"===z&&!T,i=wt();H.push(i),x=i.split(" "),A=x[0],k&&!t&&tn(v,{type:"c.state.fenpgn",data:[i,Y[Y.length-1]]});const c=document.querySelector(".fen");c&&(c.textContent=i);let l=!1,s=!1,a=!1,d=!1;(function(){const e=e=>e.split(" ").slice(0,4).join(" ");return H.some((t=>{const n=e(t);return H.filter((t=>e(t)===n)).length>=3}))})()&&(it(M,"🤝"),it(F,"🤝"),a=!0),function(e=H[H.length-1]){const t=e.split(" ")[0],n=t.split("").filter((e=>"B"===e)).length,o=t.split("").filter((e=>"b"===e)).length,r=t.split("").filter((e=>"N"===e)).length,i=t.split("").filter((e=>"n"===e)).length,c=t.split("").filter((e=>"Q"===e)).length,l=t.split("").filter((e=>"q"===e)).length,s=t.split("").filter((e=>"R"===e)).length,a=t.split("").filter((e=>"r"===e)).length,d=t.split("").filter((e=>"P"===e)).length,u=t.split("").filter((e=>"p"===e)).length;if(c+l+s+a+d+u>0)return!1;if(r+i>1)return!1;if(n+o>1)return!1;if((n>0||o>0)&&r+i>0)return!1;return!0}()&&(ct(),it(M,"🤝"),it(F,"🤝"),U=!1,l=!0,d=!0);const u=rt(),m=function(){const e=T?M:F,t=T?F:M,n=T?"white":"black",o=f(P);return!ot(e,n,o)&&!(Oe(o,n).length>0||(ct(),it(e,"❓"),it(t,"😨"),U=!1,0))}();l||!u&&!m||(s=!0,m&&(d=!0)),!s&&kt()>=100&&(it(M,"🥵"),it(F,"🥵"),d=!0),s||qt(K&&(n||r)),a&&k?(ne=!0,Bt.style.display="block"):(ne=!1,Bt.style.display="none"),d&&dn()}function wt(e=P){let t="",n=8,o=0;const r=()=>{t=t.replace(/\*+/g,o),o=0};for(;n>=1;){for(let c="a";c<="h";i=c,c=String.fromCharCode(i.charCodeAt(0)+1)){const i=c+n,l=e.find((e=>e.squareId===i));if(!l)throw new Error(`[CHESS_ERROR] Unable to generate FEN due to missing squareId: ${i}`);const{color:s,pieceType:a}=l;if(a){let e="knight"===a?"n":a.charAt(0).toLowerCase();r(),t+="white"===s?e.toUpperCase():e}else t+="*",o++}r(),n>1&&(t+="/"),n--}var i;t+=T?" w ":" b ";let c="",l="h",s="a";"chess960"===R&&(l=B?.kingRookFile,s=B?.queenRookFile),pt("white")||ht("white",`${l}1`)||(c+="K"),pt("white")||ht("white",`${s}1`)||(c+="Q"),pt("black")||ht("black",`${l}8`)||(c+="k"),pt("black")||ht("black",`${s}8`)||(c+="q"),c||(c="-"),t+=c+" ",t+=(D||"-")+" ";const a=kt();t+=a+" ";const d=Math.floor(W.length/2)+1;return t+=d,t}function kt(){let e=0;for(let t=0;t<W.length;t++)e++,(W[t].hasCapture||"pawn"===W[t].pieceType||W[t].promotion)&&(e=0);return e}function Et(e){const t=document.querySelector(".eval.vertical");if(ue=!ue,void 0!==e&&(ue=e),ue?t?.classList.add("flip"):t?.classList.remove("flip"),ye(),ke(),ve(),W.length){const{from:e,to:t}=W[W.length-1];Me(e,t)}if(ct(),Te(),Ae(),_=null,Y.length){Y[Y.length-1].includes("+")&&(T?(lt(M,oe),st(M)):(lt(F,oe),st(F)))}Jt(te)}function bt(e){return{engine:new Worker("./js/engine.js"),scoreRgx:/score cp (-?\d+)/,mateRgx:/score mate (-?\d+)/,pvRgx:/ pv (.+)$/,timeRgx:/time (\d+)/,turn:e.split(" ")[1]}}function St(){X&&(X.terminate(),X=null)}function qt(e,t=H[H.length-1]){if(k)return;if(e&&(U=!1),t=t||$,e&&V.length){const{from:e,to:t}=W[W.length-1],{from:n,to:o}=V.splice(0,1)[0];if(n===e&&o===t){const e=V.splice(0,1)[0];if(e)return void setTimeout((()=>{$e(e.from,e.to,!0),U=!0}),500)}}const n=document.getElementById("thinking");e&&n&&(n.style.display="inline-block",document.getElementById("btnVsBot").style.display="none"),function(e,t){const{engine:n,mateRgx:o,pvRgx:r,scoreRgx:i,timeRgx:c,turn:l}=bt(e);J&&J.terminate(),J=n;let s=1e3*(parseInt(G)+1);n.onmessage=e=>{const t=e.data,d={success:!1,mate:null,evaluation:null,continuation:""};if(t.includes("info depth")&&t.includes(" pv ")){if(t.includes(`info depth ${Q}`)&&(n.terminate(),J=null),i.test(t)){const e=i.exec(t)[1];d.evaluation=parseInt(e)/100}if(o.test(t)&&(d.mate=o.exec(t)[1],d.evaluation=null),r.test(t)&&(d.continuation=r.exec(t)[1]),"b"===l&&(d.evaluation&&(d.evaluation*=-1),d.mate&&(d.mate*=-1)),(d.mate||d.evaluation||d.continuation)&&(d.success=!0,It(d.evaluation,d.mate)),t.includes(`info depth ${Q}`)&&a(d),G>=0&&c.test(t)){const e=c.exec(t)[1],n=s;parseInt(e)>=n&&a(d)}}};const a=e=>{t(e),!k&&K&&document.getElementById("btnVsBot")?.style.removeProperty("display")};n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),"chess960"===R&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`);let d=`go depth ${Q}`;G>-1&&(d+=` movetime ${s}`),n.postMessage(d)}(t,(t=>{Ct(t,e)}))}function Ct(e,t){if(!e.success)throw new Error("SF failed");if(It(e.evaluation,e.mate),!t)return;var n;U=!0,thinking&&(thinking.style.display="none"),n=e.continuation,e.mate,V=n.split(" ").map((e=>({from:e.slice(0,2),to:e.slice(2,5)})));const o=V.splice(0,1);if(!o.length)throw new Error("[SF_ERROR] No more moves found");const{from:r,to:i}=o[0];$e(r,i,!0)}me.addEventListener("click",(e=>{if(!k){if(!he)return me.innerText="Confirm?",me.style.color="skyblue",me.style.opacity="1",he=!0,void(pe=setTimeout((()=>{fe()}),3e3));fe(),ee&&Yt(),document.querySelectorAll(".piece").forEach((e=>e.remove())),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),we(),"standard"===R?(T=!0,x=$.split(" "),A=x[0],ke()):"chess960"===R&&Mt(),K&&document.getElementById("btnVsBot").style.removeProperty("display"),H.push(wt()),xe(),Te(),Ae(),ct(),o("analysis"),K=!1,document.getElementById("thinking").style.display="none",document.getElementById("btnVsBot")?.classList.remove("glow"),J&&(J.terminate(),J=null),St(),qt(),document.getElementById("opening-name").textContent="",ue&&de&&Et(!1)}})),document.getElementById("btnFlip").addEventListener("click",(()=>{Et()})),document.getElementById("btnVsBot").addEventListener("click",(e=>{k||U&&(K=!K,ee&&Yt(),K?(V=[],e.currentTarget.classList.add("glow"),z=T?"white":"black",U=!1,qt(!0),_&&(_=null,Te(),Ae())):e.currentTarget.classList.remove("glow"))})),document.getElementById("btnUndo").addEventListener("click",(t=>{if(k||!W.length)return;ee&&Yt();let n=W.length,r=H.length,i=Z.length,c=Y.length;const l=W[n-1],{from:s,to:a,promotion:d}=l;if("pending"===d)return void e("illegal");U=!0,_&&(Te(),Ae(),_=null),K&&(J&&J.terminate(),document.getElementById("thinking").style.display="none",k||document.getElementById("btnVsBot").style.removeProperty("display")),xe(),ct(),o("analysis"),St(),r--,H.splice(r,1);const u=H[r-1];x=u.split(" "),A=x[0],D=x[3],T=!x[1]||"w"===x[1],P=[],ke(),Be(a,s),n--,W.splice(n,1);const m=c;c--,Y.splice(c,1);const p=Math.floor(c/2)+1,h=document.querySelector(`.pgn-row:nth-child(${p})`);if(m%2==0?h.querySelector(".pgn-col:nth-child(3)").textContent="":h.remove(),Y[c-1]?.includes("+")&&st(T?M:F),i--,Z.splice(i,1),Tt(),qt(),W.length){const e=W[n-1];Me(e.to,e.from)}de&&setTimeout(Et,300),e("lichess_move")}));const Lt=document.getElementById("btnRematch");function It(e,t){null===e&&null!==t&&(e=t>0?Q:-1*Q);let n=50-e/Q*100;n=Math.min(n,98),n=Math.max(n,2);const o=document.querySelector(".eval.vertical .bar"),r=document.querySelector(".eval.vertical .num"),i=document.querySelector(".eval.horizontal .bar"),c=document.querySelector(".eval.horizontal .num");if(o&&(o.style.height=n+"%"),i&&(i.style.width=n+"%"),r){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),r.textContent=n,e>0?r.classList.add("w"):r.classList.remove("w")}if(c){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),c.textContent=n,e>0?c.classList.add("w"):c.classList.remove("w")}}function Rt(e,t,n){const o=document.querySelector(".pgn");if(o){let r=Math.floor(e/2)+1;"black"===n&&e%2==0&&(r=Math.max(r-1,1));let i=null,c=null,l=null,s=document.createElement("button");if(document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),"white"===n){i=document.createElement("div"),c=document.createElement("div"),l=document.createElement("span"),l.textContent=r+".",i.append(l),i.append(c);const e=document.createElement("div");e.classList.add("pgn-col"),i.append(e)}else c=document.querySelector(`.pgn-row:nth-child(${r}) .pgn-col:last-child`);s.textContent=t,s.onclick=()=>{Xt(),te=e,Gt(e)},ee||(te=e),i&&(i.classList.add("pgn-row"),o.append(i)),c.classList.add("pgn-col"),s.classList.add("active"),c.append(s),s.scrollIntoView()}}Lt.addEventListener("click",(e=>{Lt.style.display="none",k&&E&&("finished"!==E.status&&"closed"!==E.status||tn(v,{type:"c.rematch.request"}))})),Lt.style.display="none",document.getElementById("btnCopyFenPGN").addEventListener("click",(()=>{let e=function(e=Y){let t=At();for(let n=0;n<e.length;n++){const o=Math.floor(n/2)+1;n%2==0&&(t+=o+". "),t+=e[n]+" "}return t}();navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard")}));const $t=document.getElementById("btnCopyFenPGNALL");$t.addEventListener("click",(()=>{let e="";k&&E.pgnArchive?.length&&(e=function(e){let t="";return e.forEach((e=>{const n=e.rawPgn,{round:o,white:r,black:i,result:c,termination:l,fen:s}=e;let a=At({round:o,white:r,black:i,result:c,termination:l,fen:s});for(let e=0;e<n.length;e++){const t=Math.floor(e/2)+1;e%2==0&&(a+=t+". "),a+=n[e]+" "}t+=a+"\n\n"})),t}(E.pgnArchive),navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard"))})),$t.style.display="none";const Bt=document.getElementById("btnDraw");Bt.addEventListener("click",(()=>{k&&"ongoing"===E?.status&&ne&&confirm("Are you sure want to offer draw?")&&function(){const e=nn();e&&[E.black.rid,E.white.rid].includes(e)&&tn(v,{type:"c.draw.offer",data:nn()})}()})),Bt.style.display="none";const xt=document.getElementById("btnResign");function At(e){const t=e?.event??"?",n=e?.site??window.location.hostname,o=e?.date??d(),r=e?.round??"?",i=e?.white??"?",c=e?.black??"?",l=e?.result??"?",s=e?.fen??$,a=e?.termination;let u=`[Event "${t}"]\n`;return u+=`[Site "${n}"]\n`,u+=`[Date "${o}"]\n`,u+=`[Round "${r}"]\n`,u+=`[White "${i}"]\n`,u+=`[Black "${c}"]\n`,u+=`[Result "${l}"]\n`,u+=`[FEN "${s}"]\n`,a&&(u+=`[Termination "${a}"]\n`),u+"\n"}function Tt(e=""){let t=!1,n="";if(e||(n=W.map((e=>{let n=e.from+e.to;return e.promotion&&("pending"!==e.promotion?n+=e.promotion:t=!0),n})).join(",")),t&&!e)return;const o=document.getElementById("opening-name");o&&"chess960"!==R&&(e||(e=n),fetch(`https://explorer.lichess.ovh/masters?play=${e}`).then((e=>e.json())).then((e=>{const t=e?.opening?.name;t?o.innerHTML=t.replace(": ",":<br />"):o.textContent=""})))}function Mt(e=""){R="chess960";const t=a(e);return $=t.fen,x=$.split(" "),A=x[0],T=!x[1]||"w"===x[1],M=t.whiteKingSquareId,F=t.blackKingSquareId,re=[`${t.kingRookFile}1`,`${t.kingRookFile}8`,`${t.queenRookFile}1`,`${t.queenRookFile}8`],B=t,ke(),t}function Ft(){c.includes("pink")?confettiHearts():confettis()}xt.addEventListener("click",(()=>{k&&"ongoing"===E?.status&&(E.moveState.length<q||confirm("Are you sure you want to resign?")&&(E.status="finished",xt.style.display="none",tn(v,{type:"c.resign"})))})),xt.style.display="none";const Nt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="6 3 20 12 6 21 6 3"/></svg>';let Pt=null;const Ht=500;let Ot=Ht;let jt=!1;const _t=document.querySelector(".actions.rewind"),Ut=document.getElementById("btnRewindPlay"),Wt=document.getElementById("btnRewindPrev"),Dt=document.getElementById("btnRewindNext"),Vt=document.getElementById("btnRewindStop"),zt=document.getElementById("btnRewindStart"),Kt=document.getElementById("btnRewindEnd");function Qt(){Ot=Math.max(75,Ot-50)}function Gt(t,n){if(void 0===t)return;ee=!0;const r=jt;W.length===t+1&&Xt();let i=H[t+1];if(-1===t&&(i=H[0]),A===i.split(" ")[0])return;if(o("analysis"),St(),t>=0){const e=[];for(let n=0;n<=t;n++)e.push(Z[n]);Tt(e.join(","))}if(-1===t){const{from:e,to:t}=W[0];Be(t,e)}ct(),Te(),xe(),Ae(),document.querySelectorAll(".hl-square").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),_t.style.display="flex";const c=document.querySelectorAll(".pgn-col button")[t];c?.classList.add("active");const l=c?.parentElement,s=l?.parentElement;s?.scrollIntoView({behavior:"smooth"}),s||document.querySelector(".pgn-row span")?.scrollIntoView({behavior:"smooth"}),j=null,_=null,P=[],A=i.split(" ")[0],ke();const a=W[t];if(/left/i.test(n)){const n=W[t+1];n&&(Be(n.to,n.from),n.castle?e("castle"):n.promotion?e("promote"):e("lichess_move"))}if(!a)return;const{from:d,to:u,color:m,castle:p,promotion:h,hasCapture:f}=a;!/right/i.test(n)&&n||(Be(d,u),e(p?"castle":h?"promote":f&&jt?"capture":f&&!jt?"lichess_capture":"move")),p&&"standard"===R&&ft(m,u);const g="white"===m?"black":"white",y=Y[t],v=y.includes("+"),w=y.includes("#");if(v||w){const t=P.find((e=>e.color===g&&"king"===e.pieceType)).squareId;if(v&&(lt(t),e("check")),w){const n=P.find((e=>e.color===m&&"king"===e.pieceType)).squareId;it(t),it(n,"💎"),r&&(Ft(),e("gameEnd"))}st(t,w)}Me(d,u);let b=!0;k&&(b=!1,"finished"===E.status&&(b=!0)),b&&!r&&Jt(t)}function Jt(e){if(e<=1)return;const r=W[e];if(!r)return;const{from:i,to:c}=r,l=(e,l,s,a="limegreen")=>{if(o("analysis"),e===i&&l===c)r.goodMoveFrom===i&&r.goodMoveTo===c?n({squareId:c}):n({squareId:c,emoji:"☑️"});else{a=r.goodMoveFrom===e&&r.goodMoveTo===l?"limegreen":a,t({origSquareId:i,destSquareId:c,color:"rgba(100, 100, 100, 0.5)"}),t({origSquareId:e,destSquareId:l,color:a})}s&&r.promotion!==s&&n({squareId:c,emoji:"❌"})},s=H[e],{goodMoveFrom:a,goodMoveTo:d,goodMovePromotion:u}=r;a&&d?l(a,d,u):function(e,t){const{engine:n,pvRgx:o,timeRgx:r}=bt(e);X&&X.terminate(),X=n;let i=0;const c=H.findIndex((t=>t===e));if(c<0)return X=null,void n.terminate();let l=null,s=null,a=null;n.onmessage=e=>{const d=e.data;if(o.test(d)){const e=o.exec(d)[1].split(" ")[0],u=W[c];if(e&&u){const n=e.slice(0,2),o=e.slice(2,4),r=e.slice(4,5);l===n&&s===o?i++:i=0,l=n,s=o,r&&(a=r.toUpperCase()),t(n,o,r)}let m=!1;if(r.test(d)){const e=r.exec(d)[1];parseInt(e)>=6e4&&(m=!0)}(i>=30||m)&&(X=null,n.terminate(),u.goodMoveFrom=l,u.goodMoveTo=s,a&&(u.goodMovePromotion=a),t(l,s,a))}},n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),"chess960"===R&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`),n.postMessage("go movetime 60000")}(s,((e,t,n)=>{l(e,t,n,"orange")}))}function Xt(){clearTimeout(Pt),jt=!1,Ut.innerHTML=Nt,ee=!1,Ot=Ht}function Yt(){ee=!1,te=W.length,j=null,_=null,Xt(),e("gameStart");const t=H.length-1;if(document.querySelectorAll(".pgn-col button.active").forEach((e=>e.classList.remove("active"))),document.querySelector(".pgn-row:last-child .pgn-col:last-child button:last-child")?.classList.add("active"),P=[],A=H[t].split(" ")[0],ke(),o("analysis"),St(),W.length){const{from:e,to:t}=W[W.length-1];Me(e,t)}Ot=Ht,clearTimeout(Pt),_t.style.display="none"}function Zt({direction:e,ev:t}){if(!W.length)return;let n=e||t.key;const o=e=>{switch(e){case"ArrowLeft":case"left":te=Math.max(-1,te-1);break;case"ArrowRight":case"right":te=Math.min(W.length-1,te+1)}if(te>=-1&&te<=W.length)return te};switch(n){case"ArrowLeft":case"left":case"ArrowRight":case"right":Gt(o(n),n)}}function en(){tn(v,{data:nn()??"anything",type:"c.connection.ping"})}function tn(e,t){e.send(JSON.stringify(t))}function nn(){return localStorage.getItem("rid")}function on(){tn(v,{type:"c.rid.register"})}function rn(e){o("analysis"),St();const{variant:t,boardState:n,moveState:r,fenState:i,rawPgn:c,white:l,black:s,status:a,scores:d,pgnArchive:m,time:p}=e;if(R=t,E=e,$=i[0],P=n,W=r,H=i,Y=c,"chess960"===R&&Mt($),x=i[i.length-1].split(" "),A=x[0],T=!x[1]||"w"===x[1],ke(),Tt(),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col").forEach((e=>e.remove())),document.querySelectorAll("#btnReset").forEach((e=>e.remove())),document.querySelectorAll("#btnAutoFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnUndo").forEach((e=>e.remove())),document.querySelectorAll(".eval").forEach((e=>e.remove())),$t.style.display="inline-block","ontouchstart"in window||navigator.maxTouchPoints>0||(document.querySelector("aside").style.marginTop="2.8rem"),r.length>=q&&(xt.style.display="inline-block"),b=l?.name||null,S=s?.name||null,D=x[3],nn()===s?.rid?Et(!0):Et(!1),Y.forEach(((e,t)=>{const n=r[t].color;if(Rt(t,e,n),t+1===r.length&&(e.includes("+")||e.includes("#"))){let t=null;"white"===n?t=F:"black"===n&&(t=M),st(t,e.includes("#")),e.includes("#")&&it(t)}})),W.forEach((({from:e,to:t,promotion:n})=>{const o=e+t;n&&(o+=n),Z.push(o)})),b&&S){const e=document.querySelector(".score .bottom span.name");e&&(e.textContent=ue?S:b);const t=document.querySelector(".score .top span.name");t&&(t.textContent=ue?b:S)}an(d),"waiting"!==a&&u(),"ongoing"===a||("finished"===a?(Lt.style.display="block",xt.style.display="none",U=!1,un(m[0])):"closed"===a&&(Lt.style.display="none")),p?ln(e.time):function(){if(!k)return;const e=document.getElementById("app"),t=document.createElement("div");e.append(t),t.classList.add("form-time-container");[{logo:"🚀",name:"bullet",values:["1+0","1+2","2+1"]},{logo:"⚡",name:"blitz",values:["3+0","3+2","5+0"]},{logo:"⏲️",name:"rapid",values:["10+0","15+10","30+0"]}].forEach((({logo:e,name:n,values:o})=>{const r=document.createElement("div");t.append(r),r.classList.add(n);const i=document.createElement("span");i.textContent=e,r.append(i),o.forEach((e=>{const n=document.createElement("button"),[o,i]=e.split("+");r.append(n);let c=o;+i&&(c+="+"+i),n.textContent=c,n.addEventListener("click",(()=>{tn(v,{type:"c.time.set",data:e}),t.remove()}))}))}))}()}function cn(e,t){tn(v,{type:"c.play.move",data:{from:e,to:t,moveState:W[W.length-1]}})}function ln(e){E.time=e;const t=document.querySelector(".form-time-container");t&&t.remove();let[n]=e.split("+");if(n=n.padStart(2,"0"),mn(),["finished","closed"].includes(E.status))return;const o=document.querySelector(".score .bottom span.time"),r=document.querySelector(".score .top span.time");o&&(o.textContent=`${n}:00`,o.classList.add("active"),o.classList.remove("rush")),r&&(r.textContent=`${n}:00`,r.classList.add("active"),r.classList.remove("rush")),mn(),"waiting"===E.status&&s()}function sn(){const e=nn();if(!k||!E||!e)return!0;return(T?E.white?.rid:E.black?.rid)===e}function an(e){const t=document.querySelector(".score .bottom span:first-child"),n=e=>e.replace(/\b(\d+)\.(\d+)\b/g,((e,t,n)=>n?"0"===t?"½":`${t} ½`:e));t&&(t.textContent=ue?e[1]:e[0],t.textContent=n(t.textContent),ue?t.parentElement.classList.add("flip"):t.parentElement.classList.remove("flip"));const o=document.querySelector(".score .top span:first-child");o&&(o.textContent=ue?e[0]:e[1],o.textContent=n(o.textContent),ue?o.parentElement.classList.add("flip"):o.parentElement.classList.remove("flip")),"finished"===E.status&&document.querySelectorAll(".time").forEach((e=>e.classList.add("active")))}function dn(){tn(v,{type:"c.draw.accepted",data:!0}),U=!1}function un(e){if(!/resign/i.test(e.termination))return;let t="";t=e.termination.split(" ")[0]===e.black?"white":"black";const n="white"===t?M:F;it(n,"🚩"),st(n,!0)}function mn(){if(!(E&&E.time&&E.moveState.length&&E.timeWhite&&E.timeBlack))return;L||h();const{timeWhite:e,timeBlack:t}=E;clearInterval(C);const n=e=>{e=Math.max(e,0);const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);let o=0;e<=1e4&&(o=Math.floor(e%1e3/100));const r=e=>e.toString().padStart(2,"0"),i=e<=1e4?"."+o:"";return`${r(t)}:${r(n)}${i}`},o=e=>`.score .${e} span.time`,r=(e,t)=>{t<=1e4?e.classList.add("rush"):e.classList.remove("rush")};if(["bottom","top"].forEach((i=>{const c=document.querySelector(o(i));let l=0;l="bottom"===i?ue?t.remaining:e.remaining:ue?e.remaining:t.remaining,c.textContent=n(l),r(c,l)})),"ongoing"!==E.status)return;const i=T?"white":"black";let c=null;c="white"===i?E.timeWhite:E.timeBlack;let l=((e,t)=>{if(!t)return e;return e-=Date.now()-t})(c.remaining,c.start);l<=0&&pn(i);let s=1e3;const a=()=>{if(l-=s,"ongoing"===E.status&&l>0&&(l>=1e4?s=1e3:l<1e4&&90!==s&&(s=90,clearInterval(C),C=null),C||(C=setInterval(a,s))),l<=0)return void pn(i);const e=n(l);let t="white"===i?"bottom":"top";const c=nn()===E.white.rid&&"white"===i,d=nn()===E.white.rid&&"white"!==i,u=nn()===E.black.rid&&"black"===i,m=nn()===E.black.rid&&"black"!==i;c||u?t="bottom":(d||m)&&(t="top");const p=document.querySelector(o(t));document.querySelectorAll(".time").forEach((e=>e.classList.remove("active"))),p&&(p.textContent=e,p.classList.add("active"),r(p,l))};C=setInterval(a,s)}function pn(e){E.status="finished",U=!1,clearInterval(C),tn(v,{type:"c.time.out",data:e})}Ut.innerHTML=Nt,Wt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>',Dt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>',Vt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',zt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',Kt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>',Ut.addEventListener("click",(()=>{if(jt=!jt,jt){Ut.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect x="14" y="4" width="4" height="16" rx="1"/><rect x="6" y="4" width="4" height="16" rx="1"/></svg>';const e=()=>{Zt({direction:"right"}),Pt=setTimeout(e,1e3)};e()}else Xt()})),Vt.addEventListener("click",(()=>{Yt()})),Wt.addEventListener("pointerdown",(()=>{Xt();const e=()=>{Zt({direction:"left"}),Pt=setTimeout(e,Ot),Qt()};e()})),Wt.addEventListener("pointerup",(()=>{Xt()})),Dt.addEventListener("pointerdown",(()=>{Xt();const e=()=>{Zt({direction:"right"}),Pt=setTimeout(e,Ot),Qt()};e()})),Dt.addEventListener("pointerup",(()=>{Xt()})),zt.addEventListener("click",(()=>{o("analysis"),St(),te=-1,Xt(),Gt(te,"left")})),Kt.addEventListener("click",(()=>{te=W.length-1,Gt(te,"right")})),window.addEventListener("keydown",(e=>{Zt({ev:e})}))})();