import{playSound as e}from"./audio.js";import{renderSettings as t}from"./settings.js";import{changeBoardTheme as n,imgPieceMapping as o}from"./themes.js";import{displayQRCode as r,getDate as c,hideQRCode as i,isUppercase as l,lock as s,simpleClone as a,uuid as d}from"./utils.js";(()=>{const u={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"},m=function(){const e={};return e.onopen=()=>{setInterval(pt,8e3)},e.onclose=()=>{alert("Connection to server lost... reloading page."),window.location.reload()},e}();m.onmessage=({data:t})=>{!function(t){let n;try{n=JSON.parse(t)}catch(e){console.error(e)}if(!n)return;const{type:o,data:r}=n;switch(o){case"s.room.in":!function(e){if(p=e,p){document.getElementById("btnVsBot")?.remove(),document.getElementById("btnUndo")?.remove();const e=document.querySelector(".fen");e&&(e.style.display="none"),document.querySelectorAll(".score").forEach((e=>{e.style.display="flex"}))}gt()?ht(m,{type:"c.name.get",data:gt()}):yt()}(r);break;case"s.room.share-info":vt(r);break;case"c.rid.register":!function(e){localStorage.setItem("rid",e);const t=()=>{let e=prompt("Name");return e||(e=t()),/^[a-zA-Z ]{2,}$/.test(e.trim())||(alert("Name must be alphabet and contains at least 2 characters"),e=t()),e};f=t(),ht(m,{type:"c.name.set",data:{name:f,rid:gt()}})}(r);case"c.name.get":!function(e){if(e)return void(f=e);yt()}(r),function(){if(!p)return;ht(m,{type:"c.room.join",data:gt()})}();break;case"c.play.move":!function(e){const{from:t,to:n,timeWhite:o,timeBlack:r}=e;fe(t,n,!0),M.length>=v&&(ut.style.display="inline-block");o&&r&&(h.timeWhite=o,h.timeBlack=r,qt())}(r);break;case"c.play.checkmate":!function({scores:e,aPgnArchive:t}){h.status="finished",h.scores=e,h.pgnArchive.unshift(t),bt(e),it.style.display="block",ut.style.display="none",qt()}(r);break;case"c.rematch.request":!function(e){const t=confirm(`${e} wants to rematch. Do you ACCEPT?`);it.style.display="none",!1===t&&(h.status="closed");ht(m,{type:"c.rematch.response",data:t})}(r);break;case"c.rematch.response":!function(t){if(!t||!1===t)return void alert("Rematch Declined");De(),oe(),he(),vt(t),e("gameStart")}(r);break;case"c.resign":!function({message:t,scores:n,aPgnArchive:o}){Ct(o),T=!1,h.status="finished",h.scores=n,h.pgnArchive.unshift(o),bt(n),ut.style.display="none",dt.style.display="none",e("gameEnd"),clearInterval(E),setTimeout((()=>{alert(t),it.style.display="block"}),1e3)}(r);break;case"c.time.set":wt(r);break;case"s.time.info":!function({timeWhite:e,timeBlack:t}){h.timeWhite=e,h.timeBlack=t,qt()}(r);break;case"c.time.out":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:c}){T=!1,h.status="finished",h.timeWhite=t,h.timeBlack=n,h.scores=c,h.pgnArchive.unshift(o),bt(c),qt(),confettis(),e("gameEnd"),setTimeout((()=>{it.style.display="block",ut.style.display="none",dt.style.display="none",alert(r),w&&w.release()}),500)}(r);break;case"c.draw.offer":confirm(`${r} offers a draw. Do you accept?`)?St():ht(m,{type:"c.draw.declined",data:!0});break;case"c.draw.declined":!function(e){alert(`${e} does not want to draw.`)}(r);break;case"c.draw.accepted":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:c}){T=!1,h.status="finished",h.timeWhite=t,h.timeBlack=n,h.scores=c,h.pgnArchive.unshift(o),bt(c),qt(),confettis(),e("gameEnd"),setTimeout((()=>{it.style.display="block",ut.style.display="none",dt.style.display="none",alert(r),w&&w.release()}),500)}(r);break;case"s.error":!function(e){console.error(e),alert(e),"object"==typeof e&&alert(JSON.stringify(e))}(r)}}(t)};let f=null,p=!1,h=null,g=null,y=null;const v=20;let E=null,w=null,k="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",b=k.split(" "),S=b[0],C=!b[1]||"w"===b[1],q="e1",L="e8",I=[],$=[],B=[],A=null,R=null,x=null,T=!0,M=[],N=null,O=[],P="black",U=!1;const H=25;let _=localStorage.getItem("search-time")??1;isNaN(_)?_=1:+_>9?_=9:+_<-1&&(_=-1),localStorage.setItem("search-time",_);let F=null,W=[],j=[],D=!1,z=null;const Q=["g1","g8","c1","c8"],G="hl-hov-square",J="hl-previous-move",K="hl-square",V="hl-legal-squares",X="hl-capture";let Y=!1,Z=!1;function ee(){document.querySelector(".board").removeEventListener("pointerleave",me);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].removeEventListener("pointermove",ce),e[t].removeEventListener("pointerout",ie),e[t].removeEventListener("pointerup",le)}function te(){const e=document.getElementsByClassName("square");for(let t=Z?63:0;Z?t>=0:t<e.length;Z?t--:t++){const n=Z?1+Math.floor(t/8):8-Math.floor(t/8),o=Z?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8);e[t].id=o+n}}function ne(){const e=document.getElementsByClassName("square"),t=e=>e.remove();document.querySelectorAll(".file").forEach(t),document.querySelectorAll(".rank").forEach(t);for(let t=Z?63:0;Z?t>=0:t<e.length;Z?t--:t++){const n=Z?1+Math.floor(t/8):8-Math.floor(t/8),o=Z?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),r=e[t];if(t>=56&&t<=64){const e=document.createElement("div");e.classList.add("file"),r.prepend(e),e.textContent=o}if((t+1)%8==1){const e=document.createElement("div");e.classList.add("rank"),r.prepend(e),e.textContent=n}}}function oe(){$=[],M=[],B=[],I=[],A=null,N=null,P="black",O=[],W=[],j=[],D=!1,R=null,x=null,T=!0,q="e1",L="e8"}function re(){const t=document.getElementsByClassName("square"),n=function(e){return e.replace(/\d/g,(e=>"1".repeat(+e)))}(S).split("/");for(let e=Z?63:0;Z?e>=0:e<t.length;Z?e--:e++){const r=Z?1+Math.floor(e/8):8-Math.floor(e/8),c=Z?String.fromCharCode(104-e%8):String.fromCharCode(97+e%8),i=97-c.charCodeAt(0),s=t[e];s.id=c+r;let a="",m="",f="";const p=n[8-r].charAt(-i);if(isNaN(+p)?(a=l(p)?"white":"black",m=u[p.toLowerCase()],f=$.length===t.length?Ee(s.id).pieceId:d(),"king"===m&&("white"===a&&(q=s.id),"black"===a&&(L=s.id))):(a=null,m=null,f=null),$.length<t.length&&$.push({squareId:s.id,color:a,pieceType:m,pieceId:f}),s.querySelectorAll(".piece").forEach((e=>{e.remove()})),f){const e=document.createElement("div");e.id=f,e.dataset.color=a,e.classList.add("piece"),e.classList.add(m),e.addEventListener("pointerdown",ae),e.addEventListener("pointermove",de);const t=document.createElement("img");t.src=o[p],t.alt=p,t.setAttribute("draggable",!1),e.appendChild(t),s.appendChild(e)}}const r=tt(),c=document.querySelector(".fen");c&&(c.textContent=r),M.length||e("gameStart")}function ce(e){if(!T||!R)return;ue(e),e.preventDefault();const t=e.target;2===t.id.length?t.classList.add(G):t.parentElement.classList.add(G)}function ie(e){T&&(e.preventDefault(),e.target.classList.remove(G))}function le(e){e.preventDefault(),ee();const t=e.currentTarget.id;if(R&&A===t&&I.length)return x=R,R.classList.remove("dragging"),document.getElementById(A).appendChild(R),function(e){const t=document.getElementById(e);t.querySelectorAll(`.${K}`).forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add(K),t.append(n)}(A),void(R=null);ye();R&&(R.classList.remove("dragging"),R=null,x=null,ge(),fe(A,t))}function se(e){if(e.preventDefault(),!kt())return;if(2===e.button)return;if(!x)return;document.querySelectorAll(`.${K}`).forEach((e=>e.remove()));const t=e.currentTarget.id;A!==t&&(document.querySelectorAll(".square").forEach((e=>{e.removeEventListener("pointerdown",se)})),ee(),ye(),ge(),x=null,I.includes(t)&&(fe(A,t),pe(A,t)))}function ae(e){if(!T)return;if(2===e.button)return;if(!kt())return;const t=e.target;te(),function(){document.querySelector(".board").addEventListener("pointerleave",me);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].addEventListener("pointermove",ce),e[t].addEventListener("pointerout",ie),e[t].addEventListener("pointerup",le),e[t].addEventListener("pointerdown",se)}();const n=t.parentElement.id,{color:o,pieceType:r}=Ee(n);if(x){const e=x.parentElement.id,{color:n}=Ee(e);if(o!==n&&x.id!==t.id)return}A=n;if(C&&"white"===o||!C&&"black"===o){if(ge(),ye(),R=t,ue(e),I=[...be(n)],I=Ge(I,n,o,r),I=[...new Set(I)],"king"===r){const e=Fe(n,o),t="white"===o?1:8,r=Je(o),c=Ke(o);let i=!1,l=!1;r&&(i=Fe(`f${t}`,o)),c&&(l=Fe(`d${t}`,o)),e&&(r||c)?I=I.filter((e=>!Q.includes(e))):(i&&(I=I.filter((e=>e!==`g${t}`))),l&&(I=I.filter((e=>e!==`c${t}`))))}I.forEach((e=>{const{color:t}=Ee(e),n=document.getElementById(e),r=document.createElement("div");r.classList.add(V),n.appendChild(r),t&&t!==o&&r.classList.add(X)}))}}function de(e){if(R){const e=R;e.classList.add("dragging"),document.body.append(e)}}function ue(e){if(!R)return;const t=R;let n=t.getBoundingClientRect().width,o=t.getBoundingClientRect().height;n=e.clientX-n/2,o=e.clientY-o/2,("ontouchstart"in window||navigator.maxTouchPoints>0)&&(o-=50),t.style.left=`${n}px`,t.style.top=`${o}px`}function me(e){ee(),document.getElementById(A).append(R),R.classList.remove("dragging"),R=null,document.querySelectorAll(`.${V}`).forEach((e=>e.remove())),document.querySelectorAll(`.${G}`).forEach((e=>e.classList.remove(G)))}function fe(t,n,r=!1){let c=null;r&&3===n.length&&(c=n.slice(2,3),n=n.slice(0,2));const i=t,l=n,s=document.getElementById(l),{pieceId:a,pieceType:d,color:m}=Ee(i),{color:f}=Ee(l),h=document.getElementById(a);r&&I.push(n);const g=i===l,y=!I.includes(l);if(g||y)return document.getElementById(i).appendChild(h),I=[],void(i!==l&&e("illegal"));let v;if("king"===d){if(Fe(l,m))return;Q.includes(l)&&!Ve(m)&&(!function(e,t){const n="white"===e?1:8;let o=null,r=null;t===`g${n}`&&(o=`h${n}`,r=`f${n}`);t===`c${n}`&&(o=`a${n}`,r=`d${n}`);const{pieceId:c}=Ee(o),i=document.getElementById(c);document.getElementById(r).append(i),we($,o,r),pe(o,r)}(m,l),v=!0),"white"===m?q=l:L=l}let E,w=!1;if(f){if(f===m)return;{const e=s.querySelector(".piece");e.removeEventListener("pointerdown",ae),e.removeEventListener("pointermove",de),s.removeChild(e),w=!0}}if(N===l&&(!function(e){if(!N)return;const t="white"===e?-1:1,n=+N[1]+t,o=Ee(`${N[0]}${n}`);let r=document.getElementById(o.squareId).querySelector(".piece");r&&(r.remove(),r.removeEventListener("pointerdown",ae),r.removeEventListener("pointermove",de));r=document.getElementById(o.pieceId),r&&(r.remove(),r.removeEventListener("pointerdown",ae),r.removeEventListener("pointermove",de));o.color=null,o.pieceId=null,o.pieceType=null}(m),w=!0),!h)throw new Error(`[CHESS_ERROR] Unable to move piece with id (${a}) positioned at squareId: ${i}`);if(s.appendChild(h),r&&pe(i,l),we($,i,l),I=[],N=null,"pawn"===d){const e="white"===m?2:7,t="white"===m?2:-2,n="white"===m?3:6;+i[1]===e&&+l[1]===e+t&&(N=`${l[0]}${n}`)}if("pawn"===d){const e="white"===m&&8==+l[1],t="black"===m&&1==+l[1];(e||t)&&(E="pending")}if(M.push({from:i,to:l,color:m,pieceType:d,hasCapture:w,castle:v,promotion:E}),j.push(t+n),ft(),e(v?"castle":w?"capture":"move"),ve(i,l),E)return r?(Ye(c),void setTimeout((()=>{Ze(m,u[c],l),et(r)}),250)):(T=!1,void function(e){if(e.length>2)throw new Error("[CHESS_ERROR] Invalid square id. Unable to promote.");const{color:t}=Ee(e),n="white"===t?8:1;if(8!==n&&1!==n)return!1;if("white"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote white with squareId: ${e}`);if("black"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote black with squareId: ${e}`);const r=document.createElement("div"),c=document.createElement("div");r.classList.add("promotion-container"),c.classList.add("promotion-content"),r.append(c);let i=["Q","R","B","N"];"black"===t&&(i=i.map((e=>e.toLowerCase())));const l=document.getElementById(e);if(!l)throw new Error("[CHESS_ERROR] Board square was not found");const s=.95*l.getBoundingClientRect().height;i.forEach(((n,i)=>{const l=document.createElement("div"),a=document.createElement("img");a.src=o[n],a.alt=n,a.height=s,a.width=s,l.addEventListener("click",(()=>{Ze(t,u[n.toLowerCase()],e),r.remove(),Ye(n),T=!0;const{from:o,to:c}=M[M.length-1];Et(o,c),et()})),l.classList.add("promotion-square"),l.append(a),c.append(l),1===i&&c.append(document.createElement("br"))}));const a=document.querySelector(".board");if(!a)throw new Error("[CHESS_ERROR] Board was not found");a.append(r)}(l));p&&kt()&&!r&&!E&&Et(i,l),et(r)}function pe(e,t){const n=document.getElementById(t),o=document.getElementById(e);if(!n||!o)return;const r=n.querySelector(".piece");if(!r)return;let c=o.getBoundingClientRect().top,i=o.getBoundingClientRect().left;const l=o.getBoundingClientRect().width,s=n.getBoundingClientRect().top,a=n.getBoundingClientRect().left,d=r.style.transition,u=r.style.position,m=r.style.zIndex;r.style.position="fixed",r.style.zIndex="1000",r.style.top=c+"px",r.style.left=i+"px",r.style.height=l+"px",r.style.width=l+"px";let f=a-i,p=s-c;r.style.transition="transform 250ms ease-in-out",r.style.transform=`translate(${f}px, ${p}px)`,setTimeout((()=>{r.style.transition=d,r.style.transform="translate(0,0)",r.style.position=u,r.style.zIndex=m,r.style.top="auto",r.style.left="auto"}),250)}function he(){document.querySelectorAll(`.${J}`).forEach((e=>{e.remove()}))}function ge(){const e=document.getElementsByClassName(V);for(;e.length>0;)e[0].remove()}function ye(){document.querySelectorAll(`.${G}`).forEach((e=>e.classList.remove(G)))}function ve(e,t){he();const n=document.getElementById(e),o=document.getElementById(t),r=document.createElement("div"),c=document.createElement("div");r.classList.add(J),c.classList.add(J),n.appendChild(r),o.appendChild(c)}function Ee(e,t=$){const n=t.find((t=>t.squareId===e));if(!n)throw new Error(`[CHESS_ERROR] Square with squareId "${e}" was not found`);return n}function we(e,t,n){const o=e.findIndex((e=>e.squareId===t)),r=e.findIndex((e=>e.squareId===n)),c=e[o];e[r]={...c,squareId:n},c.color=null,c.pieceId=null,c.pieceType=null}function ke(e){return[e.charAt(0),+e.charAt(1)]}function be(e,t=$){const{pieceId:n,color:o,pieceType:r}=Ee(e);if(!n)throw new Error(`[CHESS_ERROR] No piece identified at squareId: ${e}`);switch(r){case"pawn":return function(e,t,n=$){return[...Ce(e,t,n),...qe(e,t,n)]}(e,o,t);case"knight":return Le(e,o,t);case"rook":return Ie(e,o,t);case"bishop":return $e(e,o,t);case"queen":return Be(e,o,t);case"king":return Ae(e,o,t);default:throw new Error("[CHESS_ERROR] Unknown piece type")}}function Se(e,t){return e.filter((e=>e.color===t)).flatMap((({squareId:t,color:n,pieceType:o})=>Ge(be(t,a(e)),t,n,o)))}function Ce(e,t,n=$){const[o,r]=ke(e),c=[];let i=o,l=r,s=e;if(l+="white"===t?1:-1,l>8||l<1)return c;const a=[-1,1];for(const e of a)if(i=String.fromCharCode(o.toLowerCase().charCodeAt(0)+e),i>="a"&&i<="h"){s=`${i}${l}`;const{color:e}=Ee(s,n);e&&e!==t&&c.push(s),e||s!==N||c.push(s)}return c}function qe(e,t,n=$){const[o,r]=ke(e),c=[];let i=o,l=r;l+="white"===t?1:-1;let s=`${i}${l}`,a=Ee(s,n);return a.pieceId?c:(c.push(s),"white"===t&&2===r&&l++,"black"===t&&7===r&&l--,s=`${i}${l}`,a=Ee(s,n),a.pieceId||c.push(s),c)}function Le(e,t,n=$){return[..._e(e,t,[[-1,2],[1,2],[-2,1],[2,1],[-2,-1],[2,-1],[-1,-2],[1,-2]],n)]}function Ie(e,t,n=$){const o=ke(e);return[...xe(o,t,n),...Te(o,t,n),...Me(o,t,n),...Ne(o,t,n)]}function $e(e,t,n=$){const o=ke(e);return[...Oe(o,t,n),...Pe(o,t,n),...Ue(o,t,n),...He(o,t,n)]}function Be(e,t,n=$){const o=ke(e);return[...xe(o,t,n),...Te(o,t,n),...Me(o,t,n),...Ne(o,t,n),...Oe(o,t,n),...Pe(o,t,n),...Ue(o,t,n),...He(o,t,n)]}function Ae(e,t,n=$){const o="white"===t?1:8,r=[];return Je(t,n)&&r.push(`g${o}`),Ke(t,n)&&r.push(`c${o}`),[..._e(e,t,[[-1,1],[0,1],[1,1],[-1,-1],[0,-1],[1,-1],[-1,0],[1,0]],n),...r]}function Re({file:e,rank:t,color:n,legalSquares:o},r=$){const c=e+t,{color:i}=Ee(c,r);return(!i||i!==n)&&(o.push(c),!i||i===n)}function xe(e,t,n=$){const o=e[0];let r=e[1];const c=[];for(;r<8;){r++;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Te(e,t,n=$){const o=e[0];let r=e[1];const c=[];for(;r>1;){r--;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Me(e,t,n=$){let o=e[0];const r=e[1],c=[];for(;o<"h";){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e);if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Ne(e,t,n=$){let o=e[0];const r=e[1],c=[];for(;o>"a";){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e);if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Oe(e,t,n=$){let[o,r]=e;const c=[];for(;o<"h"&&r<8;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r++;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Pe(e,t,n=$){let[o,r]=e;const c=[];for(;o>"a"&&r>1;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r--;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Ue(e,t,n=$){let[o,r]=e;const c=[];for(;o>"a"&&r<8;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r++;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function He(e,t,n=$){let[o,r]=e;const c=[];for(;o<"h"&&r>1;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r--;if(!Re({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function _e(e,t,n,o=$){const[r,c]=ke(e),i=[];let l=r,s=c;return n.forEach((([e,n])=>{l=String.fromCharCode(r.charCodeAt(0)+e),s=c+n;if(l<"a"||l>"h"||s>8||s<1)return;const a=l+s,{color:d}=Ee(a,o);t!==d&&i.push(a)})),i}function Fe(e,t,n=$){for(const o of Ie(e,t,n)){const{pieceType:e,color:r}=Ee(o,n);switch(e){case"rook":case"queen":if(t!==r)return!0}}for(const o of $e(e,t,n)){const{pieceType:e,color:r}=Ee(o,n);switch(e){case"bishop":case"queen":if(t!==r)return!0}}for(const o of Le(e,t,n)){const{pieceType:e,color:r}=Ee(o,n);if("knight"===e)if(t!==r)return!0}for(const o of Ae(e,t,n)){const{pieceType:e,color:r}=Ee(o,n);if("king"===e)if(t!==r)return!0}for(const o of Ce(e,t,n)){const{pieceType:e,color:r}=Ee(o,n);if("pawn"===e)if(t!==r)return!0}return!1}function We(){const t=C?q:L,n=C?L:q,o=C?"white":"black",r=a($);if(!Fe(t,o,r))return!1;if(Se(r,o).length>0)return!1;if(De(),Qe(t,!0),je(t),je(n,"ðŸ’Ž"),T=!1,p&&h){const e=C?h.black.rid:h.white.rid;ht(m,{type:"c.play.checkmate",data:e}),h.status="finished",qt()}return confettis(),e("gameEnd"),!0}function je(e,t="ðŸ’¢"){const{color:n}=Ee(e),o=document.getElementById(e);if(!e)throw new Error(`[CHESS_ERROR] Unable to insert checkmate emblem in squareId: ${e}`);const r=document.createElement("div"),c=document.createElement("div"),i=.45*o.getBoundingClientRect().height;r.classList.add("checkmate-container"),c.textContent=t,c.classList.add("checkmate"),c.classList.add(n),c.style.height=i+"%",c.style.width=i+"%",r.append(c),o.append(r)}function De(e=null){const t=document.getElementById(e);if(e&&t){const e=t.querySelector(".checkmate-container");if(!e)return;e.remove()}else document.querySelectorAll(".checkmate-container").forEach((e=>{e.remove()}));document.querySelectorAll(".bloody-check").forEach((e=>e.remove()))}function ze(e,t){const n=["ðŸ˜±","ðŸ˜¨","ðŸ¥µ","ðŸ˜¡","ðŸ˜¤"].filter((e=>e!==z)),o=Math.floor(Math.random()*n.length),r=t??n[o];De(e),je(e,r),z=r}function Qe(e,t=!1){const n=document.getElementById(e);if(n)if(n.querySelectorAll(".bloody-check").forEach((e=>e.remove())),t){const e=n.querySelector(".piece");e&&e.classList.add("bloody-checkmate")}else{const e=document.createElement("div");n.prepend(e),e.classList.add("bloody-check")}}function Ge(e,t,n,o){const r=C?q:L,c=a($);return[...e].forEach((i=>{const l=a(c);we(l,t,i),"king"!==o&&Fe(r,n,l)&&(e=e.filter((e=>e!==i))),"king"===o&&Fe(i,n,l)&&(e=e.filter((e=>e!==i)))})),e}function Je(e,t=$){const n="white"===e?1:8,o=t.find((e=>e.squareId===`f${n}`&&e.pieceId)),r=t.find((e=>e.squareId===`g${n}`&&e.pieceId));return!(o||r||Ve(e)||Xe(e,`h${n}`,t))}function Ke(e,t=$){const n="white"===e?1:8,o=t.find((e=>e.squareId===`b${n}`&&e.pieceId)),r=t.find((e=>e.squareId===`c${n}`&&e.pieceId)),c=t.find((e=>e.squareId===`d${n}`&&e.pieceId));return!(o||r||c||Ve(e)||Xe(e,`a${n}`,t))}function Ve(e){return!!M.find((t=>t.color===e&&"king"===t.pieceType))}function Xe(e,t,n=$){const o=n.find((n=>n.squareId===t&&n.color===e&&"rook"===n.pieceType)),r=M.find((n=>n.color===e&&n.from===t&&"rook"===n.pieceType));return!o||r}function Ye(t){const n=M.find((e=>"pending"===e.promotion));if(!n)throw new Error("[CHESS_ERROR] Unable to find promotion move state");n.promotion=t.toUpperCase(),ft(),e("promote")}function Ze(e,t,n){const r=document.getElementById(n);if(!r)throw new Error(`[CHESS_ERROR] Unable to create piece at ${n}`);const c=r.querySelector(".piece");c&&(c.removeEventListener("pointerdown",ae),c.removeEventListener("pointermove",de),c.remove());const i=d(),l=document.createElement("div");l.classList.add("piece"),l.classList.add(t.toLowerCase()),l.dataset.color=e,l.id=i,l.addEventListener("pointerdown",ae),l.addEventListener("pointermove",de);let s=t[0].toLowerCase();"knight"===t&&(s="n");const a=document.createElement("img");a.alt=s,s="white"===e?s.toUpperCase():s.toLowerCase(),a.src=o[s],l.append(a),r.append(l);const u=Ee(n);u.pieceId=i,u.pieceType=t,u.color=e}function et(t=!1){!function(e=500){setTimeout((()=>{Y&&ot()}),e)}(),De(),C=!C,W.push(function({color:t,castle:n,from:o,to:r,pieceType:c,hasCapture:i,promotion:l},s){const a=r[0];let d="";n&&("g"===a&&(d="O-O"),"c"===a&&(d="O-O-O"));const u=()=>{if("king"===c)return;const e=$.filter((e=>e.color===t&&e.pieceType===c&&e.squareId!==o));for(let n=0;n<e.length;n++){const i=e[n].squareId;let l=[];const s="white"===t?"black":"white";if("knight"===c?l=Le(i,s):"bishop"===c?l=$e(i,s):"rook"===c?l=Ie(i,s):"queen"===c&&(l=Be(i,s)),l.includes(r)){const e=o.charAt(0)===i.charAt(0);d+=e?o.charAt(1):o.charAt(0);break}}};if("pawn"===c)d+="";else{let e=c.charAt(0).toUpperCase();"knight"===c&&(e="N"),n||(d+=e),u()}i&&("pawn"===c&&(d+=o.charAt(0)),d+="x");n||(d+=r);l&&(d+="="+l);const m="white"===t?"black":"white";let f="white"===m?q:L;We()?s>=0&&s===M.length&&(d+="#"):Fe(f,m)&&(d+="+",s===M.length&&(e("check"),ze(f),Qe(f)));return st(s,d,t),d}(M[M.length-1],M.length));const n="white"===P&&C,o="black"===P&&!C,r=tt();B.push(r),b=r.split(" "),S=b[0],p&&!t&&ht(m,{type:"c.state.fenpgn",data:[r,W[W.length-1]]});const c=document.querySelector(".fen");c&&(c.textContent=r);let i=!1,l=!1,s=!1,d=!1;(function(){const e=e=>e.split(" ").slice(0,4).join(" ");return B.some((t=>{const n=e(t);return B.filter((t=>e(t)===n)).length>=3}))})()&&(je(q,"ðŸ¤"),je(L,"ðŸ¤"),s=!0),function(e=B[B.length-1]){const t=e.split(" ")[0],n=t.split("").filter((e=>"B"===e)).length,o=t.split("").filter((e=>"b"===e)).length,r=t.split("").filter((e=>"N"===e)).length,c=t.split("").filter((e=>"n"===e)).length,i=t.split("").filter((e=>"Q"===e)).length,l=t.split("").filter((e=>"q"===e)).length,s=t.split("").filter((e=>"R"===e)).length,a=t.split("").filter((e=>"r"===e)).length,d=t.split("").filter((e=>"P"===e)).length,u=t.split("").filter((e=>"p"===e)).length;if(i+l+s+a+d+u>0)return!1;if(r+c>1)return!1;if(n+o>1)return!1;if((n>0||o>0)&&r+c>0)return!1;return!0}()&&(De(),je(q,"ðŸ¤"),je(L,"ðŸ¤"),T=!1,i=!0,d=!0);const u=We(),f=function(){const e=C?q:L,t=C?L:q,n=C?"white":"black",o=a($);return!Fe(e,n,o)&&!(Se(o,n).length>0||(De(),je(e,"â“"),je(t,"ðŸ˜¨"),T=!1,0))}();i||!u&&!f||(l=!0,f&&(d=!0)),!l&&nt()>=100&&(je(q,"ðŸ¥µ"),je(L,"ðŸ¥µ"),d=!0),l||rt(U&&(n||o)),s&&p?(D=!0,dt.style.display="block"):(D=!1,dt.style.display="none"),d&&St()}function tt(e=$){let t="",n=8,o=0;const r=()=>{t=t.replace(/\*+/g,o),o=0};for(;n>=1;){for(let i="a";i<="h";c=i,i=String.fromCharCode(c.charCodeAt(0)+1)){const c=i+n,l=e.find((e=>e.squareId===c));if(!l)throw new Error(`[CHESS_ERROR] Unable to generate FEN due to missing squareId: ${c}`);const{color:s,pieceType:a}=l;if(a){let e="knight"===a?"n":a.charAt(0).toLowerCase();r(),t+="white"===s?e.toUpperCase():e}else t+="*",o++}r(),n>1&&(t+="/"),n--}var c;t+=C?" w ":" b ";let i="";Ve("white")||Xe("white","h1")||(i+="K"),Ve("white")||Xe("white","a1")||(i+="Q"),Ve("black")||Xe("black","h8")||(i+="k"),Ve("black")||Xe("black","a8")||(i+="q"),i||(i="-"),t+=i+" ",t+=(N||"-")+" ";const l=nt();t+=l+" ";const s=Math.floor(M.length/2)+1;return t+=s,t}function nt(){let e=0;for(let t=0;t<M.length;t++)e++,(M[t].hasCapture||"pawn"===M[t].pieceType||M[t].promotion)&&(e=0);return e}function ot(e){const t=document.querySelector(".eval.vertical");if(Z=!Z,void 0!==e&&(Z=e),Z?t?.classList.add("flip"):t?.classList.remove("flip"),te(),re(),ne(),M.length){const{from:e,to:t}=M[M.length-1];ve(e,t)}if(De(),ye(),ge(),x=null,W.length){W[W.length-1].includes("+")&&(C?(ze(q,z),Qe(q)):(ze(L,z),Qe(L)))}}function rt(e,t=B[B.length-1]){if(p)return;if(e&&(T=!1),t=t||k,e&&O.length){const{from:e,to:t}=M[M.length-1],{from:n,to:o}=O.splice(0,1)[0];if(n===e&&o===t){const e=O.splice(0,1)[0];if(e)return void setTimeout((()=>{fe(e.from,e.to,!0),T=!0}),500)}}const n=document.getElementById("thinking");e&&n&&(n.style.display="inline-block"),function(e,t){const n=new Worker("./js/engine.js"),o=/score cp (-?\d+)/,r=/score mate (-?\d+)/,c=/ pv (.+)$/,i=/time (\d+)/,l=e.split(" ")[1];F&&F.terminate(),F=n;let s=1e3*(parseInt(_)+1);n.onmessage=e=>{const a=e.data,d={success:!1,mate:null,evaluation:null,continuation:""};if(a.includes("info depth")&&a.includes(" pv ")){if(a.includes(`info depth ${H}`)&&(n.terminate(),F=null),o.test(a)){const e=o.exec(a)[1];d.evaluation=parseInt(e)/100}if(r.test(a)&&(d.mate=r.exec(a)[1],d.evaluation=null),c.test(a)&&(d.continuation=c.exec(a)[1]),"b"===l&&(d.evaluation&&(d.evaluation*=-1),d.mate&&(d.mate*=-1)),(d.mate||d.evaluation||d.continuation)&&(d.success=!0,lt(d.evaluation,d.mate)),a.includes(`info depth ${H}`)&&t(d),_>=0&&i.test(a)){const e=i.exec(a)[1],n=s;parseInt(e)>=n&&t(d)}}},n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage(`position fen ${e}`);let a=`go depth ${H}`;_>-1&&(a+=` movetime ${s}`),n.postMessage(a)}(t,(t=>{ct(t,e)}))}function ct(e,t){if(!e.success)throw new Error("SF failed");if(lt(e.evaluation,e.mate),!t)return;var n;T=!0,thinking&&(thinking.style.display="none"),n=e.continuation,e.mate,O=n.split(" ").map((e=>({from:e.slice(0,2),to:e.slice(2,5)})));const o=O.splice(0,1);if(!o.length)throw new Error("[SF_ERROR] No more moves found");const{from:r,to:c}=o[0];fe(r,c,!0)}t(o,n,(e=>{_=e})),te(),oe(),re(),ne(),B.push(tt()),document.getElementById("btnAutoFlip").addEventListener("click",(e=>{Y=!Y,Y?e.target.classList.add("glow"):e.target.classList.remove("glow")})),document.getElementById("btnReset").addEventListener("click",(e=>{p||(document.querySelectorAll(".piece").forEach((e=>e.remove())),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),oe(),C=!0,b=k.split(" "),S=b[0],re(),B.push(tt()),he(),ye(),ge(),De(),U=!1,document.getElementById("thinking").style.display="none",document.getElementById("btnVsBot")?.classList.remove("glow"),F&&(F.terminate(),F=null),rt(),document.getElementById("opening-name").textContent="",Z&&Y&&ot(!1))})),document.getElementById("btnFlip").addEventListener("click",(()=>{ot()})),document.getElementById("btnVsBot").addEventListener("click",(e=>{p||(U=!U,T&&(U?(e.target.classList.add("glow"),P=C?"white":"black",T=!1,rt(!0),x&&(x=null,ye(),ge())):e.target.classList.remove("glow")))})),document.getElementById("btnUndo").addEventListener("click",(t=>{if(p||!M.length)return;let n=M.length,o=B.length,r=j.length,c=W.length;const i=M[n-1],{from:l,to:s,promotion:a}=i;if("pending"===a)return void e("illegal");T=!0,x&&(ye(),ge(),x=null),U&&(F&&F.terminate(),document.getElementById("thinking").style.display="none"),he(),De(),o--,B.splice(o,1);const d=B[o-1];b=d.split(" "),S=b[0],N=b[3],C=!b[1]||"w"===b[1],$=[],re(),pe(s,l),n--,M.splice(n,1);const u=c;c--,W.splice(c,1);const m=Math.floor(c/2)+1,f=document.querySelector(`.pgn-row:nth-child(${m})`);if(u%2==0?f.querySelector(".pgn-col:nth-child(3)").textContent="":f.remove(),W[c-1]?.includes("+")&&Qe(C?q:L),r--,j.splice(r,1),ft(),rt(),M.length){const e=M[n-1];ve(e.to,e.from)}Y&&setTimeout(ot,300)}));const it=document.getElementById("btnRematch");function lt(e,t){null===e&&null!==t&&(e=t>0?H:-1*H);let n=50-e/H*100;n=Math.min(n,98),n=Math.max(n,2);const o=document.querySelector(".eval.vertical .bar"),r=document.querySelector(".eval.vertical .num"),c=document.querySelector(".eval.horizontal .bar"),i=document.querySelector(".eval.horizontal .num");if(o&&(o.style.height=n+"%"),c&&(c.style.width=n+"%"),r){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),r.textContent=n,e>0?r.classList.add("w"):r.classList.remove("w")}if(i){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),i.textContent=n,e>0?i.classList.add("w"):i.classList.remove("w")}}function st(e,t,n){const o=document.querySelector(".pgn");if(o){let r=Math.floor(e/2)+1;"black"===n&&e%2==0&&(r=Math.max(r-1,1));let c=null,i=null,l=null,s=document.createElement("button");if(document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),"white"===n){c=document.createElement("div"),i=document.createElement("div"),l=document.createElement("span"),l.textContent=r+".",c.append(l),c.append(i);const e=document.createElement("div");e.classList.add("pgn-col"),c.append(e)}else i=document.querySelector(`.pgn-row:nth-child(${r}) .pgn-col:last-child`);s.textContent=t,c&&(c.classList.add("pgn-row"),o.append(c)),i.classList.add("pgn-col"),s.classList.add("active"),i.append(s)}if(e===M.length){const e=document.querySelector(".pgn-container");e&&(e.scrollTop=e.scrollHeight)}}it.addEventListener("click",(e=>{it.style.display="none",p&&h&&("finished"!==h.status&&"closed"!==h.status||ht(m,{type:"c.rematch.request"}))})),it.style.display="none",document.getElementById("btnCopyFenPGN").addEventListener("click",(()=>{let e=function(e=W){let t=mt();for(let n=0;n<e.length;n++){const o=Math.floor(n/2)+1;n%2==0&&(t+=o+". "),t+=e[n]+" "}return t}();navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard")}));const at=document.getElementById("btnCopyFenPGNALL");at.addEventListener("click",(()=>{let e="";p&&h.pgnArchive?.length&&(e=function(e){let t="";return e.forEach((e=>{const n=e.rawPgn,{round:o,white:r,black:c,result:i,termination:l}=e;let s=mt({round:o,white:r,black:c,result:i,termination:l});for(let e=0;e<n.length;e++){const t=Math.floor(e/2)+1;e%2==0&&(s+=t+". "),s+=n[e]+" "}t+=s+"\n\n"})),t}(h.pgnArchive),navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard"))})),at.style.display="none";const dt=document.getElementById("btnDraw");dt.addEventListener("click",(()=>{p&&"ongoing"===h?.status&&D&&confirm("Are you sure want to offer draw?")&&function(){const e=gt();e&&[h.black.rid,h.white.rid].includes(e)&&ht(m,{type:"c.draw.offer",data:gt()})}()})),dt.style.display="none";const ut=document.getElementById("btnResign");function mt(e){const t=e?.event??"?",n=e?.site??window.location.hostname,o=e?.date??c(),r=e?.round??"?",i=e?.white??"?",l=e?.black??"?",s=e?.result??"?",a=e?.fen??k,d=e?.termination;let u=`[Event "${t}"]\n`;return u+=`[Site "${n}"]\n`,u+=`[Date "${o}"]\n`,u+=`[Round "${r}"]\n`,u+=`[White "${i}"]\n`,u+=`[Black "${l}"]\n`,u+=`[Result "${s}"]\n`,u+=`[FEN "${a}"]\n`,d&&(u+=`[Termination "${d}"]\n`),u+"\n"}function ft(){let e=!1;const t=M.map((t=>{let n=t.from+t.to;return t.promotion&&("pending"!==t.promotion?n+=t.promotion:e=!0),n})).join(",");if(e)return;const n=document.getElementById("opening-name");n&&fetch(`https://explorer.lichess.ovh/masters?play=${t}`).then((e=>e.json())).then((e=>{const t=e?.opening?.name;t?n.innerHTML=t.replace(": ",":<br />"):n.textContent=""}))}function pt(){ht(m,{data:gt()??"anything",type:"c.connection.ping"})}function ht(e,t){e.send(JSON.stringify(t))}function gt(){return localStorage.getItem("rid")}function yt(){ht(m,{type:"c.rid.register"})}function vt(e){const{boardState:t,moveState:n,fenState:o,rawPgn:r,white:c,black:l,status:s,scores:a,pgnArchive:d,time:u}=e;if(h=e,k=o[0],$=t,M=n,B=o,W=r,b=o[o.length-1].split(" "),S=b[0],C=!b[1]||"w"===b[1],re(),ft(),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col").forEach((e=>e.remove())),document.querySelectorAll("#btnReset").forEach((e=>e.remove())),document.querySelectorAll("#btnAutoFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnUndo").forEach((e=>e.remove())),document.querySelectorAll(".eval").forEach((e=>e.remove())),document.querySelector("aside").style.marginTop="1.5rem",at.style.display="inline-block",n.length>=v&&(ut.style.display="inline-block"),g=c?.name||null,y=l?.name||null,N=b[3],gt()===l?.rid?ot(!0):ot(!1),W.forEach(((e,t)=>{const o=n[t].color;st(t,e,o),t+1===n.length&&e.includes("+")&&("white"===o?Qe(L):"black"===o&&Qe(q))})),g&&y){const e=document.querySelector(".score .bottom span.name");e&&(e.textContent=Z?y:g);const t=document.querySelector(".score .top span.name");t&&(t.textContent=Z?g:y)}bt(a),"waiting"!==s&&i(),"ongoing"===s||("finished"===s?(it.style.display="block",ut.style.display="none",T=!1,Ct(d[0])):"closed"===s&&(it.style.display="none")),u?wt(e.time):function(){if(!p)return;const e=document.getElementById("app"),t=document.createElement("div");e.append(t),t.classList.add("form-time-container");[{logo:"ðŸš€",name:"bullet",values:["1+0","1+2","2+1"]},{logo:"âš¡",name:"blitz",values:["3+0","3+2","5+0"]},{logo:"â²ï¸",name:"rapid",values:["10+0","15+10","30+0"]}].forEach((({logo:e,name:n,values:o})=>{const r=document.createElement("div");t.append(r),r.classList.add(n);const c=document.createElement("span");c.textContent=e,r.append(c),o.forEach((e=>{const n=document.createElement("button"),[o,c]=e.split("+");r.append(n);let i=o;+c&&(i+="+"+c),n.textContent=i,n.addEventListener("click",(()=>{ht(m,{type:"c.time.set",data:e}),t.remove()}))}))}))}()}function Et(e,t){ht(m,{type:"c.play.move",data:{from:e,to:t,moveState:M[M.length-1]}})}function wt(e){h.time=e;const t=document.querySelector(".form-time-container");t&&t.remove();let[n]=e.split("+");if(n=n.padStart(2,"0"),qt(),["finished","closed"].includes(h.status))return;const o=document.querySelector(".score .bottom span.time"),c=document.querySelector(".score .top span.time");o&&(o.textContent=`${n}:00`,o.classList.add("active"),o.classList.remove("rush")),c&&(c.textContent=`${n}:00`,c.classList.add("active"),c.classList.remove("rush")),qt(),"waiting"===h.status&&r()}function kt(){const e=gt();if(!p||!h||!e)return!0;return(C?h.white?.rid:h.black?.rid)===e}function bt(e){const t=document.querySelector(".score .bottom span:first-child"),n=e=>e.replace(/\b(\d+)\.(\d+)\b/g,((e,t,n)=>n?"0"===t?"Â½":`${t} Â½`:e));t&&(t.textContent=Z?e[1]:e[0],t.textContent=n(t.textContent),Z?t.parentElement.classList.add("flip"):t.parentElement.classList.remove("flip"));const o=document.querySelector(".score .top span:first-child");o&&(o.textContent=Z?e[0]:e[1],o.textContent=n(o.textContent),Z?o.parentElement.classList.add("flip"):o.parentElement.classList.remove("flip")),"finished"===h.status&&document.querySelectorAll(".time").forEach((e=>e.classList.add("active")))}function St(){ht(m,{type:"c.draw.accepted",data:!0}),T=!1}function Ct(e){if(!/resign/i.test(e.termination))return;let t="";t=e.termination.split(" ")[0]===e.black?"white":"black";je("white"===t?q:L,"ðŸš©")}function qt(){if(!(h&&h.time&&h.moveState.length&&h.timeWhite&&h.timeBlack))return;w||s();const{timeWhite:e,timeBlack:t}=h;clearInterval(E);const n=e=>{e=Math.max(e,0);const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);let o=0;e<=1e4&&(o=Math.floor(e%1e3/100));const r=e=>e.toString().padStart(2,"0"),c=e<=1e4?"."+o:"";return`${r(t)}:${r(n)}${c}`},o=e=>`.score .${e} span.time`,r=(e,t)=>{t<=1e4?e.classList.add("rush"):e.classList.remove("rush")};if(["bottom","top"].forEach((c=>{const i=document.querySelector(o(c));let l=0;l="bottom"===c?Z?t.remaining:e.remaining:Z?e.remaining:t.remaining,i.textContent=n(l),r(i,l)})),"ongoing"!==h.status)return;const c=C?"white":"black";let i=null;i="white"===c?h.timeWhite:h.timeBlack;let l=((e,t)=>{if(!t)return e;return e-=Date.now()-t})(i.remaining,i.start);l<=0&&Lt(c);let a=1e3;const d=()=>{if(l-=a,"ongoing"===h.status&&l>0&&(l>=1e4?a=1e3:l<1e4&&90!==a&&(a=90,clearInterval(E),E=null),E||(E=setInterval(d,a))),l<=0)return void Lt(c);const e=n(l);let t="white"===c?"bottom":"top";const i=gt()===h.white.rid&&"white"===c,s=gt()===h.white.rid&&"white"!==c,u=gt()===h.black.rid&&"black"===c,m=gt()===h.black.rid&&"black"!==c;i||u?t="bottom":(s||m)&&(t="top");const f=document.querySelector(o(t));document.querySelectorAll(".time").forEach((e=>e.classList.remove("active"))),f&&(f.textContent=e,f.classList.add("active"),r(f,l))};E=setInterval(d,a)}function Lt(e){h.status="finished",T=!1,clearInterval(E),ht(m,{type:"c.time.out",data:e})}ut.addEventListener("click",(()=>{p&&"ongoing"===h?.status&&(h.moveState.length<v||confirm("Are you sure you want to resign?")&&(h.status="finished",ut.style.display="none",ht(m,{type:"c.resign"})))})),ut.style.display="none"})();