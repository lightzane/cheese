import{playSound as e}from"./audio.js";import{renderSettings as t}from"./settings.js";import{changeBoardTheme as n,currentThemeName as o,imgPieceMapping as r}from"./themes.js";import{displayQRCode as c,generateChess960StartingPos as i,getDate as l,hideQRCode as s,isUppercase as a,letterRange as d,lock as u,simpleClone as m,uuid as p}from"./utils.js";(()=>{const f={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"},h=function(){const e={};return e.onopen=()=>{setInterval(bt,8e3)},e.onclose=()=>{alert("Connection to server lost... reloading page."),window.location.reload()},e}();h.onmessage=({data:t})=>{!function(t){let n;try{n=JSON.parse(t)}catch(e){console.error(e)}if(!n)return;const{type:o,data:r}=n;switch(o){case"s.room.in":!function(e){if(y=e,y){document.getElementById("btnVsBot")?.remove(),document.getElementById("btnUndo")?.remove();const e=document.querySelector(".fen");e&&(e.style.display="none"),document.querySelectorAll(".score").forEach((e=>{e.style.display="flex"}))}qt()?St(h,{type:"c.name.get",data:qt()}):Ct()}(r);break;case"s.room.share-info":Lt(r);break;case"c.rid.register":!function(e){localStorage.setItem("rid",e);const t=()=>{let e=prompt("Name");return e||(e=t()),/^[a-zA-Z ]{2,}$/.test(e.trim())||(alert("Name must be alphabet and contains at least 2 characters"),e=t()),e};g=t(),St(h,{type:"c.name.set",data:{name:g,rid:qt()}})}(r);case"c.name.get":!function(e){if(e)return void(g=e);Ct()}(r),function(){if(!y)return;St(h,{type:"c.room.join",data:qt()})}();break;case"c.play.move":!function(e){const{from:t,to:n,timeWhite:o,timeBlack:r}=e;Ee(t,n,!0),H.length>=w&&(vt.style.display="inline-block");o&&r&&(v.timeWhite=o,v.timeBlack=r,Tt())}(r);break;case"c.play.checkmate":!function({scores:e,aPgnArchive:t}){v.status="finished",v.scores=e,v.pgnArchive.unshift(t),Bt(e),pt.style.display="block",vt.style.display="none",Tt()}(r);break;case"c.rematch.request":!function(e){const t=confirm(`${e} wants to rematch. Do you ACCEPT?`);pt.style.display="none",!1===t&&(v.status="closed");St(h,{type:"c.rematch.response",data:t})}(r);break;case"c.rematch.response":!function(t){if(!t||!1===t)return void alert("Rematch Declined");Ve(),ae(),we(),Lt(t),e("gameStart")}(r);break;case"c.resign":!function({message:t,scores:n,aPgnArchive:o}){xt(o),U=!1,v.status="finished",v.scores=n,v.pgnArchive.unshift(o),Bt(n),vt.style.display="none",yt.style.display="none",e("gameEnd"),clearInterval(b),setTimeout((()=>{alert(t),pt.style.display="block"}),1e3)}(r);break;case"c.time.set":$t(r);break;case"s.time.info":!function({timeWhite:e,timeBlack:t}){v.timeWhite=e,v.timeBlack=t,Tt()}(r);break;case"c.time.out":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:c}){U=!1,v.status="finished",v.timeWhite=t,v.timeBlack=n,v.scores=c,v.pgnArchive.unshift(o),Bt(c),Tt(),Ft(),e("gameEnd"),setTimeout((()=>{pt.style.display="block",vt.style.display="none",yt.style.display="none",alert(r),S&&S.release()}),500)}(r);break;case"c.draw.offer":confirm(`${r} offers a draw. Do you accept?`)?At():St(h,{type:"c.draw.declined",data:!0});break;case"c.draw.declined":!function(e){alert(`${e} does not want to draw.`)}(r);break;case"c.draw.accepted":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:c}){U=!1,v.status="finished",v.timeWhite=t,v.timeBlack=n,v.scores=c,v.pgnArchive.unshift(o),Bt(c),Tt(),Ft(),e("gameEnd"),setTimeout((()=>{pt.style.display="block",vt.style.display="none",yt.style.display="none",alert(r),S&&S.release()}),500)}(r);break;case"s.error":!function(e){console.error(e),alert(e),"object"==typeof e&&alert(JSON.stringify(e))}(r)}}(t)};let g=null,y=!1,v=null,E=null,k=null;const w=20;let b=null,S=null;let q=new URLSearchParams(window.location.search).get("v");!q||"chess960"!==q&&"960"!==q||(q="chess960");let C=q??"standard",L="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",I=null,$=L.split(" "),R=$[0],B=!$[1]||"w"===$[1],A="e1",x="e8",T=[],M=[],F=[],N=null,O=null,P=null,U=!0,H=[],_=null,W=[],j="black",D=!1;const z=25;let K=localStorage.getItem("search-time")??1;isNaN(K)?K=1:+K>9?K=9:+K<-1&&(K=-1),localStorage.setItem("search-time",K);let Q=null,G=[],J=[],V=!1,X=null,Y=["g1","g8","c1","c8"];const Z="hl-hov-square",ee="hl-previous-move",te="hl-square",ne="hl-legal-squares",oe="hl-capture";let re=!1,ce=!1;function ie(){document.querySelector(".board").removeEventListener("pointerleave",ve);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].removeEventListener("pointermove",ue),e[t].removeEventListener("pointerout",me),e[t].removeEventListener("pointerup",pe)}function le(){const e=document.getElementsByClassName("square");for(let t=ce?63:0;ce?t>=0:t<e.length;ce?t--:t++){const n=ce?1+Math.floor(t/8):8-Math.floor(t/8),o=ce?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8);e[t].id=o+n}}function se(){const e=document.getElementsByClassName("square"),t=e=>e.remove();document.querySelectorAll(".file").forEach(t),document.querySelectorAll(".rank").forEach(t);for(let t=ce?63:0;ce?t>=0:t<e.length;ce?t--:t++){const n=ce?1+Math.floor(t/8):8-Math.floor(t/8),o=ce?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),r=e[t];if(t>=56&&t<=64){const e=document.createElement("div");e.classList.add("file"),r.prepend(e),e.textContent=o}if((t+1)%8==1){const e=document.createElement("div");e.classList.add("rank"),r.prepend(e),e.textContent=n}}}function ae(){M=[],H=[],F=[],T=[],N=null,_=null,j="black",W=[],G=[],J=[],V=!1,O=null,P=null,U=!0,A="e1",x="e8","standard"===C&&(Y=["g1","g8","c1","c8"])}function de(){const t=document.getElementsByClassName("square"),n=function(e){return e.replace(/\d/g,(e=>"1".repeat(+e)))}(R).split("/");for(let e=ce?63:0;ce?e>=0:e<t.length;ce?e--:e++){const o=ce?1+Math.floor(e/8):8-Math.floor(e/8),c=ce?String.fromCharCode(104-e%8):String.fromCharCode(97+e%8),i=97-c.charCodeAt(0),l=t[e];l.id=c+o;let s="",d="",u="";const m=n[8-o].charAt(-i);if(isNaN(+m)?(s=a(m)?"white":"black",d=f[m.toLowerCase()],u=M.length===t.length?Ce(l.id).pieceId:p(),"king"===d&&("white"===s&&(A=l.id),"black"===s&&(x=l.id))):(s=null,d=null,u=null),M.length<t.length&&M.push({squareId:l.id,color:s,pieceType:d,pieceId:u}),l.querySelectorAll(".piece").forEach((e=>{e.remove()})),u){const e=document.createElement("div");e.id=u,e.dataset.color=s,e.classList.add("piece"),e.classList.add(d),e.addEventListener("pointerdown",he),e.addEventListener("pointermove",ge);const t=document.createElement("img");t.src=r[m],t.alt=m,t.setAttribute("draggable",!1),e.appendChild(t),l.appendChild(e)}}const o=st(),c=document.querySelector(".fen");c&&(c.textContent=o),H.length||e("gameStart")}function ue(e){if(!U||!O)return;ye(e),e.preventDefault();const t=e.target;2===t.id.length?t.classList.add(Z):t.parentElement.classList.add(Z)}function me(e){U&&(e.preventDefault(),e.target.classList.remove(Z))}function pe(e){e.preventDefault(),ie();const t=e.currentTarget.id;if(O&&N===t&&T.length)return P=O,O.classList.remove("dragging"),document.getElementById(N).appendChild(O),function(e){const t=document.getElementById(e);t.querySelectorAll(`.${te}`).forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add(te),t.append(n)}(N),void(O=null);Se();O&&(O.classList.remove("dragging"),O=null,P=null,be(),Ee(N,t))}function fe(e){if(e.preventDefault(),!Rt())return;if(2===e.button)return;if(!P)return;document.querySelectorAll(`.${te}`).forEach((e=>e.remove()));const t=e.currentTarget.id;N!==t&&(document.querySelectorAll(".square").forEach((e=>{e.removeEventListener("pointerdown",fe)})),ie(),Se(),be(),P=null,T.includes(t)&&(Ee(N,t),ke(N,t)))}function he(e){if(!U)return;if(2===e.button)return;if(!Rt())return;let t=e.target;le(),function(){document.querySelector(".board").addEventListener("pointerleave",ve);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].addEventListener("pointermove",ue),e[t].addEventListener("pointerout",me),e[t].addEventListener("pointerup",pe),e[t].addEventListener("pointerdown",fe)}();let n=t.parentElement.id,o=Ce(n),r=o.color,c=o.pieceType;if(P){const e=P.parentElement.id,{color:i,pieceType:l}=Ce(e);let s=!1;if("chess960"!==C||"king"!==l||"rook"!==c||r!==i||rt(r,n)||(s=!0,T.includes(n)||T.push(n),t=P,P=null,n=t.parentElement.id,o=Ce(n),r=o.color,c=o.pieceType,document.querySelectorAll(`.${te}`).forEach((e=>e.remove()))),r!==i&&P.id!==t.id&&!s)return}N=n;if(B&&"white"===r||!B&&"black"===r){if(be(),Se(),O=t,ye(e),T=[...$e(n)],T=Ze(T,n,r,c),T=[...new Set(T)],"king"===c){const e=Qe(n,r),t="white"===r?1:8,o="white"===r?A:x,c=tt(r),i=nt(r);let l=!1,s=!1;if(c){let e=["f"];"chess960"===C&&(e=d(o,"g")),e.forEach((e=>{l||(l=Qe(`${e}${t}`,r))})),l||"chess960"!==C||("f"!==o.charAt(0)&&(T=T.filter((e=>e!==`g${t}`))),T.push(I?.kingRookFile+t))}if(i){let e=["d"];"chess960"===C&&(e=d("c",o)),"b"===o.charAt(0)&&e.push("b"),e.forEach((e=>{s||(s=Qe(`${e}${t}`,r))})),s||"chess960"!==C||(["b","d"].includes(o.charAt(0))||(T=T.filter((e=>e!==`c${t}`))),T.push(I?.queenRookFile+t))}e&&(c||i)?T=T.filter((e=>!Y.includes(e))):(l&&(T=T.filter((e=>e!==`g${t}`))),s&&(T=T.filter((e=>e!==`c${t}`))))}T.forEach((e=>{const{color:t}=Ce(e);let n=t&&t!==r;"king"===c&&Y.includes(e)&&!ot(r)&&(n=!0,"chess960"===C&&rt(t,e)&&(n=!1)),function(e,t=!1){const n=document.getElementById(e);if(n.querySelector(`.${ne}`))return;const o=document.createElement("div");o.classList.add(ne),n.appendChild(o),t&&o.classList.add(oe)}(e,n)}))}}function ge(e){if(O){const e=O;e.classList.add("dragging"),document.body.append(e)}}function ye(e){if(!O)return;const t=document.querySelector(".square"),n=O;let o=t.getBoundingClientRect().width,r=t.getBoundingClientRect().height;n.style.width=`${o}px`,n.style.height=`${r}px`;o=e.clientX-o/2,r=e.clientY-r/2,n.style.left=`${o}px`,n.style.top=`${r}px`}function ve(e){ie(),document.getElementById(N).append(O),O.classList.remove("dragging"),O=null,document.querySelectorAll(`.${ne}`).forEach((e=>e.remove())),document.querySelectorAll(`.${Z}`).forEach((e=>e.classList.remove(Z)))}function Ee(t,n,o=!1){let c=null;o&&3===n.length&&(c=n.slice(2,3),n=n.slice(0,2));const i=t,l=n,s=document.getElementById(l),{pieceId:a,pieceType:d,color:u}=Ce(i),{color:m,pieceType:p,pieceId:h}=Ce(l),g=document.getElementById(a);o&&T.push(n);const v=i===l,E=!T.includes(l);if(v||E)return document.getElementById(i).appendChild(g),T=[],void(i!==l&&e("illegal"));let k,w=null;if("king"===d){let e=!1;if("chess960"!==C||l.charAt(0)!==I?.queenRookFile&&l.charAt(0)!==I?.kingRookFile||(e=!0),Qe(l,u)&&!e)return;if(Y.includes(l)&&!ot(u)){const e=()=>{!function(e,t){const n="white"===e?1:8;let o=null,r=null,c="g",i="c";"chess960"===C&&(c=I?.kingRookFile,i=I?.queenRookFile);if(t===`${c}${n}`){let e="h";"chess960"===C&&(e=I?.kingRookFile),o=`${e}${n}`,r=`f${n}`}if(t===`${i}${n}`){let e="a";"chess960"===C&&(e=I?.queenRookFile),o=`${e}${n}`,r=`d${n}`}const{pieceId:l}=Ce(o),s=document.getElementById(l);document.getElementById(r).append(s),Le(M,o,r),ke(o,r)}(u,l),k=!0};"chess960"===C?(w=Ce(i)?.pieceId,m===u&&"rook"===p&&(rt(m,l)||e())):e()}"white"===u?A=l:x=l}let b=!1;if(m)if(k&&"chess960"===C);else{if(m===u)return;{const e=s.querySelector(".piece");e.removeEventListener("pointerdown",he),e.removeEventListener("pointermove",ge),s.removeChild(e),b=!0}}if(_===l&&(!function(e){if(!_)return;const t="white"===e?-1:1,n=+_[1]+t,o=Ce(`${_[0]}${n}`);let r=document.getElementById(o.squareId).querySelector(".piece");r&&(r.remove(),r.removeEventListener("pointerdown",he),r.removeEventListener("pointermove",ge));r=document.getElementById(o.pieceId),r&&(r.remove(),r.removeEventListener("pointerdown",he),r.removeEventListener("pointermove",ge));o.color=null,o.pieceId=null,o.pieceType=null}(u),b=!0),!g)throw new Error(`[CHESS_ERROR] Unable to move piece with id (${a}) positioned at squareId: ${i}`);let S,q=null;if("chess960"===C&&k){const[e,t]=l.split("");if(e===I?.kingRookFile.charAt(0)?q=document.getElementById(`g${t}`):e===I?.queenRookFile.charAt(0)&&(q=document.getElementById(`c${t}`)),!q)throw new Error("[CHESS_ERROR] Unable to find castling square for Chess960");q.append(g),Le(M,i,q.id),o||ke(i,q.id)}else s.appendChild(g);if(o&&ke(i,l),k&&"chess960"===C){const e=M.find((e=>e.squareId===q.id));e.color=u,e.pieceId=w,e.pieceType="king";const t="g"===q.id.charAt(0)?"f":"d",n="white"===u?1:8,o=M.find((e=>e.squareId===t+n));o.color=u,o.pieceId=h,o.pieceType="rook","white"===u?A=q.id:x=q.id}else Le(M,i,l);if(T=[],_=null,"pawn"===d){const e="white"===u?2:7,t="white"===u?2:-2,n="white"===u?3:6;+i[1]===e&&+l[1]===e+t&&(_=`${l[0]}${n}`)}if("pawn"===d){const e="white"===u&&8==+l[1],t="black"===u&&1==+l[1];(e||t)&&(S="pending")}let L=l;if(k&&"chess960"===C&&(L=q.id),H.push({from:i,to:L,color:u,pieceType:d,hasCapture:b,castle:k,promotion:S}),J.push(t+n),kt(),e(k?"castle":b?"capture":"move"),qe(i,L),S)return o?(ct(c),void setTimeout((()=>{it(u,f[c],l),lt(o)}),250)):(U=!1,void function(e){if(e.length>2)throw new Error("[CHESS_ERROR] Invalid square id. Unable to promote.");const{color:t}=Ce(e),n="white"===t?8:1;if(8!==n&&1!==n)return!1;if("white"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote white with squareId: ${e}`);if("black"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote black with squareId: ${e}`);const o=document.createElement("div"),c=document.createElement("div");o.classList.add("promotion-container"),c.classList.add("promotion-content"),o.append(c);let i=["Q","R","B","N"];"black"===t&&(i=i.map((e=>e.toLowerCase())));const l=document.getElementById(e);if(!l)throw new Error("[CHESS_ERROR] Board square was not found");const s=.95*l.getBoundingClientRect().height;i.forEach(((n,i)=>{const l=document.createElement("div"),a=document.createElement("img");a.src=r[n],a.alt=n,a.height=s,a.width=s,l.addEventListener("click",(()=>{it(t,f[n.toLowerCase()],e),o.remove(),ct(n),U=!0;const{from:r,to:c}=H[H.length-1];It(r,c),lt()})),l.classList.add("promotion-square"),l.append(a),c.append(l),1===i&&c.append(document.createElement("br"))}));const a=document.querySelector(".board");if(!a)throw new Error("[CHESS_ERROR] Board was not found");a.append(o)}(l));y&&Rt()&&!o&&!S&&It(i,l),lt(o)}function ke(e,t){const n=document.getElementById(t),o=document.getElementById(e);if(!n||!o)return;const r=n.querySelector(".piece");if(!r)return;let c=o.getBoundingClientRect().top,i=o.getBoundingClientRect().left;const l=o.getBoundingClientRect().width,s=n.getBoundingClientRect().top,a=n.getBoundingClientRect().left,d=r.style.transition,u=r.style.position,m=r.style.zIndex;r.style.position="fixed",r.style.zIndex="1000",r.style.top=c+"px",r.style.left=i+"px",r.style.height=l+"px",r.style.width=l+"px";let p=a-i,f=s-c;r.style.transition="transform 250ms ease-in-out",r.style.transform=`translate(${p}px, ${f}px)`,setTimeout((()=>{r.style.transition=d,r.style.transform="translate(0,0)",r.style.position=u,r.style.zIndex=m,r.style.top="auto",r.style.left="auto"}),250)}function we(){document.querySelectorAll(`.${ee}`).forEach((e=>{e.remove()}))}function be(){const e=document.getElementsByClassName(ne);for(;e.length>0;)e[0].remove()}function Se(){document.querySelectorAll(`.${Z}`).forEach((e=>e.classList.remove(Z)))}function qe(e,t){we();const n=document.getElementById(e),o=document.getElementById(t),r=document.createElement("div"),c=document.createElement("div");r.classList.add(ee),c.classList.add(ee),n.appendChild(r),o.appendChild(c)}function Ce(e,t=M){const n=t.find((t=>t.squareId===e));if(!n)throw new Error(`[CHESS_ERROR] Square with squareId "${e}" was not found`);return n}function Le(e,t,n){const o=e.findIndex((e=>e.squareId===t)),r=e.findIndex((e=>e.squareId===n)),c=e[o];e[r]={...c,squareId:n},c.color=null,c.pieceId=null,c.pieceType=null}function Ie(e){return[e.charAt(0),+e.charAt(1)]}function $e(e,t=M){const{pieceId:n,color:o,pieceType:r}=Ce(e);if(!n)throw new Error(`[CHESS_ERROR] No piece identified at squareId: ${e}`);switch(r){case"pawn":return function(e,t,n=M){return[...Be(e,t,n),...Ae(e,t,n)]}(e,o,t);case"knight":return xe(e,o,t);case"rook":return Te(e,o,t);case"bishop":return Me(e,o,t);case"queen":return Fe(e,o,t);case"king":return Ne(e,o,t);default:throw new Error("[CHESS_ERROR] Unknown piece type")}}function Re(e,t){return e.filter((e=>e.color===t)).flatMap((({squareId:t,color:n,pieceType:o})=>Ze($e(t,m(e)),t,n,o)))}function Be(e,t,n=M){const[o,r]=Ie(e),c=[];let i=o,l=r,s=e;if(l+="white"===t?1:-1,l>8||l<1)return c;const a=[-1,1];for(const e of a)if(i=String.fromCharCode(o.toLowerCase().charCodeAt(0)+e),i>="a"&&i<="h"){s=`${i}${l}`;const{color:e}=Ce(s,n);e&&e!==t&&c.push(s),e||s!==_||c.push(s)}return c}function Ae(e,t,n=M){const[o,r]=Ie(e),c=[];let i=o,l=r;l+="white"===t?1:-1;let s=`${i}${l}`,a=Ce(s,n);return a.pieceId?c:(c.push(s),"white"===t&&2===r&&l++,"black"===t&&7===r&&l--,s=`${i}${l}`,a=Ce(s,n),a.pieceId||c.push(s),c)}function xe(e,t,n=M){return[...Ke(e,t,[[-1,2],[1,2],[-2,1],[2,1],[-2,-1],[2,-1],[-1,-2],[1,-2]],n)]}function Te(e,t,n=M){const o=Ie(e);return[...Pe(o,t,n),...Ue(o,t,n),...He(o,t,n),..._e(o,t,n)]}function Me(e,t,n=M){const o=Ie(e);return[...We(o,t,n),...je(o,t,n),...De(o,t,n),...ze(o,t,n)]}function Fe(e,t,n=M){const o=Ie(e);return[...Pe(o,t,n),...Ue(o,t,n),...He(o,t,n),..._e(o,t,n),...We(o,t,n),...je(o,t,n),...De(o,t,n),...ze(o,t,n)]}function Ne(e,t,n=M){const o="white"===t?1:8,r=[];return tt(t,n)&&r.push(`g${o}`),nt(t,n)&&r.push(`c${o}`),[...Ke(e,t,[[-1,1],[0,1],[1,1],[-1,-1],[0,-1],[1,-1],[-1,0],[1,0]],n),...r]}function Oe({file:e,rank:t,color:n,legalSquares:o},r=M){const c=e+t,{color:i}=Ce(c,r);return(!i||i!==n)&&(o.push(c),!i||i===n)}function Pe(e,t,n=M){const o=e[0];let r=e[1];const c=[];for(;r<8;){r++;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Ue(e,t,n=M){const o=e[0];let r=e[1];const c=[];for(;r>1;){r--;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function He(e,t,n=M){let o=e[0];const r=e[1],c=[];for(;o<"h";){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e);if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function _e(e,t,n=M){let o=e[0];const r=e[1],c=[];for(;o>"a";){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e);if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function We(e,t,n=M){let[o,r]=e;const c=[];for(;o<"h"&&r<8;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r++;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function je(e,t,n=M){let[o,r]=e;const c=[];for(;o>"a"&&r>1;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r--;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function De(e,t,n=M){let[o,r]=e;const c=[];for(;o>"a"&&r<8;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r++;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function ze(e,t,n=M){let[o,r]=e;const c=[];for(;o<"h"&&r>1;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r--;if(!Oe({file:o,rank:r,color:t,legalSquares:c},n))break}return c}function Ke(e,t,n,o=M){const[r,c]=Ie(e),i=[];let l=r,s=c;return n.forEach((([e,n])=>{l=String.fromCharCode(r.charCodeAt(0)+e),s=c+n;if(l<"a"||l>"h"||s>8||s<1)return;const a=l+s,{color:d}=Ce(a,o);t!==d&&i.push(a)})),i}function Qe(e,t,n=M){for(const o of Te(e,t,n)){const{pieceType:e,color:r}=Ce(o,n);switch(e){case"rook":case"queen":if(t!==r)return!0}}for(const o of Me(e,t,n)){const{pieceType:e,color:r}=Ce(o,n);switch(e){case"bishop":case"queen":if(t!==r)return!0}}for(const o of xe(e,t,n)){const{pieceType:e,color:r}=Ce(o,n);if("knight"===e)if(t!==r)return!0}for(const o of Ne(e,t,n)){const{pieceType:e,color:r}=Ce(o,n);if("king"===e)if(t!==r)return!0}for(const o of Be(e,t,n)){const{pieceType:e,color:r}=Ce(o,n);if("pawn"===e)if(t!==r)return!0}return!1}function Ge(){const t=B?A:x,n=B?x:A,o=B?"white":"black",r=m(M);if(!Qe(t,o,r))return!1;if(Re(r,o).length>0)return!1;if(Ve(),Ye(t,!0),Je(t),Je(n,"💎"),U=!1,y&&v){const e=B?v.black.rid:v.white.rid;St(h,{type:"c.play.checkmate",data:e}),v.status="finished",Tt()}return Ft(),e("gameEnd"),!0}function Je(e,t="💢"){const{color:n}=Ce(e),r=document.getElementById(e);if("💢"===t&&o.includes("pink")&&(t="❤️"),!e)throw new Error(`[CHESS_ERROR] Unable to insert checkmate emblem in squareId: ${e}`);const c=document.createElement("div"),i=document.createElement("div"),l=.45*r.getBoundingClientRect().height;c.classList.add("checkmate-container"),i.textContent=t,i.classList.add("checkmate"),i.classList.add(n),i.style.height=l+"%",i.style.width=l+"%",c.append(i),r.append(c)}function Ve(e=null){const t=document.getElementById(e);if(e&&t){const e=t.querySelector(".checkmate-container");if(!e)return;e.remove()}else document.querySelectorAll(".checkmate-container").forEach((e=>{e.remove()}));document.querySelectorAll(".bloody-check").forEach((e=>e.remove()))}function Xe(e,t){const n=["😱","😨","🥵","😡","😤"].filter((e=>e!==X)),o=Math.floor(Math.random()*n.length),r=t??n[o];Ve(e),Je(e,r),X=r}function Ye(e,t=!1){const n=document.getElementById(e);if(n)if(n.querySelectorAll(".bloody-check").forEach((e=>e.remove())),t){const e=n.querySelector(".piece");e&&e.classList.add("bloody-checkmate")}else{const e=document.createElement("div");n.prepend(e),e.classList.add("bloody-check")}}function Ze(e,t,n,o){const r=B?A:x,c=m(M);let i=[...e];return i=[...new Set(i)],i.forEach((i=>{const l=m(c);Le(l,t,i),"king"!==o&&Qe(r,n,l)&&(e=e.filter((e=>e!==i))),"king"===o&&Qe(i,n,l)&&(e=e.filter((e=>e!==i)))})),e}function et({e:e,fileTrack:t,rank:n,castleType:o}){let r=e.squareId===t+n&&e.pieceId&&"king"!==e.pieceType;return r&&"rook"===e.pieceType&&"chess960"===C?"short"===o&&e.squareId!==I?.kingRookFile+n||"long"===o&&e.squareId!==I?.queenRookFile+n:r}function tt(e,t=M){const n="white"===e?1:8,o="white"===e?A:x;let r=d("f","g"),c="h";"chess960"===C&&(c=I?.kingRookFile,r=d(o.charAt(0),"g"),r.includes("f")||r.push("f"));return!(r.map((e=>t.find((t=>et({e:t,fileTrack:e,rank:n,castleType:"short"}))))).some((e=>!!e))||ot(e)||rt(e,`${c}${n}`,t))}function nt(e,t=M){const n="white"===e?1:8,o="white"===e?A:x;let r=d("b","d"),c="a";"chess960"===C&&(c=I?.queenRookFile,r=d("c",o.charAt(0)),r.includes("d")||r.push("d"),"a"===c&&r.push("b"));return!(r.map((e=>t.find((t=>et({e:t,fileTrack:e,rank:n,castleType:"long"}))))).some((e=>!!e))||ot(e)||rt(e,`${c}${n}`,t))}function ot(e){return!!H.find((t=>t.color===e&&"king"===t.pieceType))}function rt(e,t,n=M){const o=n.find((n=>n.squareId===t&&n.color===e&&"rook"===n.pieceType)),r=H.find((n=>n.color===e&&n.from===t&&"rook"===n.pieceType));return!o||r}function ct(t){const n=H.find((e=>"pending"===e.promotion));if(!n)throw new Error("[CHESS_ERROR] Unable to find promotion move state");n.promotion=t.toUpperCase(),kt(),e("promote")}function it(e,t,n){const o=document.getElementById(n);if(!o)throw new Error(`[CHESS_ERROR] Unable to create piece at ${n}`);const c=o.querySelector(".piece");c&&(c.removeEventListener("pointerdown",he),c.removeEventListener("pointermove",ge),c.remove());const i=p(),l=document.createElement("div");l.classList.add("piece"),l.classList.add(t.toLowerCase()),l.dataset.color=e,l.id=i,l.addEventListener("pointerdown",he),l.addEventListener("pointermove",ge);let s=t[0].toLowerCase();"knight"===t&&(s="n");const a=document.createElement("img");a.alt=s,s="white"===e?s.toUpperCase():s.toLowerCase(),a.src=r[s],l.append(a),o.append(l);const d=Ce(n);d.pieceId=i,d.pieceType=t,d.color=e}function lt(t=!1){!function(e=500){setTimeout((()=>{re&&dt()}),e)}(),Ve(),B=!B,G.push(function({color:t,castle:n,from:o,to:r,pieceType:c,hasCapture:i,promotion:l},s){const a=r[0];let d="";n&&("g"===a&&(d="O-O"),"c"===a&&(d="O-O-O"));const u=()=>{if("king"===c)return;const e=M.filter((e=>e.color===t&&e.pieceType===c&&e.squareId!==o));for(let n=0;n<e.length;n++){const i=e[n].squareId;let l=[];const s="white"===t?"black":"white";if("knight"===c?l=xe(i,s):"bishop"===c?l=Me(i,s):"rook"===c?l=Te(i,s):"queen"===c&&(l=Fe(i,s)),l.includes(r)){const e=o.charAt(0)===i.charAt(0);d+=e?o.charAt(1):o.charAt(0);break}}};if("pawn"===c)d+="";else{let e=c.charAt(0).toUpperCase();"knight"===c&&(e="N"),n||(d+=e),u()}i&&("pawn"===c&&(d+=o.charAt(0)),d+="x");n||(d+=r);l&&(d+="="+l);const m="white"===t?"black":"white";let p="white"===m?A:x;Ge()?s>=0&&s===H.length&&(d+="#"):Qe(p,m)&&(d+="+",s===H.length&&(e("check"),Xe(p),Ye(p)));return ht(s,d,t),d}(H[H.length-1],H.length));const n="white"===j&&B,o="black"===j&&!B,r=st();F.push(r),$=r.split(" "),R=$[0],y&&!t&&St(h,{type:"c.state.fenpgn",data:[r,G[G.length-1]]});const c=document.querySelector(".fen");c&&(c.textContent=r);let i=!1,l=!1,s=!1,a=!1;(function(){const e=e=>e.split(" ").slice(0,4).join(" ");return F.some((t=>{const n=e(t);return F.filter((t=>e(t)===n)).length>=3}))})()&&(Je(A,"🤝"),Je(x,"🤝"),s=!0),function(e=F[F.length-1]){const t=e.split(" ")[0],n=t.split("").filter((e=>"B"===e)).length,o=t.split("").filter((e=>"b"===e)).length,r=t.split("").filter((e=>"N"===e)).length,c=t.split("").filter((e=>"n"===e)).length,i=t.split("").filter((e=>"Q"===e)).length,l=t.split("").filter((e=>"q"===e)).length,s=t.split("").filter((e=>"R"===e)).length,a=t.split("").filter((e=>"r"===e)).length,d=t.split("").filter((e=>"P"===e)).length,u=t.split("").filter((e=>"p"===e)).length;if(i+l+s+a+d+u>0)return!1;if(r+c>1)return!1;if(n+o>1)return!1;if((n>0||o>0)&&r+c>0)return!1;return!0}()&&(Ve(),Je(A,"🤝"),Je(x,"🤝"),U=!1,i=!0,a=!0);const d=Ge(),u=function(){const e=B?A:x,t=B?x:A,n=B?"white":"black",o=m(M);return!Qe(e,n,o)&&!(Re(o,n).length>0||(Ve(),Je(e,"❓"),Je(t,"😨"),U=!1,0))}();i||!d&&!u||(l=!0,u&&(a=!0)),!l&&at()>=100&&(Je(A,"🥵"),Je(x,"🥵"),a=!0),l||ut(D&&(n||o)),s&&y?(V=!0,yt.style.display="block"):(V=!1,yt.style.display="none"),a&&At()}function st(e=M){let t="",n=8,o=0;const r=()=>{t=t.replace(/\*+/g,o),o=0};for(;n>=1;){for(let i="a";i<="h";c=i,i=String.fromCharCode(c.charCodeAt(0)+1)){const c=i+n,l=e.find((e=>e.squareId===c));if(!l)throw new Error(`[CHESS_ERROR] Unable to generate FEN due to missing squareId: ${c}`);const{color:s,pieceType:a}=l;if(a){let e="knight"===a?"n":a.charAt(0).toLowerCase();r(),t+="white"===s?e.toUpperCase():e}else t+="*",o++}r(),n>1&&(t+="/"),n--}var c;t+=B?" w ":" b ";let i="",l="h",s="a";"chess960"===C&&(l=I?.kingRookFile,s=I?.queenRookFile),ot("white")||rt("white",`${l}1`)||(i+="K"),ot("white")||rt("white",`${s}1`)||(i+="Q"),ot("black")||rt("black",`${l}8`)||(i+="k"),ot("black")||rt("black",`${s}8`)||(i+="q"),i||(i="-"),t+=i+" ",t+=(_||"-")+" ";const a=at();t+=a+" ";const d=Math.floor(H.length/2)+1;return t+=d,t}function at(){let e=0;for(let t=0;t<H.length;t++)e++,(H[t].hasCapture||"pawn"===H[t].pieceType||H[t].promotion)&&(e=0);return e}function dt(e){const t=document.querySelector(".eval.vertical");if(ce=!ce,void 0!==e&&(ce=e),ce?t?.classList.add("flip"):t?.classList.remove("flip"),le(),de(),se(),H.length){const{from:e,to:t}=H[H.length-1];qe(e,t)}if(Ve(),Se(),be(),P=null,G.length){G[G.length-1].includes("+")&&(B?(Xe(A,X),Ye(A)):(Xe(x,X),Ye(x)))}}function ut(e,t=F[F.length-1]){if(y)return;if(e&&(U=!1),t=t||L,e&&W.length){const{from:e,to:t}=H[H.length-1],{from:n,to:o}=W.splice(0,1)[0];if(n===e&&o===t){const e=W.splice(0,1)[0];if(e)return void setTimeout((()=>{Ee(e.from,e.to,!0),U=!0}),500)}}const n=document.getElementById("thinking");e&&n&&(n.style.display="inline-block"),function(e,t){const n=new Worker("./js/engine.js"),o=/score cp (-?\d+)/,r=/score mate (-?\d+)/,c=/ pv (.+)$/,i=/time (\d+)/,l=e.split(" ")[1];Q&&Q.terminate(),Q=n;let s=1e3*(parseInt(K)+1);n.onmessage=e=>{const a=e.data,d={success:!1,mate:null,evaluation:null,continuation:""};if(a.includes("info depth")&&a.includes(" pv ")){if(a.includes(`info depth ${z}`)&&(n.terminate(),Q=null),o.test(a)){const e=o.exec(a)[1];d.evaluation=parseInt(e)/100}if(r.test(a)&&(d.mate=r.exec(a)[1],d.evaluation=null),c.test(a)&&(d.continuation=c.exec(a)[1]),"b"===l&&(d.evaluation&&(d.evaluation*=-1),d.mate&&(d.mate*=-1)),(d.mate||d.evaluation||d.continuation)&&(d.success=!0,ft(d.evaluation,d.mate)),a.includes(`info depth ${z}`)&&t(d),K>=0&&i.test(a)){const e=i.exec(a)[1],n=s;parseInt(e)>=n&&t(d)}}},n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),"chess960"===C&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`);let a=`go depth ${z}`;K>-1&&(a+=` movetime ${s}`),n.postMessage(a)}(t,(t=>{mt(t,e)}))}function mt(e,t){if(!e.success)throw new Error("SF failed");if(ft(e.evaluation,e.mate),!t)return;var n;U=!0,thinking&&(thinking.style.display="none"),n=e.continuation,e.mate,W=n.split(" ").map((e=>({from:e.slice(0,2),to:e.slice(2,5)})));const o=W.splice(0,1);if(!o.length)throw new Error("[SF_ERROR] No more moves found");const{from:r,to:c}=o[0];Ee(r,c,!0)}t(r,n,(e=>{K=e})),"chess960"===C&&wt(),le(),ae(),de(),se(),F.push(st()),document.getElementById("btnAutoFlip").addEventListener("click",(e=>{re=!re,re?e.target.classList.add("glow"):e.target.classList.remove("glow")})),document.getElementById("btnReset").addEventListener("click",(e=>{y||(document.querySelectorAll(".piece").forEach((e=>e.remove())),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),ae(),"standard"===C?(B=!0,$=L.split(" "),R=$[0],de()):"chess960"===C&&wt(),F.push(st()),we(),Se(),be(),Ve(),D=!1,document.getElementById("thinking").style.display="none",document.getElementById("btnVsBot")?.classList.remove("glow"),Q&&(Q.terminate(),Q=null),ut(),document.getElementById("opening-name").textContent="",ce&&re&&dt(!1))})),document.getElementById("btnFlip").addEventListener("click",(()=>{dt()})),document.getElementById("btnVsBot").addEventListener("click",(e=>{y||(D=!D,U&&(D?(e.target.classList.add("glow"),j=B?"white":"black",U=!1,ut(!0),P&&(P=null,Se(),be())):e.target.classList.remove("glow")))})),document.getElementById("btnUndo").addEventListener("click",(t=>{if(y||!H.length)return;let n=H.length,o=F.length,r=J.length,c=G.length;const i=H[n-1],{from:l,to:s,promotion:a}=i;if("pending"===a)return void e("illegal");U=!0,P&&(Se(),be(),P=null),D&&(Q&&Q.terminate(),document.getElementById("thinking").style.display="none"),we(),Ve(),o--,F.splice(o,1);const d=F[o-1];$=d.split(" "),R=$[0],_=$[3],B=!$[1]||"w"===$[1],M=[],de(),ke(s,l),n--,H.splice(n,1);const u=c;c--,G.splice(c,1);const m=Math.floor(c/2)+1,p=document.querySelector(`.pgn-row:nth-child(${m})`);if(u%2==0?p.querySelector(".pgn-col:nth-child(3)").textContent="":p.remove(),G[c-1]?.includes("+")&&Ye(B?A:x),r--,J.splice(r,1),kt(),ut(),H.length){const e=H[n-1];qe(e.to,e.from)}re&&setTimeout(dt,300)}));const pt=document.getElementById("btnRematch");function ft(e,t){null===e&&null!==t&&(e=t>0?z:-1*z);let n=50-e/z*100;n=Math.min(n,98),n=Math.max(n,2);const o=document.querySelector(".eval.vertical .bar"),r=document.querySelector(".eval.vertical .num"),c=document.querySelector(".eval.horizontal .bar"),i=document.querySelector(".eval.horizontal .num");if(o&&(o.style.height=n+"%"),c&&(c.style.width=n+"%"),r){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),r.textContent=n,e>0?r.classList.add("w"):r.classList.remove("w")}if(i){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),i.textContent=n,e>0?i.classList.add("w"):i.classList.remove("w")}}function ht(e,t,n){const o=document.querySelector(".pgn");if(o){let r=Math.floor(e/2)+1;"black"===n&&e%2==0&&(r=Math.max(r-1,1));let c=null,i=null,l=null,s=document.createElement("button");if(document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),"white"===n){c=document.createElement("div"),i=document.createElement("div"),l=document.createElement("span"),l.textContent=r+".",c.append(l),c.append(i);const e=document.createElement("div");e.classList.add("pgn-col"),c.append(e)}else i=document.querySelector(`.pgn-row:nth-child(${r}) .pgn-col:last-child`);s.textContent=t,c&&(c.classList.add("pgn-row"),o.append(c)),i.classList.add("pgn-col"),s.classList.add("active"),i.append(s)}if(e===H.length){const e=document.querySelector(".pgn-container");e&&(e.scrollTop=e.scrollHeight)}}pt.addEventListener("click",(e=>{pt.style.display="none",y&&v&&("finished"!==v.status&&"closed"!==v.status||St(h,{type:"c.rematch.request"}))})),pt.style.display="none",document.getElementById("btnCopyFenPGN").addEventListener("click",(()=>{let e=function(e=G){let t=Et();for(let n=0;n<e.length;n++){const o=Math.floor(n/2)+1;n%2==0&&(t+=o+". "),t+=e[n]+" "}return t}();navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard")}));const gt=document.getElementById("btnCopyFenPGNALL");gt.addEventListener("click",(()=>{let e="";y&&v.pgnArchive?.length&&(e=function(e){let t="";return e.forEach((e=>{const n=e.rawPgn,{round:o,white:r,black:c,result:i,termination:l,fen:s}=e;let a=Et({round:o,white:r,black:c,result:i,termination:l,fen:s});for(let e=0;e<n.length;e++){const t=Math.floor(e/2)+1;e%2==0&&(a+=t+". "),a+=n[e]+" "}t+=a+"\n\n"})),t}(v.pgnArchive),navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard"))})),gt.style.display="none";const yt=document.getElementById("btnDraw");yt.addEventListener("click",(()=>{y&&"ongoing"===v?.status&&V&&confirm("Are you sure want to offer draw?")&&function(){const e=qt();e&&[v.black.rid,v.white.rid].includes(e)&&St(h,{type:"c.draw.offer",data:qt()})}()})),yt.style.display="none";const vt=document.getElementById("btnResign");function Et(e){const t=e?.event??"?",n=e?.site??window.location.hostname,o=e?.date??l(),r=e?.round??"?",c=e?.white??"?",i=e?.black??"?",s=e?.result??"?",a=e?.fen??L,d=e?.termination;let u=`[Event "${t}"]\n`;return u+=`[Site "${n}"]\n`,u+=`[Date "${o}"]\n`,u+=`[Round "${r}"]\n`,u+=`[White "${c}"]\n`,u+=`[Black "${i}"]\n`,u+=`[Result "${s}"]\n`,u+=`[FEN "${a}"]\n`,d&&(u+=`[Termination "${d}"]\n`),u+"\n"}function kt(){let e=!1;const t=H.map((t=>{let n=t.from+t.to;return t.promotion&&("pending"!==t.promotion?n+=t.promotion:e=!0),n})).join(",");if(e)return;const n=document.getElementById("opening-name");n&&"chess960"!==C&&fetch(`https://explorer.lichess.ovh/masters?play=${t}`).then((e=>e.json())).then((e=>{const t=e?.opening?.name;t?n.innerHTML=t.replace(": ",":<br />"):n.textContent=""}))}function wt(e=""){C="chess960";const t=i(e);return L=t.fen,$=L.split(" "),R=$[0],B=!$[1]||"w"===$[1],A=t.whiteKingSquareId,x=t.blackKingSquareId,Y=[`${t.kingRookFile}1`,`${t.kingRookFile}8`,`${t.queenRookFile}1`,`${t.queenRookFile}8`],I=t,de(),t}function bt(){St(h,{data:qt()??"anything",type:"c.connection.ping"})}function St(e,t){e.send(JSON.stringify(t))}function qt(){return localStorage.getItem("rid")}function Ct(){St(h,{type:"c.rid.register"})}function Lt(e){const{variant:t,boardState:n,moveState:o,fenState:r,rawPgn:c,white:i,black:l,status:a,scores:d,pgnArchive:u,time:m}=e;if(C=t,v=e,L=r[0],M=n,H=o,F=r,G=c,"chess960"===C&&wt(L),$=r[r.length-1].split(" "),R=$[0],B=!$[1]||"w"===$[1],de(),kt(),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col").forEach((e=>e.remove())),document.querySelectorAll("#btnReset").forEach((e=>e.remove())),document.querySelectorAll("#btnAutoFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnUndo").forEach((e=>e.remove())),document.querySelectorAll(".eval").forEach((e=>e.remove())),document.querySelector("aside").style.marginTop="1.5rem",gt.style.display="inline-block",o.length>=w&&(vt.style.display="inline-block"),E=i?.name||null,k=l?.name||null,_=$[3],qt()===l?.rid?dt(!0):dt(!1),G.forEach(((e,t)=>{const n=o[t].color;if(ht(t,e,n),t+1===o.length&&(e.includes("+")||e.includes("#"))){let t=null;"white"===n?t=x:"black"===n&&(t=A),Ye(t,e.includes("#")),e.includes("#")&&Je(t)}})),E&&k){const e=document.querySelector(".score .bottom span.name");e&&(e.textContent=ce?k:E);const t=document.querySelector(".score .top span.name");t&&(t.textContent=ce?E:k)}Bt(d),"waiting"!==a&&s(),"ongoing"===a||("finished"===a?(pt.style.display="block",vt.style.display="none",U=!1,xt(u[0])):"closed"===a&&(pt.style.display="none")),m?$t(e.time):function(){if(!y)return;const e=document.getElementById("app"),t=document.createElement("div");e.append(t),t.classList.add("form-time-container");[{logo:"🚀",name:"bullet",values:["1+0","1+2","2+1"]},{logo:"⚡",name:"blitz",values:["3+0","3+2","5+0"]},{logo:"⏲️",name:"rapid",values:["10+0","15+10","30+0"]}].forEach((({logo:e,name:n,values:o})=>{const r=document.createElement("div");t.append(r),r.classList.add(n);const c=document.createElement("span");c.textContent=e,r.append(c),o.forEach((e=>{const n=document.createElement("button"),[o,c]=e.split("+");r.append(n);let i=o;+c&&(i+="+"+c),n.textContent=i,n.addEventListener("click",(()=>{St(h,{type:"c.time.set",data:e}),t.remove()}))}))}))}()}function It(e,t){St(h,{type:"c.play.move",data:{from:e,to:t,moveState:H[H.length-1]}})}function $t(e){v.time=e;const t=document.querySelector(".form-time-container");t&&t.remove();let[n]=e.split("+");if(n=n.padStart(2,"0"),Tt(),["finished","closed"].includes(v.status))return;const o=document.querySelector(".score .bottom span.time"),r=document.querySelector(".score .top span.time");o&&(o.textContent=`${n}:00`,o.classList.add("active"),o.classList.remove("rush")),r&&(r.textContent=`${n}:00`,r.classList.add("active"),r.classList.remove("rush")),Tt(),"waiting"===v.status&&c()}function Rt(){const e=qt();if(!y||!v||!e)return!0;return(B?v.white?.rid:v.black?.rid)===e}function Bt(e){const t=document.querySelector(".score .bottom span:first-child"),n=e=>e.replace(/\b(\d+)\.(\d+)\b/g,((e,t,n)=>n?"0"===t?"½":`${t} ½`:e));t&&(t.textContent=ce?e[1]:e[0],t.textContent=n(t.textContent),ce?t.parentElement.classList.add("flip"):t.parentElement.classList.remove("flip"));const o=document.querySelector(".score .top span:first-child");o&&(o.textContent=ce?e[0]:e[1],o.textContent=n(o.textContent),ce?o.parentElement.classList.add("flip"):o.parentElement.classList.remove("flip")),"finished"===v.status&&document.querySelectorAll(".time").forEach((e=>e.classList.add("active")))}function At(){St(h,{type:"c.draw.accepted",data:!0}),U=!1}function xt(e){if(!/resign/i.test(e.termination))return;let t="";t=e.termination.split(" ")[0]===e.black?"white":"black";const n="white"===t?A:x;Je(n,"🚩"),Ye(n,!0)}function Tt(){if(!(v&&v.time&&v.moveState.length&&v.timeWhite&&v.timeBlack))return;S||u();const{timeWhite:e,timeBlack:t}=v;clearInterval(b);const n=e=>{e=Math.max(e,0);const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);let o=0;e<=1e4&&(o=Math.floor(e%1e3/100));const r=e=>e.toString().padStart(2,"0"),c=e<=1e4?"."+o:"";return`${r(t)}:${r(n)}${c}`},o=e=>`.score .${e} span.time`,r=(e,t)=>{t<=1e4?e.classList.add("rush"):e.classList.remove("rush")};if(["bottom","top"].forEach((c=>{const i=document.querySelector(o(c));let l=0;l="bottom"===c?ce?t.remaining:e.remaining:ce?e.remaining:t.remaining,i.textContent=n(l),r(i,l)})),"ongoing"!==v.status)return;const c=B?"white":"black";let i=null;i="white"===c?v.timeWhite:v.timeBlack;let l=((e,t)=>{if(!t)return e;return e-=Date.now()-t})(i.remaining,i.start);l<=0&&Mt(c);let s=1e3;const a=()=>{if(l-=s,"ongoing"===v.status&&l>0&&(l>=1e4?s=1e3:l<1e4&&90!==s&&(s=90,clearInterval(b),b=null),b||(b=setInterval(a,s))),l<=0)return void Mt(c);const e=n(l);let t="white"===c?"bottom":"top";const i=qt()===v.white.rid&&"white"===c,d=qt()===v.white.rid&&"white"!==c,u=qt()===v.black.rid&&"black"===c,m=qt()===v.black.rid&&"black"!==c;i||u?t="bottom":(d||m)&&(t="top");const p=document.querySelector(o(t));document.querySelectorAll(".time").forEach((e=>e.classList.remove("active"))),p&&(p.textContent=e,p.classList.add("active"),r(p,l))};b=setInterval(a,s)}function Mt(e){v.status="finished",U=!1,clearInterval(b),St(h,{type:"c.time.out",data:e})}function Ft(){o.includes("pink")?confettiHearts():confettis()}vt.addEventListener("click",(()=>{y&&"ongoing"===v?.status&&(v.moveState.length<w||confirm("Are you sure you want to resign?")&&(v.status="finished",vt.style.display="none",St(h,{type:"c.resign"})))})),vt.style.display="none"})();