import{playMoveSounds as e,playSound as t}from"./audio.js";import{renderSettings as n}from"./settings.js";import{changeBoardTheme as o,currentThemeName as r,imgPieceMapping as i}from"./themes.js";import{displayQRCode as c,generateChess960StartingPos as l,getDate as s,hideQRCode as a,isUppercase as d,letterRange as u,lock as m,simpleClone as h,uuid as p}from"./utils.js";(()=>{const f={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"},g=function(){const e={};return e.onopen=()=>{setInterval(Dt,8e3)},e.onclose=()=>{alert("Connection to server lost... reloading page."),window.location.reload()},e}();g.onmessage=({data:e})=>{!function(e){let n;try{n=JSON.parse(e)}catch(e){console.error(e)}if(!n)return;const{type:o,data:r}=n;switch(o){case"s.room.in":!function(e){if(v=e,v){document.getElementById("btnVsBot")?.remove(),document.getElementById("btnUndo")?.remove();const e=document.querySelector(".fen");e&&(e.style.display="none"),document.querySelectorAll(".score").forEach((e=>{e.style.display="flex"}))}Kt()?zt(g,{type:"c.name.get",data:Kt()}):Qt()}(r);break;case"s.room.share-info":Vt(r);break;case"c.rid.register":!function(e){localStorage.setItem("rid",e);const t=()=>{let e=prompt("Name");return e||(e=t()),/^[a-zA-Z ]{2,}$/.test(e.trim())||(alert("Name must be alphabet and contains at least 2 characters"),e=t()),e};y=t(),zt(g,{type:"c.name.set",data:{name:y,rid:Kt()}})}(r);case"c.name.get":!function(e){if(e)return void(y=e);Qt()}(r),function(){if(!v)return;zt(g,{type:"c.room.join",data:Kt()})}();break;case"c.play.move":!function(e){const{from:t,to:n,timeWhite:o,timeBlack:r}=e;be(t,n,!0),U.length>=b&&(bt.style.display="inline-block");o&&r&&(w.timeWhite=o,w.timeBlack=r,tn())}(r);break;case"c.play.checkmate":!function({scores:e,aPgnArchive:t}){w.status="finished",w.scores=e,w.pgnArchive.unshift(t),Yt(e),yt.style.display="block",bt.style.display="none",tn()}(r);break;case"c.rematch.request":!function(e){const t=confirm(`${e} wants to rematch. Do you ACCEPT?`);yt.style.display="none",!1===t&&(w.status="closed");zt(g,{type:"c.rematch.response",data:t})}(r);break;case"c.rematch.response":!function(e){if(!e||!1===e)return void alert("Rematch Declined");Ze(),me(),qe(),Vt(e),t("gameStart")}(r);break;case"c.resign":!function({message:e,scores:n,aPgnArchive:o}){en(o),j=!1,w.status="finished",w.scores=n,w.pgnArchive.unshift(o),Yt(n),bt.style.display="none",Et.style.display="none",t("gameEnd"),X&&_t();clearInterval(S),setTimeout((()=>{alert(e),yt.style.display="block"}),1e3)}(r);break;case"c.time.set":Jt(r);break;case"s.time.info":!function({timeWhite:e,timeBlack:t}){w.timeWhite=e,w.timeBlack=t,tn()}(r);break;case"c.time.out":!function({timeWhite:e,timeBlack:n,aPgnArchive:o,message:r,scores:i}){j=!1,w.status="finished",w.timeWhite=e,w.timeBlack=n,w.scores=i,w.pgnArchive.unshift(o),Yt(i),tn(),Lt(),t("gameEnd"),X&&_t();setTimeout((()=>{yt.style.display="block",bt.style.display="none",Et.style.display="none",alert(r),q&&q.release()}),500)}(r);break;case"c.draw.offer":confirm(`${r} offers a draw. Do you accept?`)?Zt():zt(g,{type:"c.draw.declined",data:!0});break;case"c.draw.declined":!function(e){alert(`${e} does not want to draw.`)}(r);break;case"c.draw.accepted":!function({timeWhite:e,timeBlack:n,aPgnArchive:o,message:r,scores:i}){j=!1,w.status="finished",w.timeWhite=e,w.timeBlack=n,w.scores=i,w.pgnArchive.unshift(o),Yt(i),tn(),Lt(),t("gameEnd"),setTimeout((()=>{yt.style.display="block",bt.style.display="none",Et.style.display="none",alert(r),q&&q.release()}),500)}(r);break;case"s.error":!function(e){console.error(e),alert(e),"object"==typeof e&&alert(JSON.stringify(e))}(r)}}(e)};let y=null,v=!1,w=null,k=null,E=null;const b=20;let S=null,q=null;let C=new URLSearchParams(window.location.search).get("v");!C||"chess960"!==C&&"960"!==C||(C="chess960");let L=C??"standard",I="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",$=null,R=I.split(" "),B=R[0],A=!R[1]||"w"===R[1],x="e1",T="e8",M=[],F=[],N=[],H=null,P=null,O=null,j=!0,U=[],_=null,W=[],D="black",z=!1;const K=25;let Q=localStorage.getItem("search-time")??1;isNaN(Q)?Q=1:+Q>9?Q=9:+Q<-1&&(Q=-1),localStorage.setItem("search-time",Q);let V=null,G=[],J=[],X=!1,Y=-1,Z=!1,ee=null,te=["g1","g8","c1","c8"];const ne="hl-hov-square",oe="hl-previous-move",re="hl-square",ie="hl-legal-squares",ce="hl-capture";let le=!1,se=!1;function ae(){document.querySelector(".board").removeEventListener("pointerleave",Ee);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].removeEventListener("pointermove",pe),e[t].removeEventListener("pointerout",fe),e[t].removeEventListener("pointerup",ge)}function de(){const e=document.getElementsByClassName("square");for(let t=se?63:0;se?t>=0:t<e.length;se?t--:t++){const n=se?1+Math.floor(t/8):8-Math.floor(t/8),o=se?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8);e[t].id=o+n}}function ue(){const e=document.getElementsByClassName("square"),t=e=>e.remove();document.querySelectorAll(".file").forEach(t),document.querySelectorAll(".rank").forEach(t);for(let t=se?63:0;se?t>=0:t<e.length;se?t--:t++){const n=se?1+Math.floor(t/8):8-Math.floor(t/8),o=se?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),r=e[t];if(t>=56&&t<=64){const e=document.createElement("div");e.classList.add("file"),r.prepend(e),e.textContent=o}if((t+1)%8==1){const e=document.createElement("div");e.classList.add("rank"),r.prepend(e),e.textContent=n}}}function me(){F=[],U=[],N=[],M=[],H=null,_=null,D="black",W=[],G=[],X=!1,J=[],Z=!1,P=null,O=null,j=!0,x="e1",T="e8","standard"===L&&(te=["g1","g8","c1","c8"])}function he(){const e=document.getElementsByClassName("square"),n=function(e){return e.replace(/\d/g,(e=>"1".repeat(+e)))}(B).split("/");for(let t=se?63:0;se?t>=0:t<e.length;se?t--:t++){const o=se?1+Math.floor(t/8):8-Math.floor(t/8),r=se?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),c=97-r.charCodeAt(0),l=e[t];l.id=r+o;let s="",a="",u="";const m=n[8-o].charAt(-c);if(isNaN(+m)?(s=d(m)?"white":"black",a=f[m.toLowerCase()],u=F.length===e.length?$e(l.id).pieceId:p(),"king"===a&&("white"===s&&(x=l.id),"black"===s&&(T=l.id))):(s=null,a=null,u=null),F.length<e.length&&F.push({squareId:l.id,color:s,pieceType:a,pieceId:u}),l.querySelectorAll(".piece").forEach((e=>{e.remove()})),u){const e=document.createElement("div");e.id=u,e.dataset.color=s,e.classList.add("piece"),e.classList.add(a),e.addEventListener("pointerdown",ve),e.addEventListener("pointermove",we);const t=document.createElement("img");t.src=i[m],t.alt=m,t.setAttribute("draggable",!1),e.appendChild(t),l.appendChild(e)}}const o=mt(),r=document.querySelector(".fen");r&&(r.textContent=o),U.length||t("gameStart")}function pe(e){if(!j||!P)return;ke(e),e.preventDefault();const t=e.target;2===t.id.length?t.classList.add(ne):t.parentElement.classList.add(ne)}function fe(e){j&&(e.preventDefault(),e.target.classList.remove(ne))}function ge(e){e.preventDefault(),ae();const t=e.currentTarget.id;if(P&&H===t&&M.length)return O=P,P.classList.remove("dragging"),document.getElementById(H).appendChild(P),function(e){const t=document.getElementById(e);t.querySelectorAll(`.${re}`).forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add(re),t.append(n)}(H),void(P=null);Le();P&&(P.classList.remove("dragging"),P=null,O=null,Ce(),be(H,t))}function ye(e){if(e.preventDefault(),!Xt())return;if(2===e.button)return;if(!O)return;document.querySelectorAll(`.${re}`).forEach((e=>e.remove()));const t=e.currentTarget.id;H!==t&&(document.querySelectorAll(".square").forEach((e=>{e.removeEventListener("pointerdown",ye)})),ae(),Le(),Ce(),O=null,M.includes(t)&&(be(H,t),Se(H,t)))}function ve(e){if(!j||X)return;if(2===e.button)return;if(!Xt())return;let t=e.target;de(),function(){document.querySelector(".board").addEventListener("pointerleave",Ee);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].addEventListener("pointermove",pe),e[t].addEventListener("pointerout",fe),e[t].addEventListener("pointerup",ge),e[t].addEventListener("pointerdown",ye)}();let n=t.parentElement.id,o=$e(n),r=o.color,i=o.pieceType;if(O){const e=O.parentElement.id,{color:c,pieceType:l}=$e(e);let s=!1;if("chess960"!==L||"king"!==l||"rook"!==i||r!==c||lt(r,n)||(s=!0,M.includes(n)||M.push(n),t=O,O=null,n=t.parentElement.id,o=$e(n),r=o.color,i=o.pieceType,document.querySelectorAll(`.${re}`).forEach((e=>e.remove()))),r!==c&&O.id!==t.id&&!s)return}H=n;if(A&&"white"===r||!A&&"black"===r){if(Ce(),Le(),P=t,ke(e),M=[...Ae(n)],M=nt(M,n,r,i),M=[...new Set(M)],"king"===i){const e=Je(n,r),t="white"===r?1:8,o="white"===r?x:T,i=rt(r),c=it(r);let l=!1,s=!1;if(i){let e=["f"];"chess960"===L&&(e=u(o,"g")),e.forEach((e=>{l||(l=Je(`${e}${t}`,r))})),l||"chess960"!==L||("f"!==o.charAt(0)&&(M=M.filter((e=>e!==`g${t}`))),M.push($?.kingRookFile+t))}if(c){let e=["d"];"chess960"===L&&(e=u("c",o)),"b"===o.charAt(0)&&e.push("b"),e.forEach((e=>{s||(s=Je(`${e}${t}`,r))})),s||"chess960"!==L||(["b","d"].includes(o.charAt(0))||(M=M.filter((e=>e!==`c${t}`))),M.push($?.queenRookFile+t))}e&&(i||c)?M=M.filter((e=>!te.includes(e))):(l&&(M=M.filter((e=>e!==`g${t}`))),s&&(M=M.filter((e=>e!==`c${t}`))))}M.forEach((e=>{const{color:t}=$e(e);let n=t&&t!==r;"king"===i&&te.includes(e)&&!ct(r)&&(n=!0,"chess960"===L&&lt(t,e)&&(n=!1)),function(e,t=!1){const n=document.getElementById(e);if(n.querySelector(`.${ie}`))return;const o=document.createElement("div");o.classList.add(ie),n.appendChild(o),t&&o.classList.add(ce)}(e,n)}))}}function we(e){if(P){const e=P;e.classList.add("dragging"),document.body.append(e)}}function ke(e){if(!P)return;const t=document.querySelector(".square"),n=P;let o=t.getBoundingClientRect().width,r=t.getBoundingClientRect().height;n.style.width=`${o}px`,n.style.height=`${r}px`;o=e.clientX-o/2,r=e.clientY-r/2,n.style.left=`${o}px`,n.style.top=`${r}px`}function Ee(e){ae(),document.getElementById(H).append(P),P.classList.remove("dragging"),P=null,document.querySelectorAll(`.${ie}`).forEach((e=>e.remove())),document.querySelectorAll(`.${ne}`).forEach((e=>e.classList.remove(ne)))}function be(e,n,o=!1){X&&_t();let r=null;o&&3===n.length&&(r=n.slice(2,3),n=n.slice(0,2));const c=e,l=n,s=document.getElementById(l),{pieceId:a,pieceType:d,color:u}=$e(c),{color:m,pieceType:h,pieceId:p}=$e(l),g=document.getElementById(a);o&&M.push(n);const y=c===l,w=!M.includes(l);if(y||w)return document.getElementById(c).appendChild(g),M=[],void(c!==l&&t("illegal"));let k,E=null;if("king"===d){let e=!1;if("chess960"!==L||l.charAt(0)!==$?.queenRookFile&&l.charAt(0)!==$?.kingRookFile||(e=!0),Je(l,u)&&!e)return;if(te.includes(l)&&!ct(u)){const e=()=>{st(u,l),k=!0};"chess960"===L?(E=$e(c)?.pieceId,m===u&&"rook"===h&&(lt(m,l)||e())):e()}"white"===u?x=l:T=l}let b=!1;if(m)if(k&&"chess960"===L);else{if(m===u)return;{b=!0;const e=s.querySelector(".piece");e.classList.add("fade-out"),e.removeEventListener("pointerdown",ve),e.removeEventListener("pointermove",we),setTimeout((()=>{s.removeChild(e)}),550)}}if(_===l&&(!function(e){if(!_)return;const t="white"===e?-1:1,n=+_[1]+t,o=$e(`${_[0]}${n}`);let r=document.getElementById(o.squareId).querySelector(".piece");r&&(r.remove(),r.removeEventListener("pointerdown",ve),r.removeEventListener("pointermove",we));r=document.getElementById(o.pieceId),r&&(r.remove(),r.removeEventListener("pointerdown",ve),r.removeEventListener("pointermove",we));o.color=null,o.pieceId=null,o.pieceType=null}(u),b=!0),!g)throw new Error(`[CHESS_ERROR] Unable to move piece with id (${a}) positioned at squareId: ${c}`);let S,q=null;if("chess960"===L&&k){const[e,t]=l.split("");if(e===$?.kingRookFile.charAt(0)?q=document.getElementById(`g${t}`):e===$?.queenRookFile.charAt(0)&&(q=document.getElementById(`c${t}`)),!q)throw new Error("[CHESS_ERROR] Unable to find castling square for Chess960");q.append(g),Re(F,c,q.id),o||Se(c,q.id)}else s.appendChild(g);if(o&&Se(c,l),k&&"chess960"===L){const e=F.find((e=>e.squareId===q.id));e.color=u,e.pieceId=E,e.pieceType="king";const t="g"===q.id.charAt(0)?"f":"d",n="white"===u?1:8,o=F.find((e=>e.squareId===t+n));o.color=u,o.pieceId=p,o.pieceType="rook","white"===u?x=q.id:T=q.id}else Re(F,c,l);if(M=[],_=null,"pawn"===d){const e="white"===u?2:7,t="white"===u?2:-2,n="white"===u?3:6;+c[1]===e&&+l[1]===e+t&&(_=`${l[0]}${n}`)}if("pawn"===d){const e="white"===u&&8==+l[1],t="black"===u&&1==+l[1];(e||t)&&(S="pending")}let C=l;if(k&&"chess960"===L&&(C=q.id),U.push({from:c,to:C,color:u,pieceType:d,hasCapture:b,castle:k,promotion:S}),J.push(e+n),qt(),t(k?"castle":b?"capture":"move"),Ie(c,C),S){if(o){J[J.length-1]+=r,at(r);return void setTimeout((()=>{dt(u,f[r],l),ut(o)}),b?555:250)}return j=!1,void function(e){if(e.length>2)throw new Error("[CHESS_ERROR] Invalid square id. Unable to promote.");const{color:t}=$e(e),n="white"===t?8:1;if(8!==n&&1!==n)return!1;if("white"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote white with squareId: ${e}`);if("black"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote black with squareId: ${e}`);const o=document.createElement("div"),r=document.createElement("div");o.classList.add("promotion-container"),r.classList.add("promotion-content"),o.append(r);let c=["Q","R","B","N"];"black"===t&&(c=c.map((e=>e.toLowerCase())));const l=document.getElementById(e);if(!l)throw new Error("[CHESS_ERROR] Board square was not found");const s=.95*l.getBoundingClientRect().height;c.forEach(((n,c)=>{const l=document.createElement("div"),a=document.createElement("img");a.src=i[n],a.alt=n,a.height=s,a.width=s,l.addEventListener("click",(()=>{if(dt(t,f[n.toLowerCase()],e),o.remove(),at(n),J[J.length-1]+=n.toLowerCase(),j=!0,v){const{from:e,to:t}=U[U.length-1];Gt(e,t)}ut()})),l.classList.add("promotion-square"),l.append(a),r.append(l),1===c&&r.append(document.createElement("br"))}));const a=document.querySelector(".board");if(!a)throw new Error("[CHESS_ERROR] Board was not found");a.append(o)}(l)}v&&Xt()&&!o&&!S&&Gt(c,l),ut(o)}function Se(e,t){const n=document.getElementById(t),o=document.getElementById(e);if(!n||!o)return;const r=n.querySelector(".piece:not(.fade-out)");if(!r)return;let i=o.getBoundingClientRect().top,c=o.getBoundingClientRect().left;const l=o.getBoundingClientRect().width,s=n.getBoundingClientRect().top,a=n.getBoundingClientRect().left,d=r.style.transition,u=r.style.position,m=r.style.zIndex;r.style.position="fixed",r.style.zIndex="1000",r.style.top=i+"px",r.style.left=c+"px",r.style.height=l+"px",r.style.width=l+"px";let h=a-c,p=s-i;r.style.transition="transform 250ms ease-in-out",r.style.transform=`translate(${h}px, ${p}px)`,setTimeout((()=>{r.style.transition=d,r.style.transform="translate(0,0)",r.style.position=u,r.style.zIndex=m,r.style.top="auto",r.style.left="auto"}),250)}function qe(){document.querySelectorAll(`.${oe}`).forEach((e=>{e.remove()}))}function Ce(){const e=document.getElementsByClassName(ie);for(;e.length>0;)e[0].remove()}function Le(){document.querySelectorAll(`.${ne}`).forEach((e=>e.classList.remove(ne)))}function Ie(e,t){qe();const n=document.getElementById(e),o=document.getElementById(t),r=document.createElement("div"),i=document.createElement("div");r.classList.add(oe),i.classList.add(oe),n.appendChild(r),o.appendChild(i)}function $e(e,t=F){const n=t.find((t=>t.squareId===e));if(!n)throw new Error(`[CHESS_ERROR] Square with squareId "${e}" was not found`);return n}function Re(e,t,n){const o=e.findIndex((e=>e.squareId===t)),r=e.findIndex((e=>e.squareId===n)),i=e[o];e[r]={...i,squareId:n},i.color=null,i.pieceId=null,i.pieceType=null}function Be(e){return[e.charAt(0),+e.charAt(1)]}function Ae(e,t=F){const{pieceId:n,color:o,pieceType:r}=$e(e);if(!n)throw new Error(`[CHESS_ERROR] No piece identified at squareId: ${e}`);switch(r){case"pawn":return function(e,t,n=F){return[...Te(e,t,n),...Me(e,t,n)]}(e,o,t);case"knight":return Fe(e,o,t);case"rook":return Ne(e,o,t);case"bishop":return He(e,o,t);case"queen":return Pe(e,o,t);case"king":return Oe(e,o,t);default:throw new Error("[CHESS_ERROR] Unknown piece type")}}function xe(e,t){return e.filter((e=>e.color===t)).flatMap((({squareId:t,color:n,pieceType:o})=>nt(Ae(t,h(e)),t,n,o)))}function Te(e,t,n=F){const[o,r]=Be(e),i=[];let c=o,l=r,s=e;if(l+="white"===t?1:-1,l>8||l<1)return i;const a=[-1,1];for(const e of a)if(c=String.fromCharCode(o.toLowerCase().charCodeAt(0)+e),c>="a"&&c<="h"){s=`${c}${l}`;const{color:e}=$e(s,n);e&&e!==t&&i.push(s),e||s!==_||i.push(s)}return i}function Me(e,t,n=F){const[o,r]=Be(e),i=[];let c=o,l=r;l+="white"===t?1:-1;let s=`${c}${l}`,a=$e(s,n);return a.pieceId?i:(i.push(s),"white"===t&&2===r&&l++,"black"===t&&7===r&&l--,s=`${c}${l}`,a=$e(s,n),a.pieceId||i.push(s),i)}function Fe(e,t,n=F){return[...Ge(e,t,[[-1,2],[1,2],[-2,1],[2,1],[-2,-1],[2,-1],[-1,-2],[1,-2]],n)]}function Ne(e,t,n=F){const o=Be(e);return[...Ue(o,t,n),..._e(o,t,n),...We(o,t,n),...De(o,t,n)]}function He(e,t,n=F){const o=Be(e);return[...ze(o,t,n),...Ke(o,t,n),...Qe(o,t,n),...Ve(o,t,n)]}function Pe(e,t,n=F){const o=Be(e);return[...Ue(o,t,n),..._e(o,t,n),...We(o,t,n),...De(o,t,n),...ze(o,t,n),...Ke(o,t,n),...Qe(o,t,n),...Ve(o,t,n)]}function Oe(e,t,n=F){const o="white"===t?1:8,r=[];return rt(t,n)&&r.push(`g${o}`),it(t,n)&&r.push(`c${o}`),[...Ge(e,t,[[-1,1],[0,1],[1,1],[-1,-1],[0,-1],[1,-1],[-1,0],[1,0]],n),...r]}function je({file:e,rank:t,color:n,legalSquares:o},r=F){const i=e+t,{color:c}=$e(i,r);return(!c||c!==n)&&(o.push(i),!c||c===n)}function Ue(e,t,n=F){const o=e[0];let r=e[1];const i=[];for(;r<8;){r++;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function _e(e,t,n=F){const o=e[0];let r=e[1];const i=[];for(;r>1;){r--;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function We(e,t,n=F){let o=e[0];const r=e[1],i=[];for(;o<"h";){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e);if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function De(e,t,n=F){let o=e[0];const r=e[1],i=[];for(;o>"a";){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e);if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function ze(e,t,n=F){let[o,r]=e;const i=[];for(;o<"h"&&r<8;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r++;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ke(e,t,n=F){let[o,r]=e;const i=[];for(;o>"a"&&r>1;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r--;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Qe(e,t,n=F){let[o,r]=e;const i=[];for(;o>"a"&&r<8;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r++;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ve(e,t,n=F){let[o,r]=e;const i=[];for(;o<"h"&&r>1;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r--;if(!je({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function Ge(e,t,n,o=F){const[r,i]=Be(e),c=[];let l=r,s=i;return n.forEach((([e,n])=>{l=String.fromCharCode(r.charCodeAt(0)+e),s=i+n;if(l<"a"||l>"h"||s>8||s<1)return;const a=l+s,{color:d}=$e(a,o);t!==d&&c.push(a)})),c}function Je(e,t,n=F){for(const o of Ne(e,t,n)){const{pieceType:e,color:r}=$e(o,n);switch(e){case"rook":case"queen":if(t!==r)return!0}}for(const o of He(e,t,n)){const{pieceType:e,color:r}=$e(o,n);switch(e){case"bishop":case"queen":if(t!==r)return!0}}for(const o of Fe(e,t,n)){const{pieceType:e,color:r}=$e(o,n);if("knight"===e)if(t!==r)return!0}for(const o of Oe(e,t,n)){const{pieceType:e,color:r}=$e(o,n);if("king"===e)if(t!==r)return!0}for(const o of Te(e,t,n)){const{pieceType:e,color:r}=$e(o,n);if("pawn"===e)if(t!==r)return!0}return!1}function Xe(){const e=A?x:T,n=A?T:x,o=A?"white":"black",r=h(F),i=Je(e,o,r);if(!i)return!1;const c=xe(r,o),l=rt(o)||it(o),s=c.every((e=>te.includes(e))),a=i&&l&&c.length>0&&s;if(c.length>0&&!a)return!1;if(Ze(),tt(e,!0),Ye(e),Ye(n,"💎"),j=!1,v&&w){const e=A?w.black.rid:w.white.rid;zt(g,{type:"c.play.checkmate",data:e}),w.status="finished",tn()}return Lt(),t("gameEnd"),!0}function Ye(e,t="💢"){const{color:n}=$e(e),o=document.getElementById(e);if("💢"===t&&r.includes("pink")&&(t="❤️"),!e)throw new Error(`[CHESS_ERROR] Unable to insert checkmate emblem in squareId: ${e}`);const i=document.createElement("div"),c=document.createElement("div"),l=.45*o.getBoundingClientRect().height;i.classList.add("checkmate-container"),c.textContent=t,c.classList.add("checkmate"),c.classList.add(n),c.style.height=l+"%",c.style.width=l+"%",i.append(c),o.append(i)}function Ze(e=null){const t=document.getElementById(e);if(e&&t){const e=t.querySelector(".checkmate-container");if(!e)return;e.remove()}else document.querySelectorAll(".checkmate-container").forEach((e=>{e.remove()}));document.querySelectorAll(".bloody-check").forEach((e=>e.remove()))}function et(e,t){const n=["😱","😨","🥵","😡","😤"].filter((e=>e!==ee)),o=Math.floor(Math.random()*n.length),r=t??n[o];Ze(e),Ye(e,r),ee=r}function tt(e,t=!1){const n=document.getElementById(e);if(n)if(n.querySelectorAll(".bloody-check").forEach((e=>e.remove())),t){const e=n.querySelector(".piece");e&&e.classList.add("bloody-checkmate")}else{const e=document.createElement("div");n.prepend(e),e.classList.add("bloody-check")}}function nt(e,t,n,o){const r=A?x:T,i=h(F);let c=[...e];return c=[...new Set(c)],c.forEach((c=>{const l=h(i);Re(l,t,c),"king"!==o&&Je(r,n,l)&&(e=e.filter((e=>e!==c))),"king"===o&&Je(c,n,l)&&(e=e.filter((e=>e!==c)))})),e}function ot({e:e,fileTrack:t,rank:n,castleType:o}){let r=e.squareId===t+n&&e.pieceId&&"king"!==e.pieceType;return r&&"rook"===e.pieceType&&"chess960"===L?"short"===o&&e.squareId!==$?.kingRookFile+n||"long"===o&&e.squareId!==$?.queenRookFile+n:r}function rt(e,t=F){const n="white"===e?1:8,o="white"===e?x:T;let r=u("f","g"),i="h";"chess960"===L&&(i=$?.kingRookFile,r=u(o.charAt(0),"g"),r.includes("f")||r.push("f"));return!(r.map((e=>t.find((t=>ot({e:t,fileTrack:e,rank:n,castleType:"short"}))))).some((e=>!!e))||ct(e)||lt(e,`${i}${n}`,t))}function it(e,t=F){const n="white"===e?1:8,o="white"===e?x:T;let r=u("b","d"),i="a";"chess960"===L&&(i=$?.queenRookFile,r=u("c",o.charAt(0)),r.includes("d")||r.push("d"),"a"===i&&r.push("b"));return!(r.map((e=>t.find((t=>ot({e:t,fileTrack:e,rank:n,castleType:"long"}))))).some((e=>!!e))||ct(e)||lt(e,`${i}${n}`,t))}function ct(e){return!!U.find((t=>t.color===e&&"king"===t.pieceType))}function lt(e,t,n=F){const o=n.find((n=>n.squareId===t&&n.color===e&&"rook"===n.pieceType)),r=U.find((n=>n.color===e&&n.from===t&&"rook"===n.pieceType));return!o||r}function st(e,t){const n="white"===e?1:8;let o=null,r=null,i="g",c="c";if("chess960"===L&&(i=$?.kingRookFile,c=$?.queenRookFile),t===`${i}${n}`){let e="h";"chess960"===L&&(e=$?.kingRookFile),o=`${e}${n}`,r=`f${n}`}if(t===`${c}${n}`){let e="a";"chess960"===L&&(e=$?.queenRookFile),o=`${e}${n}`,r=`d${n}`}const{pieceId:l}=$e(o),s=document.getElementById(l),a=document.getElementById(r);s&&a&&a.append(s),Re(F,o,r),Se(o,r)}function at(e){const n=U.find((e=>"pending"===e.promotion));if(!n)throw new Error("[CHESS_ERROR] Unable to find promotion move state");n.promotion=e.toUpperCase(),qt(),t("promote")}function dt(e,t,n){const o=document.getElementById(n);if(!o)throw new Error(`[CHESS_ERROR] Unable to create piece at ${n}`);const r=o.querySelector(".piece");r&&(r.removeEventListener("pointerdown",ve),r.removeEventListener("pointermove",we),r.remove());const c=p(),l=document.createElement("div");l.classList.add("piece"),l.classList.add(t.toLowerCase()),l.dataset.color=e,l.id=c,l.addEventListener("pointerdown",ve),l.addEventListener("pointermove",we);let s=t[0].toLowerCase();"knight"===t&&(s="n");const a=document.createElement("img");a.alt=s,s="white"===e?s.toUpperCase():s.toLowerCase(),a.src=i[s],l.append(a),o.append(l);const d=$e(n);d.pieceId=c,d.pieceType=t,d.color=e}function ut(e=!1){!function(e=500){setTimeout((()=>{le&&pt()}),e)}(),Ze(),A=!A,G.push(function({color:e,castle:n,from:o,to:r,pieceType:i,hasCapture:c,promotion:l},s){const a=r[0];let d="";n&&("g"===a&&(d="O-O"),"c"===a&&(d="O-O-O"));const u=()=>{if("king"===i)return;const t=F.filter((t=>t.color===e&&t.pieceType===i&&t.squareId!==o));for(let n=0;n<t.length;n++){const c=t[n].squareId;let l=[];const s="white"===e?"black":"white";if("knight"===i?l=Fe(c,s):"bishop"===i?l=He(c,s):"rook"===i?l=Ne(c,s):"queen"===i&&(l=Pe(c,s)),l.includes(r)){const e=o.charAt(0)===c.charAt(0);d+=e?o.charAt(1):o.charAt(0);break}}};if("pawn"===i)d+="";else{let e=i.charAt(0).toUpperCase();"knight"===i&&(e="N"),n||(d+=e),u()}c&&("pawn"===i&&(d+=o.charAt(0)),d+="x");n||(d+=r);l&&(d+="="+l);const m="white"===e?"black":"white";let h="white"===m?x:T;Xe()?s>=0&&s===U.length-1&&(d+="#"):Je(h,m)&&(d+="+",s===U.length-1&&(t("check"),et(h),tt(h)));return wt(s,d,e),d}(U[U.length-1],U.length-1));const n="white"===D&&A,o="black"===D&&!A,r=mt();N.push(r),R=r.split(" "),B=R[0],v&&!e&&zt(g,{type:"c.state.fenpgn",data:[r,G[G.length-1]]});const i=document.querySelector(".fen");i&&(i.textContent=r);let c=!1,l=!1,s=!1,a=!1;(function(){const e=e=>e.split(" ").slice(0,4).join(" ");return N.some((t=>{const n=e(t);return N.filter((t=>e(t)===n)).length>=3}))})()&&(Ye(x,"🤝"),Ye(T,"🤝"),s=!0),function(e=N[N.length-1]){const t=e.split(" ")[0],n=t.split("").filter((e=>"B"===e)).length,o=t.split("").filter((e=>"b"===e)).length,r=t.split("").filter((e=>"N"===e)).length,i=t.split("").filter((e=>"n"===e)).length,c=t.split("").filter((e=>"Q"===e)).length,l=t.split("").filter((e=>"q"===e)).length,s=t.split("").filter((e=>"R"===e)).length,a=t.split("").filter((e=>"r"===e)).length,d=t.split("").filter((e=>"P"===e)).length,u=t.split("").filter((e=>"p"===e)).length;if(c+l+s+a+d+u>0)return!1;if(r+i>1)return!1;if(n+o>1)return!1;if((n>0||o>0)&&r+i>0)return!1;return!0}()&&(Ze(),Ye(x,"🤝"),Ye(T,"🤝"),j=!1,c=!0,a=!0);const d=Xe(),u=function(){const e=A?x:T,t=A?T:x,n=A?"white":"black",o=h(F);return!Je(e,n,o)&&!(xe(o,n).length>0||(Ze(),Ye(e,"❓"),Ye(t,"😨"),j=!1,0))}();c||!d&&!u||(l=!0,u&&(a=!0)),!l&&ht()>=100&&(Ye(x,"🥵"),Ye(T,"🥵"),a=!0),l||ft(z&&(n||o)),s&&v?(Z=!0,Et.style.display="block"):(Z=!1,Et.style.display="none"),a&&Zt()}function mt(e=F){let t="",n=8,o=0;const r=()=>{t=t.replace(/\*+/g,o),o=0};for(;n>=1;){for(let c="a";c<="h";i=c,c=String.fromCharCode(i.charCodeAt(0)+1)){const i=c+n,l=e.find((e=>e.squareId===i));if(!l)throw new Error(`[CHESS_ERROR] Unable to generate FEN due to missing squareId: ${i}`);const{color:s,pieceType:a}=l;if(a){let e="knight"===a?"n":a.charAt(0).toLowerCase();r(),t+="white"===s?e.toUpperCase():e}else t+="*",o++}r(),n>1&&(t+="/"),n--}var i;t+=A?" w ":" b ";let c="",l="h",s="a";"chess960"===L&&(l=$?.kingRookFile,s=$?.queenRookFile),ct("white")||lt("white",`${l}1`)||(c+="K"),ct("white")||lt("white",`${s}1`)||(c+="Q"),ct("black")||lt("black",`${l}8`)||(c+="k"),ct("black")||lt("black",`${s}8`)||(c+="q"),c||(c="-"),t+=c+" ",t+=(_||"-")+" ";const a=ht();t+=a+" ";const d=Math.floor(U.length/2)+1;return t+=d,t}function ht(){let e=0;for(let t=0;t<U.length;t++)e++,(U[t].hasCapture||"pawn"===U[t].pieceType||U[t].promotion)&&(e=0);return e}function pt(e){const t=document.querySelector(".eval.vertical");if(se=!se,void 0!==e&&(se=e),se?t?.classList.add("flip"):t?.classList.remove("flip"),de(),he(),ue(),U.length){const{from:e,to:t}=U[U.length-1];Ie(e,t)}if(Ze(),Le(),Ce(),O=null,G.length){G[G.length-1].includes("+")&&(A?(et(x,ee),tt(x)):(et(T,ee),tt(T)))}}function ft(e,t=N[N.length-1]){if(v)return;if(e&&(j=!1),t=t||I,e&&W.length){const{from:e,to:t}=U[U.length-1],{from:n,to:o}=W.splice(0,1)[0];if(n===e&&o===t){const e=W.splice(0,1)[0];if(e)return void setTimeout((()=>{be(e.from,e.to,!0),j=!0}),500)}}const n=document.getElementById("thinking");e&&n&&(n.style.display="inline-block"),function(e,t){const n=new Worker("./js/engine.js"),o=/score cp (-?\d+)/,r=/score mate (-?\d+)/,i=/ pv (.+)$/,c=/time (\d+)/,l=e.split(" ")[1];V&&V.terminate(),V=n;let s=1e3*(parseInt(Q)+1);n.onmessage=e=>{const a=e.data,d={success:!1,mate:null,evaluation:null,continuation:""};if(a.includes("info depth")&&a.includes(" pv ")){if(a.includes(`info depth ${K}`)&&(n.terminate(),V=null),o.test(a)){const e=o.exec(a)[1];d.evaluation=parseInt(e)/100}if(r.test(a)&&(d.mate=r.exec(a)[1],d.evaluation=null),i.test(a)&&(d.continuation=i.exec(a)[1]),"b"===l&&(d.evaluation&&(d.evaluation*=-1),d.mate&&(d.mate*=-1)),(d.mate||d.evaluation||d.continuation)&&(d.success=!0,vt(d.evaluation,d.mate)),a.includes(`info depth ${K}`)&&t(d),Q>=0&&c.test(a)){const e=c.exec(a)[1],n=s;parseInt(e)>=n&&t(d)}}},n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),"chess960"===L&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`);let a=`go depth ${K}`;Q>-1&&(a+=` movetime ${s}`),n.postMessage(a)}(t,(t=>{gt(t,e)}))}function gt(e,t){if(!e.success)throw new Error("SF failed");if(vt(e.evaluation,e.mate),!t)return;var n;j=!0,thinking&&(thinking.style.display="none"),n=e.continuation,e.mate,W=n.split(" ").map((e=>({from:e.slice(0,2),to:e.slice(2,5)})));const o=W.splice(0,1);if(!o.length)throw new Error("[SF_ERROR] No more moves found");const{from:r,to:i}=o[0];be(r,i,!0)}n(i,o,(e=>{Q=e})),"chess960"===L&&Ct(),de(),me(),he(),ue(),N.push(mt()),document.getElementById("btnAutoFlip").addEventListener("click",(e=>{le=!le,le?e.target.classList.add("glow"):e.target.classList.remove("glow")})),document.getElementById("btnReset").addEventListener("click",(e=>{v||(X&&_t(),document.querySelectorAll(".piece").forEach((e=>e.remove())),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),me(),"standard"===L?(A=!0,R=I.split(" "),B=R[0],he()):"chess960"===L&&Ct(),N.push(mt()),qe(),Le(),Ce(),Ze(),z=!1,document.getElementById("thinking").style.display="none",document.getElementById("btnVsBot")?.classList.remove("glow"),V&&(V.terminate(),V=null),ft(),document.getElementById("opening-name").textContent="",se&&le&&pt(!1))})),document.getElementById("btnFlip").addEventListener("click",(()=>{pt()})),document.getElementById("btnVsBot").addEventListener("click",(e=>{v||(z=!z,j&&(X&&_t(),z?(e.target.classList.add("glow"),D=A?"white":"black",j=!1,ft(!0),O&&(O=null,Le(),Ce())):e.target.classList.remove("glow")))})),document.getElementById("btnUndo").addEventListener("click",(e=>{if(v||!U.length)return;X&&_t();let n=U.length,o=N.length,r=J.length,i=G.length;const c=U[n-1],{from:l,to:s,promotion:a}=c;if("pending"===a)return void t("illegal");j=!0,O&&(Le(),Ce(),O=null),z&&(V&&V.terminate(),document.getElementById("thinking").style.display="none"),qe(),Ze(),o--,N.splice(o,1);const d=N[o-1];R=d.split(" "),B=R[0],_=R[3],A=!R[1]||"w"===R[1],F=[],he(),Se(s,l),n--,U.splice(n,1);const u=i;i--,G.splice(i,1);const m=Math.floor(i/2)+1,h=document.querySelector(`.pgn-row:nth-child(${m})`);if(u%2==0?h.querySelector(".pgn-col:nth-child(3)").textContent="":h.remove(),G[i-1]?.includes("+")&&tt(A?x:T),r--,J.splice(r,1),qt(),ft(),U.length){const e=U[n-1];Ie(e.to,e.from)}le&&setTimeout(pt,300)}));const yt=document.getElementById("btnRematch");function vt(e,t){null===e&&null!==t&&(e=t>0?K:-1*K);let n=50-e/K*100;n=Math.min(n,98),n=Math.max(n,2);const o=document.querySelector(".eval.vertical .bar"),r=document.querySelector(".eval.vertical .num"),i=document.querySelector(".eval.horizontal .bar"),c=document.querySelector(".eval.horizontal .num");if(o&&(o.style.height=n+"%"),i&&(i.style.width=n+"%"),r){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),r.textContent=n,e>0?r.classList.add("w"):r.classList.remove("w")}if(c){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),c.textContent=n,e>0?c.classList.add("w"):c.classList.remove("w")}}function wt(e,t,n){const o=document.querySelector(".pgn");if(o){let r=Math.floor(e/2)+1;"black"===n&&e%2==0&&(r=Math.max(r-1,1));let i=null,c=null,l=null,s=document.createElement("button");if(document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),"white"===n){i=document.createElement("div"),c=document.createElement("div"),l=document.createElement("span"),l.textContent=r+".",i.append(l),i.append(c);const e=document.createElement("div");e.classList.add("pgn-col"),i.append(e)}else c=document.querySelector(`.pgn-row:nth-child(${r}) .pgn-col:last-child`);s.textContent=t,s.onclick=()=>{Ut(),Y=e,jt(e)},X||(Y=e),i&&(i.classList.add("pgn-row"),o.append(i)),c.classList.add("pgn-col"),s.classList.add("active"),c.append(s),s.scrollIntoView()}}yt.addEventListener("click",(e=>{yt.style.display="none",v&&w&&("finished"!==w.status&&"closed"!==w.status||zt(g,{type:"c.rematch.request"}))})),yt.style.display="none",document.getElementById("btnCopyFenPGN").addEventListener("click",(()=>{let e=function(e=G){let t=St();for(let n=0;n<e.length;n++){const o=Math.floor(n/2)+1;n%2==0&&(t+=o+". "),t+=e[n]+" "}return t}();navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard")}));const kt=document.getElementById("btnCopyFenPGNALL");kt.addEventListener("click",(()=>{let e="";v&&w.pgnArchive?.length&&(e=function(e){let t="";return e.forEach((e=>{const n=e.rawPgn,{round:o,white:r,black:i,result:c,termination:l,fen:s}=e;let a=St({round:o,white:r,black:i,result:c,termination:l,fen:s});for(let e=0;e<n.length;e++){const t=Math.floor(e/2)+1;e%2==0&&(a+=t+". "),a+=n[e]+" "}t+=a+"\n\n"})),t}(w.pgnArchive),navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard"))})),kt.style.display="none";const Et=document.getElementById("btnDraw");Et.addEventListener("click",(()=>{v&&"ongoing"===w?.status&&Z&&confirm("Are you sure want to offer draw?")&&function(){const e=Kt();e&&[w.black.rid,w.white.rid].includes(e)&&zt(g,{type:"c.draw.offer",data:Kt()})}()})),Et.style.display="none";const bt=document.getElementById("btnResign");function St(e){const t=e?.event??"?",n=e?.site??window.location.hostname,o=e?.date??s(),r=e?.round??"?",i=e?.white??"?",c=e?.black??"?",l=e?.result??"?",a=e?.fen??I,d=e?.termination;let u=`[Event "${t}"]\n`;return u+=`[Site "${n}"]\n`,u+=`[Date "${o}"]\n`,u+=`[Round "${r}"]\n`,u+=`[White "${i}"]\n`,u+=`[Black "${c}"]\n`,u+=`[Result "${l}"]\n`,u+=`[FEN "${a}"]\n`,d&&(u+=`[Termination "${d}"]\n`),u+"\n"}function qt(e=""){let t=!1,n="";if(e||(n=U.map((e=>{let n=e.from+e.to;return e.promotion&&("pending"!==e.promotion?n+=e.promotion:t=!0),n})).join(",")),t&&!e)return;const o=document.getElementById("opening-name");o&&"chess960"!==L&&(e||(e=n),fetch(`https://explorer.lichess.ovh/masters?play=${e}`).then((e=>e.json())).then((e=>{const t=e?.opening?.name;t?o.innerHTML=t.replace(": ",":<br />"):o.textContent=""})))}function Ct(e=""){L="chess960";const t=l(e);return I=t.fen,R=I.split(" "),B=R[0],A=!R[1]||"w"===R[1],x=t.whiteKingSquareId,T=t.blackKingSquareId,te=[`${t.kingRookFile}1`,`${t.kingRookFile}8`,`${t.queenRookFile}1`,`${t.queenRookFile}8`],$=t,he(),t}function Lt(){r.includes("pink")?confettiHearts():confettis()}bt.addEventListener("click",(()=>{v&&"ongoing"===w?.status&&(w.moveState.length<b||confirm("Are you sure you want to resign?")&&(w.status="finished",bt.style.display="none",zt(g,{type:"c.resign"})))})),bt.style.display="none";const It='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="6 3 20 12 6 21 6 3"/></svg>';let $t=null;const Rt=500;let Bt=Rt;let At=!1;const xt=document.querySelector(".actions.rewind"),Tt=document.getElementById("btnRewindPlay"),Mt=document.getElementById("btnRewindPrev"),Ft=document.getElementById("btnRewindNext"),Nt=document.getElementById("btnRewindStop"),Ht=document.getElementById("btnRewindStart"),Pt=document.getElementById("btnRewindEnd");function Ot(){Bt=Math.max(75,Bt-50)}function jt(n,o){if(void 0===n)return;X=!0;const r=At;U.length===n+1&&Ut();let i=N[n+1];if(-1===n&&(i=N[0]),B===i.split(" ")[0])return;if(n>=0){const e=[];for(let t=0;t<=n;t++)e.push(J[t]);qt(e.join(","))}if(-1===n){const{from:e,to:t}=U[0];Se(t,e)}Ze(),Le(),qe(),Ce(),document.querySelectorAll(".hl-square").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),xt.style.display="flex";const c=document.querySelectorAll(".pgn-col button")[n];c?.classList.add("active"),c?.scrollIntoView(),P=null,O=null,F=[],B=i.split(" ")[0],he();const l=U[n];if(/left/i.test(o)){const e=U[n+1];e&&(Se(e.to,e.from),e.castle?t("castle"):e.promotion?t("promote"):t("lichess_move"))}if(!l)return;const{from:s,to:a,color:d,castle:u}=l;!/right/i.test(o)&&o||(Se(s,a),e(l)),u&&"standard"===L&&st(d,a);const m="white"===d?"black":"white",h=G[n],p=h.includes("+"),f=h.includes("#");if(p||f){const e=F.find((e=>e.color===m&&"king"===e.pieceType)).squareId;if(p&&(et(e),t("check")),f){const n=F.find((e=>e.color===d&&"king"===e.pieceType)).squareId;Ye(e),Ye(n,"💎"),r&&(Lt(),t("gameEnd"))}tt(e,f)}Ie(s,a)}function Ut(){clearTimeout($t),At=!1,Tt.innerHTML=It,X=!1,Bt=Rt}function _t(){X=!1,Y=U.length,P=null,O=null,Ut(),t("gameStart");const e=N.length-1;if(document.querySelectorAll(".pgn-col button.active").forEach((e=>e.classList.remove("active"))),document.querySelector(".pgn-row:last-child .pgn-col:last-child button:last-child")?.classList.add("active"),F=[],B=N[e].split(" ")[0],he(),U.length){const{from:e,to:t}=U[U.length-1];Ie(e,t)}Bt=Rt,clearTimeout($t),xt.style.display="none"}function Wt({direction:e,ev:t}){if(!U.length)return;let n=e||t.key;const o=e=>{switch(e){case"ArrowLeft":case"left":Y=Math.max(-1,Y-1);break;case"ArrowRight":case"right":Y=Math.min(U.length-1,Y+1)}if(Y>=-1&&Y<=U.length)return Y};switch(n){case"ArrowLeft":case"left":case"ArrowRight":case"right":jt(o(n),n)}}function Dt(){zt(g,{data:Kt()??"anything",type:"c.connection.ping"})}function zt(e,t){e.send(JSON.stringify(t))}function Kt(){return localStorage.getItem("rid")}function Qt(){zt(g,{type:"c.rid.register"})}function Vt(e){const{variant:t,boardState:n,moveState:o,fenState:r,rawPgn:i,white:c,black:l,status:s,scores:d,pgnArchive:u,time:m}=e;if(L=t,w=e,I=r[0],F=n,U=o,N=r,G=i,"chess960"===L&&Ct(I),R=r[r.length-1].split(" "),B=R[0],A=!R[1]||"w"===R[1],he(),qt(),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col").forEach((e=>e.remove())),document.querySelectorAll("#btnReset").forEach((e=>e.remove())),document.querySelectorAll("#btnAutoFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnUndo").forEach((e=>e.remove())),document.querySelectorAll(".eval").forEach((e=>e.remove())),kt.style.display="inline-block","ontouchstart"in window||navigator.maxTouchPoints>0||(document.querySelector("aside").style.marginTop="2.8rem"),o.length>=b&&(bt.style.display="inline-block"),k=c?.name||null,E=l?.name||null,_=R[3],Kt()===l?.rid?pt(!0):pt(!1),G.forEach(((e,t)=>{const n=o[t].color;if(wt(t,e,n),t+1===o.length&&(e.includes("+")||e.includes("#"))){let t=null;"white"===n?t=T:"black"===n&&(t=x),tt(t,e.includes("#")),e.includes("#")&&Ye(t)}})),k&&E){const e=document.querySelector(".score .bottom span.name");e&&(e.textContent=se?E:k);const t=document.querySelector(".score .top span.name");t&&(t.textContent=se?k:E)}Yt(d),"waiting"!==s&&a(),"ongoing"===s||("finished"===s?(yt.style.display="block",bt.style.display="none",j=!1,en(u[0])):"closed"===s&&(yt.style.display="none")),m?Jt(e.time):function(){if(!v)return;const e=document.getElementById("app"),t=document.createElement("div");e.append(t),t.classList.add("form-time-container");[{logo:"🚀",name:"bullet",values:["1+0","1+2","2+1"]},{logo:"⚡",name:"blitz",values:["3+0","3+2","5+0"]},{logo:"⏲️",name:"rapid",values:["10+0","15+10","30+0"]}].forEach((({logo:e,name:n,values:o})=>{const r=document.createElement("div");t.append(r),r.classList.add(n);const i=document.createElement("span");i.textContent=e,r.append(i),o.forEach((e=>{const n=document.createElement("button"),[o,i]=e.split("+");r.append(n);let c=o;+i&&(c+="+"+i),n.textContent=c,n.addEventListener("click",(()=>{zt(g,{type:"c.time.set",data:e}),t.remove()}))}))}))}()}function Gt(e,t){zt(g,{type:"c.play.move",data:{from:e,to:t,moveState:U[U.length-1]}})}function Jt(e){w.time=e;const t=document.querySelector(".form-time-container");t&&t.remove();let[n]=e.split("+");if(n=n.padStart(2,"0"),tn(),["finished","closed"].includes(w.status))return;const o=document.querySelector(".score .bottom span.time"),r=document.querySelector(".score .top span.time");o&&(o.textContent=`${n}:00`,o.classList.add("active"),o.classList.remove("rush")),r&&(r.textContent=`${n}:00`,r.classList.add("active"),r.classList.remove("rush")),tn(),"waiting"===w.status&&c()}function Xt(){const e=Kt();if(!v||!w||!e)return!0;return(A?w.white?.rid:w.black?.rid)===e}function Yt(e){const t=document.querySelector(".score .bottom span:first-child"),n=e=>e.replace(/\b(\d+)\.(\d+)\b/g,((e,t,n)=>n?"0"===t?"½":`${t} ½`:e));t&&(t.textContent=se?e[1]:e[0],t.textContent=n(t.textContent),se?t.parentElement.classList.add("flip"):t.parentElement.classList.remove("flip"));const o=document.querySelector(".score .top span:first-child");o&&(o.textContent=se?e[0]:e[1],o.textContent=n(o.textContent),se?o.parentElement.classList.add("flip"):o.parentElement.classList.remove("flip")),"finished"===w.status&&document.querySelectorAll(".time").forEach((e=>e.classList.add("active")))}function Zt(){zt(g,{type:"c.draw.accepted",data:!0}),j=!1}function en(e){if(!/resign/i.test(e.termination))return;let t="";t=e.termination.split(" ")[0]===e.black?"white":"black";const n="white"===t?x:T;Ye(n,"🚩"),tt(n,!0)}function tn(){if(!(w&&w.time&&w.moveState.length&&w.timeWhite&&w.timeBlack))return;q||m();const{timeWhite:e,timeBlack:t}=w;clearInterval(S);const n=e=>{e=Math.max(e,0);const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);let o=0;e<=1e4&&(o=Math.floor(e%1e3/100));const r=e=>e.toString().padStart(2,"0"),i=e<=1e4?"."+o:"";return`${r(t)}:${r(n)}${i}`},o=e=>`.score .${e} span.time`,r=(e,t)=>{t<=1e4?e.classList.add("rush"):e.classList.remove("rush")};if(["bottom","top"].forEach((i=>{const c=document.querySelector(o(i));let l=0;l="bottom"===i?se?t.remaining:e.remaining:se?e.remaining:t.remaining,c.textContent=n(l),r(c,l)})),"ongoing"!==w.status)return;const i=A?"white":"black";let c=null;c="white"===i?w.timeWhite:w.timeBlack;let l=((e,t)=>{if(!t)return e;return e-=Date.now()-t})(c.remaining,c.start);l<=0&&nn(i);let s=1e3;const a=()=>{if(l-=s,"ongoing"===w.status&&l>0&&(l>=1e4?s=1e3:l<1e4&&90!==s&&(s=90,clearInterval(S),S=null),S||(S=setInterval(a,s))),l<=0)return void nn(i);const e=n(l);let t="white"===i?"bottom":"top";const c=Kt()===w.white.rid&&"white"===i,d=Kt()===w.white.rid&&"white"!==i,u=Kt()===w.black.rid&&"black"===i,m=Kt()===w.black.rid&&"black"!==i;c||u?t="bottom":(d||m)&&(t="top");const h=document.querySelector(o(t));document.querySelectorAll(".time").forEach((e=>e.classList.remove("active"))),h&&(h.textContent=e,h.classList.add("active"),r(h,l))};S=setInterval(a,s)}function nn(e){w.status="finished",j=!1,clearInterval(S),zt(g,{type:"c.time.out",data:e})}Tt.innerHTML=It,Mt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>',Ft.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>',Nt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',Ht.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',Pt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>',Tt.addEventListener("click",(()=>{if(At=!At,At){Tt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect x="14" y="4" width="4" height="16" rx="1"/><rect x="6" y="4" width="4" height="16" rx="1"/></svg>';const e=()=>{Wt({direction:"right"}),$t=setTimeout(e,1e3)};e()}else Ut()})),Nt.addEventListener("click",(()=>{_t()})),Mt.addEventListener("pointerdown",(()=>{Ut();const e=()=>{Wt({direction:"left"}),$t=setTimeout(e,Bt),Ot()};e()})),Mt.addEventListener("pointerup",(()=>{Ut()})),Ft.addEventListener("pointerdown",(()=>{Ut();const e=()=>{Wt({direction:"right"}),$t=setTimeout(e,Bt),Ot()};e()})),Ft.addEventListener("pointerup",(()=>{Ut()})),Ht.addEventListener("click",(()=>{Y=-1,Ut(),jt(Y,"left")})),Pt.addEventListener("click",(()=>{Y=U.length-1,jt(Y,"right")})),window.addEventListener("keydown",(e=>{Wt({ev:e})}))})();