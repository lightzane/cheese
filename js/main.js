import{playSound as e}from"./audio.js";import{drawArrow as t,drawEmojiAtSquare as n,removeCanvas as o}from"./canvas.js";import{renderSettings as r}from"./settings.js";import{changeBoardTheme as i,currentThemeName as s,imgPieceMapping as l}from"./themes.js";import{displayQRCode as c,generateChess960StartingPos as a,getDate as d,hideQRCode as u,isUppercase as m,letterRange as p,lock as h,simpleClone as f,uuid as g}from"./utils.js";(()=>{const y="ontouchstart"in window||navigator.maxTouchPoints>0?250:200,v={k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"},w=function(){const e={};return e.onopen=()=>{setInterval(un,8e3)},e.onclose=()=>{alert("Connection to server lost... reloading page."),window.location.reload()},e}();w.onmessage=({data:t})=>{!function(t){let n;try{n=JSON.parse(t)}catch(e){console.error(e)}if(!n)return;const{type:o,data:r}=n;switch(o){case"s.room.in":!function(e){if(E=e,E){document.getElementById("btnVsBot")?.remove(),document.getElementById("btnUndo")?.remove();const e=document.querySelector(".fen");e&&(e.style.display="none"),document.querySelectorAll(".score").forEach((e=>{e.style.display="flex"}))}pn()?mn(w,{type:"c.name.get",data:pn()}):hn()}(r);break;case"s.room.share-info":fn(r);break;case"c.rid.register":!function(e){localStorage.setItem("rid",e);const t=()=>{let e=prompt("Name");return e||(e=t()),/^[a-zA-Z ]{2,}$/.test(e.trim())||(alert("Name must be alphabet and contains at least 2 characters"),e=t()),e};k=t(),mn(w,{type:"c.name.set",data:{name:k,rid:pn()}})}(r);case"c.name.get":!function(e){if(e)return void(k=e);hn()}(r),function(){if(!E)return;mn(w,{type:"c.room.join",data:pn()})}();break;case"c.play.move":!function(e){const{from:t,to:n,timeWhite:o,timeBlack:r}=e;Pe(t,n,!0),D.length>=C&&(Ot.style.display="inline-block");o&&r&&(b.timeWhite=o,b.timeBlack=r,bn())}(r);break;case"c.play.checkmate":!function({scores:e,aPgnArchive:t}){b.status="finished",b.scores=e,b.pgnArchive.unshift(t),wn(e),Nt.style.display="block",Ot.style.display="none",bn()}(r);break;case"c.rematch.request":!function(e){const t=confirm(`${e} wants to rematch. Do you ACCEPT?`);Nt.style.display="none",!1===t&&(b.status="closed");mn(w,{type:"c.rematch.response",data:t})}(r);break;case"c.rematch.response":!function(t){if(!t||!1===t)return void alert("Rematch Declined");pt(),Ie(),Ue(),fn(t),e("gameStart")}(r);break;case"c.resign":!function({message:t,scores:n,aPgnArchive:o}){En(o),W=!1,b.status="finished",b.scores=n,b.pgnArchive.unshift(o),wn(n),Ot.style.display="none",Ht.style.display="none",e("gameEnd"),le&&an();clearInterval(I),setTimeout((()=>{alert(t),Nt.style.display="block"}),1e3)}(r);break;case"c.time.set":yn(r);break;case"s.time.info":!function({timeWhite:e,timeBlack:t}){b.timeWhite=e,b.timeBlack=t,bn()}(r);break;case"c.time.out":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:i}){W=!1,b.status="finished",b.timeWhite=t,b.timeBlack=n,b.scores=i,b.pgnArchive.unshift(o),wn(i),bn(),Vt(),e("gameEnd"),le&&an();setTimeout((()=>{Nt.style.display="block",Ot.style.display="none",Ht.style.display="none",alert(r),L&&L.release()}),500)}(r);break;case"c.draw.offer":confirm(`${r} offers a draw. Do you accept?`)?kn():mn(w,{type:"c.draw.declined",data:!0});break;case"c.draw.declined":!function(e){alert(`${e} does not want to draw.`)}(r);break;case"c.draw.accepted":!function({timeWhite:t,timeBlack:n,aPgnArchive:o,message:r,scores:i}){W=!1,b.status="finished",b.timeWhite=t,b.timeBlack=n,b.scores=i,b.pgnArchive.unshift(o),wn(i),bn(),Vt(),e("gameEnd"),setTimeout((()=>{Nt.style.display="block",Ot.style.display="none",Ht.style.display="none",alert(r),L&&L.release()}),500)}(r);break;case"s.error":!function(e){console.error(e),alert(e),"object"==typeof e&&alert(JSON.stringify(e))}(r)}}(t)};let k=null,E=!1,b=null,S=null,q=null;const C=20;let I=null,L=null;let R=new URLSearchParams(window.location.search).get("v");!R||"chess960"!==R&&"960"!==R||(R="chess960");let $=R??"standard",x="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",B=null,A=x.split(" "),T=A[0],M=!A[1]||"w"===A[1],F="e1",P="e8",N=[],U=[],_=[],H=null,O=null,j=null,W=!0,D=[],V=null,z=[],K="black",Q=!1,G=!1,J=!1;const X=25;let Y=localStorage.getItem("difficulty")??0;isNaN(Y)?Y=0:+Y>7?Y=7:+Y<-1&&(Y=-1),localStorage.setItem("difficulty",Y);const Z=[50,100,150,200,300,400,500,1e3],ee=[-9,-5,-1,3,7,11,16,20],te=[5,5,5,5,5,8,13,22];let ne=null,oe=null,re=null,ie=[],se=[],le=!1,ce=-1,ae=!1,de=null,ue=["g1","g8","c1","c8"];const me="hl-hov-square",pe="hl-previous-move",he="hl-square",fe="hl-legal-squares",ge="hl-capture";let ye=!1,ve=!1;r(l,i,(e=>Y=e)),"chess960"===$&&Dt(),qe(),Ie(),Le(),Ce(),_.push(It()),document.getElementById("btnAutoFlip").addEventListener("click",(e=>{ye=!ye,ye?e.target.classList.add("glow"):e.target.classList.remove("glow")}));const we=document.getElementById("btnReset");let ke,Ee=!1;function be(){Ee=!1,clearTimeout(ke),we.innerText="Reset",we.style.removeProperty("color"),we.style.removeProperty("opacity")}function Se(){document.querySelector(".board").removeEventListener("pointerleave",Fe);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].removeEventListener("pointermove",Re),e[t].removeEventListener("pointerout",$e),e[t].removeEventListener("pointerup",xe)}function qe(){const e=document.getElementsByClassName("square");for(let t=ve?63:0;ve?t>=0:t<e.length;ve?t--:t++){const n=ve?1+Math.floor(t/8):8-Math.floor(t/8),o=ve?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8);e[t].id=o+n}}function Ce(){const e=document.getElementsByClassName("square"),t=e=>e.remove();document.querySelectorAll(".file").forEach(t),document.querySelectorAll(".rank").forEach(t);for(let t=ve?63:0;ve?t>=0:t<e.length;ve?t--:t++){const n=ve?1+Math.floor(t/8):8-Math.floor(t/8),o=ve?String.fromCharCode(104-t%8):String.fromCharCode(97+t%8),r=e[t];if(t>=56&&t<=64){const e=document.createElement("div");e.classList.add("file"),r.prepend(e),e.textContent=o}if((t+1)%8==1){const e=document.createElement("div");e.classList.add("rank"),r.prepend(e),e.textContent=n}}}function Ie(){U=[],D=[],_=[],N=[],H=null,V=null,K="black",z=[],ie=[],le=!1,se=[],ae=!1,O=null,j=null,W=!0,F="e1",P="e8","standard"===$&&(ue=["g1","g8","c1","c8"])}function Le(){const t=document.getElementsByClassName("square"),n=function(e){return e.replace(/\d/g,(e=>"1".repeat(+e)))}(T).split("/");for(let e=ve?63:0;ve?e>=0:e<t.length;ve?e--:e++){const o=ve?1+Math.floor(e/8):8-Math.floor(e/8),r=ve?String.fromCharCode(104-e%8):String.fromCharCode(97+e%8),i=97-r.charCodeAt(0),s=t[e];s.id=r+o;let c="",a="",d="";const u=n[8-o].charAt(-i);if(isNaN(+u)?(c=m(u)?"white":"black",a=v[u.toLowerCase()],d=U.length===t.length?je(s.id).pieceId:g(),"king"===a&&("white"===c&&(F=s.id),"black"===c&&(P=s.id))):(c=null,a=null,d=null),U.length<t.length&&U.push({squareId:s.id,color:c,pieceType:a,pieceId:d}),s.querySelectorAll(".piece").forEach((e=>{e.remove()})),d){const e=document.createElement("div");e.id=d,e.dataset.color=c,e.classList.add("piece"),e.classList.add(a),e.addEventListener("pointerdown",Ae),e.addEventListener("pointermove",Te);const t=document.createElement("img");t.src=l[u],t.alt=u,t.setAttribute("draggable",!1),e.appendChild(t),s.appendChild(e)}}const o=It(),r=document.querySelector(".fen");r&&(r.textContent=o),D.length||e("gameStart")}function Re(e){if(!W||!O)return;Me(e),e.preventDefault();const t=e.target;2===t.id.length?t.classList.add(me):t.parentElement.classList.add(me)}function $e(e){W&&(e.preventDefault(),e.target.classList.remove(me))}function xe(e){e.preventDefault(),Se();const t=e.currentTarget.id;if(O&&H===t&&N.length)return j=O,O.classList.remove("dragging"),document.getElementById(H).appendChild(O),function(e){const t=document.getElementById(e);t.querySelectorAll(`.${he}`).forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add(he),t.append(n)}(H),void(O=null);He();O&&(O.classList.remove("dragging"),O=null,j=null,_e(),Pe(H,t))}function Be(e){if(e.preventDefault(),!vn())return;if(2===e.button)return;if(!j)return;document.querySelectorAll(`.${he}`).forEach((e=>e.remove()));const t=e.currentTarget.id;H!==t&&(document.querySelectorAll(".square").forEach((e=>{e.removeEventListener("pointerdown",Be)})),Se(),He(),_e(),j=null,N.includes(t)&&(Pe(H,t),Ne(H,t)))}function Ae(e){if(!W||le)return;if(2===e.button)return;if(!vn())return;let t=e.target;qe(),function(){document.querySelector(".board").addEventListener("pointerleave",Fe);const e=document.getElementsByClassName("square");for(let t=0;t<e.length;t++)e[t].addEventListener("pointermove",Re),e[t].addEventListener("pointerout",$e),e[t].addEventListener("pointerup",xe),e[t].addEventListener("pointerdown",Be)}();let n=t.parentElement.id,o=je(n),r=o.color,i=o.pieceType;if(j){const e=j.parentElement.id,{color:s,pieceType:l}=je(e);let c=!1;if("chess960"!==$||"king"!==l||"rook"!==i||r!==s||Et(r,n)||(c=!0,N.includes(n)||N.push(n),t=j,j=null,n=t.parentElement.id,o=je(n),r=o.color,i=o.pieceType,document.querySelectorAll(`.${he}`).forEach((e=>e.remove()))),r!==s&&j.id!==t.id&&!c)return}H=n;if(M&&"white"===r||!M&&"black"===r){if(_e(),He(),O=t,Me(e),N=[...Ve(n)],N=gt(N,n,r,i),N=[...new Set(N)],"king"===i){const e=dt(n,r),t="white"===r?1:8,o="white"===r?F:P,i=vt(r),s=wt(r);let l=!1,c=!1;if(i){let e=["f"];"chess960"===$&&(e=p(o,"g")),e.forEach((e=>{l||(l=dt(`${e}${t}`,r))})),l||"chess960"!==$||("f"!==o.charAt(0)&&(N=N.filter((e=>e!==`g${t}`))),N.push(B?.kingRookFile+t))}if(s){let e=["d"];"chess960"===$&&(e=p("c",o)),"b"===o.charAt(0)&&e.push("b"),e.forEach((e=>{c||(c=dt(`${e}${t}`,r))})),c||"chess960"!==$||(["b","d"].includes(o.charAt(0))||(N=N.filter((e=>e!==`c${t}`))),N.push(B?.queenRookFile+t))}e&&(i||s)?N=N.filter((e=>!ue.includes(e))):(l&&(N=N.filter((e=>e!==`g${t}`))),c&&(N=N.filter((e=>e!==`c${t}`))))}N.forEach((e=>{const{color:t}=je(e);let n=t&&t!==r;"king"===i&&ue.includes(e)&&!kt(r)&&(n=!0,"chess960"===$&&Et(t,e)&&(n=!1)),function(e,t=!1){const n=document.getElementById(e);if(n.querySelector(`.${fe}`))return;const o=document.createElement("div");o.classList.add(fe),n.appendChild(o),t&&o.classList.add(ge)}(e,n)}))}}function Te(e){if(O){const e=O;e.classList.add("dragging"),document.body.append(e)}}function Me(e){if(!O)return;const t=document.querySelector(".square"),n=O;let o=t.getBoundingClientRect().width,r=t.getBoundingClientRect().height;n.style.width=`${o}px`,n.style.height=`${r}px`;o=e.clientX-o/2,r=e.clientY-r/2,n.style.left=`${o}px`,n.style.top=`${r}px`}function Fe(e){Se(),document.getElementById(H).append(O),O.classList.remove("dragging"),O=null,document.querySelectorAll(`.${fe}`).forEach((e=>e.remove())),document.querySelectorAll(`.${me}`).forEach((e=>e.classList.remove(me)))}function Pe(t,n,o=!1){le&&an();let r=null;o&&3===n.length&&(r=n.slice(2,3),n=n.slice(0,2));const i=t,s=n,c=document.getElementById(s),{pieceId:a,pieceType:d,color:u}=je(i),{color:m,pieceType:p,pieceId:h}=je(s),f=document.getElementById(a);o&&N.push(n);const g=i===s,w=!N.includes(s);if(g||w)return document.getElementById(i).appendChild(f),N=[],void(i!==s&&e("illegal"));let k,b=null;if("king"===d){let e=!1;if("chess960"!==$||s.charAt(0)!==B?.queenRookFile&&s.charAt(0)!==B?.kingRookFile||(e=!0),dt(s,u)&&!e)return;if(ue.includes(s)&&!kt(u)){const e=()=>{bt(u,s),k=!0};"chess960"===$?(b=je(i)?.pieceId,m===u&&"rook"===p&&(Et(m,s)||e())):e()}"white"===u?F=s:P=s}let S=!1;if(m)if(k&&"chess960"===$);else{if(m===u)return;{S=!0;const e=c.querySelector(".piece");e.classList.add("fade-out"),e.removeEventListener("pointerdown",Ae),e.removeEventListener("pointermove",Te),e.style.opacity="0.5",setTimeout((()=>{e.remove()}),y)}}if(V===s&&(!function(e){if(!V)return;const t="white"===e?-1:1,n=+V[1]+t,o=je(`${V[0]}${n}`);let r=document.getElementById(o.squareId).querySelector(".piece");r&&(r.remove(),r.removeEventListener("pointerdown",Ae),r.removeEventListener("pointermove",Te));r=document.getElementById(o.pieceId),r&&(r.remove(),r.removeEventListener("pointerdown",Ae),r.removeEventListener("pointermove",Te));o.color=null,o.pieceId=null,o.pieceType=null}(u),S=!0),!f)throw new Error(`[CHESS_ERROR] Unable to move piece with id (${a}) positioned at squareId: ${i}`);let q,C=null;if("chess960"===$&&k){const[e,t]=s.split("");if(e===B?.kingRookFile.charAt(0)?C=document.getElementById(`g${t}`):e===B?.queenRookFile.charAt(0)&&(C=document.getElementById(`c${t}`)),!C)throw new Error("[CHESS_ERROR] Unable to find castling square for Chess960");C.append(f),We(U,i,C.id),o||Ne(i,C.id)}else c.appendChild(f);if(o&&Ne(i,s),k&&"chess960"===$){const e=U.find((e=>e.squareId===C.id));e.color=u,e.pieceId=b,e.pieceType="king";const t="g"===C.id.charAt(0)?"f":"d",n="white"===u?1:8,o=U.find((e=>e.squareId===t+n));o.color=u,o.pieceId=h,o.pieceType="rook","white"===u?F=C.id:P=C.id}else We(U,i,s);if(N=[],V=null,"pawn"===d){const e="white"===u?2:7,t="white"===u?2:-2,n="white"===u?3:6;+i[1]===e&&+s[1]===e+t&&(V=`${s[0]}${n}`)}if("pawn"===d){const e="white"===u&&8==+s[1],t="black"===u&&1==+s[1];(e||t)&&(q="pending")}let I=s;if(k&&"chess960"===$&&(I=C.id),D.push({from:i,to:I,color:u,pieceType:d,hasCapture:S,castle:k,promotion:q}),se.push(t+n),Wt(),e(k?"castle":S?"capture":"move"),Oe(i,I),q)return o?(se[se.length-1]+=r,St(r),void setTimeout((()=>{qt(u,v[r],s),Ct(o)}),y)):(W=!1,void function(e){if(e.length>2)throw new Error("[CHESS_ERROR] Invalid square id. Unable to promote.");const{color:t}=je(e),n="white"===t?8:1;if(8!==n&&1!==n)return!1;if("white"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote white with squareId: ${e}`);if("black"===t&&+e[1]!==n)throw new Error(`[CHESS_ERROR] Unable to promote black with squareId: ${e}`);const o=document.createElement("div"),r=document.createElement("div");o.classList.add("promotion-container"),r.classList.add("promotion-content"),o.append(r);let i=["Q","R","B","N"];"black"===t&&(i=i.map((e=>e.toLowerCase())));const s=document.getElementById(e);if(!s)throw new Error("[CHESS_ERROR] Board square was not found");const c=.95*s.getBoundingClientRect().height;i.forEach(((n,i)=>{const s=document.createElement("div"),a=document.createElement("img");a.src=l[n],a.alt=n,a.height=c,a.width=c,s.addEventListener("click",(()=>{if(qt(t,v[n.toLowerCase()],e),o.remove(),St(n),se[se.length-1]+=n.toLowerCase(),W=!0,E){const{from:e,to:t}=D[D.length-1];gn(e,t)}Ct()})),s.classList.add("promotion-square"),s.append(a),r.append(s),1===i&&r.append(document.createElement("br"))}));const a=document.querySelector(".board");if(!a)throw new Error("[CHESS_ERROR] Board was not found");a.append(o)}(s));E&&vn()&&!o&&!q&&gn(i,s),Ct(o)}function Ne(e,t){const n=document.getElementById(t),o=document.getElementById(e);if(!n||!o)return;const r=n.querySelector(".piece:not(.fade-out)");if(!r)return;let i=o.getBoundingClientRect().top,s=o.getBoundingClientRect().left;const l=o.getBoundingClientRect().width,c=n.getBoundingClientRect().top,a=n.getBoundingClientRect().left,d=r.style.transition,u=r.style.position,m=r.style.zIndex;r.style.position="fixed",r.style.zIndex="1000",r.style.top=i+"px",r.style.left=s+"px",r.style.height=l+"px",r.style.width=l+"px";let p=a-s,h=c-i;r.style.transition=`transform ${y}ms ease-in-out`,r.style.transform=`translate(${p}px, ${h}px)`,setTimeout((()=>{r.style.transition=d,r.style.transform="translate(0,0)",r.style.position=u,r.style.zIndex=m,r.style.top="auto",r.style.left="auto"}),y)}function Ue(){document.querySelectorAll(`.${pe}`).forEach((e=>{e.remove()}))}function _e(){const e=document.getElementsByClassName(fe);for(;e.length>0;)e[0].remove()}function He(){document.querySelectorAll(`.${me}`).forEach((e=>e.classList.remove(me)))}function Oe(e,t){Ue();const n=document.getElementById(e),o=document.getElementById(t),r=document.createElement("div"),i=document.createElement("div");r.classList.add(pe),i.classList.add(pe),n.appendChild(r),o.appendChild(i)}function je(e,t=U){const n=t.find((t=>t.squareId===e));if(!n)throw new Error(`[CHESS_ERROR] Square with squareId "${e}" was not found`);return n}function We(e,t,n){const o=e.findIndex((e=>e.squareId===t)),r=e.findIndex((e=>e.squareId===n)),i=e[o];e[r]={...i,squareId:n},i.color=null,i.pieceId=null,i.pieceType=null}function De(e){return[e.charAt(0),+e.charAt(1)]}function Ve(e,t=U){const{pieceId:n,color:o,pieceType:r}=je(e,t);if(!n)throw new Error(`[CHESS_ERROR] No piece identified at squareId: ${e}`);switch(r){case"pawn":return function(e,t,n=U){return[...Ke(e,t,n),...Qe(e,t,n)]}(e,o,t);case"knight":return Ge(e,o,t);case"rook":return Je(e,o,t);case"bishop":return Xe(e,o,t);case"queen":return Ye(e,o,t);case"king":return Ze(e,o,t);default:throw new Error("[CHESS_ERROR] Unknown piece type")}}function ze(e,t){return e.filter((e=>e.color===t)).flatMap((({squareId:t,color:n,pieceType:o})=>gt(Ve(t,f(e)),t,n,o)))}function Ke(e,t,n=U){const[o,r]=De(e),i=[];let s=o,l=r,c=e;if(l+="white"===t?1:-1,l>8||l<1)return i;const a=[-1,1];for(const e of a)if(s=String.fromCharCode(o.toLowerCase().charCodeAt(0)+e),s>="a"&&s<="h"){c=`${s}${l}`;const{color:e}=je(c,n);e&&e!==t&&i.push(c),e||c!==V||i.push(c)}return i}function Qe(e,t,n=U){const[o,r]=De(e),i=[];let s=o,l=r;l+="white"===t?1:-1;let c=`${s}${l}`,a=je(c,n);return a.pieceId?i:(i.push(c),"white"===t&&2===r&&l++,"black"===t&&7===r&&l--,c=`${s}${l}`,a=je(c,n),a.pieceId||i.push(c),i)}function Ge(e,t,n=U){return[...at(e,t,[[-1,2],[1,2],[-2,1],[2,1],[-2,-1],[2,-1],[-1,-2],[1,-2]],n)]}function Je(e,t,n=U){const o=De(e);return[...tt(o,t,n),...nt(o,t,n),...ot(o,t,n),...rt(o,t,n)]}function Xe(e,t,n=U){const o=De(e);return[...it(o,t,n),...st(o,t,n),...lt(o,t,n),...ct(o,t,n)]}function Ye(e,t,n=U){const o=De(e);return[...tt(o,t,n),...nt(o,t,n),...ot(o,t,n),...rt(o,t,n),...it(o,t,n),...st(o,t,n),...lt(o,t,n),...ct(o,t,n)]}function Ze(e,t,n=U){const o="white"===t?1:8,r=[];return vt(t,n)&&r.push(`g${o}`),wt(t,n)&&r.push(`c${o}`),[...at(e,t,[[-1,1],[0,1],[1,1],[-1,-1],[0,-1],[1,-1],[-1,0],[1,0]],n),...r]}function et({file:e,rank:t,color:n,legalSquares:o},r=U){const i=e+t,{color:s}=je(i,r);return(!s||s!==n)&&(o.push(i),!s||s===n)}function tt(e,t,n=U){const o=e[0];let r=e[1];const i=[];for(;r<8;){r++;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function nt(e,t,n=U){const o=e[0];let r=e[1];const i=[];for(;r>1;){r--;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function ot(e,t,n=U){let o=e[0];const r=e[1],i=[];for(;o<"h";){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e);if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function rt(e,t,n=U){let o=e[0];const r=e[1],i=[];for(;o>"a";){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e);if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function it(e,t,n=U){let[o,r]=e;const i=[];for(;o<"h"&&r<8;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r++;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function st(e,t,n=U){let[o,r]=e;const i=[];for(;o>"a"&&r>1;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r--;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function lt(e,t,n=U){let[o,r]=e;const i=[];for(;o>"a"&&r<8;){const e=o.charCodeAt(0)-1;o=String.fromCharCode(e),r++;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function ct(e,t,n=U){let[o,r]=e;const i=[];for(;o<"h"&&r>1;){const e=o.charCodeAt(0)+1;o=String.fromCharCode(e),r--;if(!et({file:o,rank:r,color:t,legalSquares:i},n))break}return i}function at(e,t,n,o=U){const[r,i]=De(e),s=[];let l=r,c=i;return n.forEach((([e,n])=>{l=String.fromCharCode(r.charCodeAt(0)+e),c=i+n;if(l<"a"||l>"h"||c>8||c<1)return;const a=l+c,{color:d}=je(a,o);t!==d&&s.push(a)})),s}function dt(e,t,n=U){for(const o of Je(e,t,n)){const{pieceType:e,color:r}=je(o,n);switch(e){case"rook":case"queen":if(t!==r)return!0}}for(const o of Xe(e,t,n)){const{pieceType:e,color:r}=je(o,n);switch(e){case"bishop":case"queen":if(t!==r)return!0}}for(const o of Ge(e,t,n)){const{pieceType:e,color:r}=je(o,n);if("knight"===e)if(t!==r)return!0}for(const o of Ze(e,t,n)){const{pieceType:e,color:r}=je(o,n);if("king"===e)if(t!==r)return!0}for(const o of Ke(e,t,n)){const{pieceType:e,color:r}=je(o,n);if("pawn"===e)if(t!==r)return!0}return!1}function ut(){const t=M?F:P,n=M?P:F,o=M?"white":"black",r=f(U),i=dt(t,o,r);if(!i)return!1;const s=ze(r,o),l=vt(o)||wt(o),c=s.every((e=>ue.includes(e))),a=i&&l&&s.length>0&&c;if(s.length>0&&!a)return!1;if(pt(),ft(t,!0),mt(t),mt(n,"ðŸ’Ž"),W=!1,E&&b){const e=M?b.black.rid:b.white.rid;mn(w,{type:"c.play.checkmate",data:e}),b.status="finished",bn()}return Vt(),e("gameEnd"),!0}function mt(e,t="ðŸ’¢"){const{color:n}=je(e),o=document.getElementById(e);if("ðŸ’¢"===t&&s.includes("pink")&&(t="â¤ï¸"),!e)throw new Error(`[CHESS_ERROR] Unable to insert checkmate emblem in squareId: ${e}`);const r=document.createElement("div"),i=document.createElement("div"),l=.45*o.getBoundingClientRect().height;r.classList.add("checkmate-container"),i.textContent=t,i.classList.add("checkmate"),i.classList.add(n),i.style.height=l+"%",i.style.width=l+"%",r.append(i),o.append(r)}function pt(e=null){const t=document.getElementById(e);if(e&&t){const e=t.querySelector(".checkmate-container");if(!e)return;e.remove()}else document.querySelectorAll(".checkmate-container").forEach((e=>{e.remove()}));document.querySelectorAll(".bloody-check").forEach((e=>e.remove()))}function ht(e,t){const n=["ðŸ˜±","ðŸ˜¨","ðŸ¥µ","ðŸ˜¡","ðŸ˜¤"].filter((e=>e!==de)),o=Math.floor(Math.random()*n.length),r=t??n[o];pt(e),mt(e,r),de=r}function ft(e,t=!1){const n=document.getElementById(e);if(n)if(n.querySelectorAll(".bloody-check").forEach((e=>e.remove())),t){const e=n.querySelector(".piece");e&&e.classList.add("bloody-checkmate")}else{const e=document.createElement("div");n.prepend(e),e.classList.add("bloody-check")}}function gt(e,t,n,o){const r=M?F:P,i=f(U);let s=[...e];return s=[...new Set(s)],s.forEach((s=>{const l=f(i);We(l,t,s),"king"!==o&&dt(r,n,l)&&(e=e.filter((e=>e!==s))),"king"===o&&dt(s,n,l)&&(e=e.filter((e=>e!==s)))})),e}function yt({e:e,fileTrack:t,rank:n,castleType:o}){let r=e.squareId===t+n&&e.pieceId&&"king"!==e.pieceType;return r&&"rook"===e.pieceType&&"chess960"===$?"short"===o&&e.squareId!==B?.kingRookFile+n||"long"===o&&e.squareId!==B?.queenRookFile+n:r}function vt(e,t=U){const n="white"===e?1:8,o="white"===e?F:P;let r=p("f","g"),i="h";"chess960"===$&&(i=B?.kingRookFile,r=p(o.charAt(0),"g"),r.includes("f")||r.push("f"));return!(r.map((e=>t.find((t=>yt({e:t,fileTrack:e,rank:n,castleType:"short"}))))).some((e=>!!e))||kt(e)||Et(e,`${i}${n}`,t))}function wt(e,t=U){const n="white"===e?1:8,o="white"===e?F:P;let r=p("b","d"),i="a";"chess960"===$&&(i=B?.queenRookFile,r=p("c",o.charAt(0)),r.includes("d")||r.push("d"),"a"===i&&r.push("b"));return!(r.map((e=>t.find((t=>yt({e:t,fileTrack:e,rank:n,castleType:"long"}))))).some((e=>!!e))||kt(e)||Et(e,`${i}${n}`,t))}function kt(e){return!!D.find((t=>t.color===e&&"king"===t.pieceType))}function Et(e,t,n=U){const o=n.find((n=>n.squareId===t&&n.color===e&&"rook"===n.pieceType)),r=D.find((n=>n.color===e&&n.from===t&&"rook"===n.pieceType));return!o||r}function bt(e,t){const n="white"===e?1:8;let o=null,r=null,i="g",s="c";if("chess960"===$&&(i=B?.kingRookFile,s=B?.queenRookFile),t===`${i}${n}`){let e="h";"chess960"===$&&(e=B?.kingRookFile),o=`${e}${n}`,r=`f${n}`}if(t===`${s}${n}`){let e="a";"chess960"===$&&(e=B?.queenRookFile),o=`${e}${n}`,r=`d${n}`}const{pieceId:l}=je(o),c=document.getElementById(l),a=document.getElementById(r);c&&a&&a.append(c),We(U,o,r),Ne(o,r)}function St(t){const n=D.find((e=>"pending"===e.promotion));if(!n)throw new Error("[CHESS_ERROR] Unable to find promotion move state");n.promotion=t.toUpperCase(),Wt(),e("promote")}function qt(e,t,n){const o=document.getElementById(n);if(!o)throw new Error(`[CHESS_ERROR] Unable to create piece at ${n}`);const r=o.querySelector(".piece");r&&(r.removeEventListener("pointerdown",Ae),r.removeEventListener("pointermove",Te),r.remove());const i=g(),s=document.createElement("div");s.classList.add("piece"),s.classList.add(t.toLowerCase()),s.dataset.color=e,s.id=i,s.addEventListener("pointerdown",Ae),s.addEventListener("pointermove",Te);let c=t[0].toLowerCase();"knight"===t&&(c="n");const a=document.createElement("img");a.alt=c,c="white"===e?c.toUpperCase():c.toLowerCase(),a.src=l[c],s.append(a),o.append(s);const d=je(n);d.pieceId=i,d.pieceType=t,d.color=e}function Ct(t=!1){!function(e=500){setTimeout((()=>{ye&&Rt()}),e)}(),pt(),o("analysis"),Bt(),M=!M,ie.push(function({color:t,castle:n,from:o,to:r,pieceType:i,hasCapture:s,promotion:l},c){const a=r[0];let d="";n&&("g"===a&&(d="O-O"),"c"===a&&(d="O-O-O"));const u=()=>{if("king"===i)return;const e=U.filter((e=>e.color===t&&e.pieceType===i&&e.squareId!==o));for(let n=0;n<e.length;n++){const s=e[n].squareId;let l=[];const c="white"===t?"black":"white";if("knight"===i?l=Ge(s,c):"bishop"===i?l=Xe(s,c):"rook"===i?l=Je(s,c):"queen"===i&&(l=Ye(s,c)),l.includes(r)){const e=o.charAt(0)===s.charAt(0);d+=e?o.charAt(1):o.charAt(0);break}}};if("pawn"===i)d+="";else{let e=i.charAt(0).toUpperCase();"knight"===i&&(e="N"),n||(d+=e),u()}s&&("pawn"===i&&(d+=o.charAt(0)),d+="x");n||(d+=r);l&&(d+="="+l);const m="white"===t?"black":"white";let p="white"===m?F:P;ut()?c>=0&&c===D.length-1&&(d+="#"):dt(p,m)&&(d+="+",c===D.length-1&&(e("check"),ht(p),ft(p)));return Ut(c,d,t),d}(D[D.length-1],D.length-1));const n="white"===K&&M,r="black"===K&&!M,i=It();_.push(i),!E&&G&&ln(D.length),A=i.split(" "),T=A[0],E&&!t&&mn(w,{type:"c.state.fenpgn",data:[i,ie[ie.length-1]]});const s=document.querySelector(".fen");s&&(s.textContent=i);let l=!1,c=!1,a=!1,d=!1;(function(){const e=e=>e.split(" ").slice(0,4).join(" ");return _.some((t=>{const n=e(t);return _.filter((t=>e(t)===n)).length>=3}))})()&&(mt(F,"ðŸ¤"),mt(P,"ðŸ¤"),a=!0),function(e=_[_.length-1]){const t=e.split(" ")[0],n=t.split("").filter((e=>"B"===e)).length,o=t.split("").filter((e=>"b"===e)).length,r=t.split("").filter((e=>"N"===e)).length,i=t.split("").filter((e=>"n"===e)).length,s=t.split("").filter((e=>"Q"===e)).length,l=t.split("").filter((e=>"q"===e)).length,c=t.split("").filter((e=>"R"===e)).length,a=t.split("").filter((e=>"r"===e)).length,d=t.split("").filter((e=>"P"===e)).length,u=t.split("").filter((e=>"p"===e)).length;if(s+l+c+a+d+u>0)return!1;if(r+i>1)return!1;if(n+o>1)return!1;if((n>0||o>0)&&r+i>0)return!1;return!0}()&&(pt(),mt(F,"ðŸ¤"),mt(P,"ðŸ¤"),W=!1,l=!0,d=!0);const u=ut(),m=function(){const e=M?F:P,t=M?P:F,n=M?"white":"black",o=f(U);return!dt(e,n,o)&&!(ze(o,n).length>0||(pt(),mt(e,"â“"),mt(t,"ðŸ˜¨"),W=!1,0))}();l||!u&&!m||(c=!0,m&&(d=!0)),!c&&Lt()>=100&&(mt(F,"ðŸ¥µ"),mt(P,"ðŸ¥µ"),d=!0),c||(Tt(Q&&(n||r)),At(i)),a&&E?(ae=!0,Ht.style.display="block"):(ae=!1,Ht.style.display="none"),d&&kn()}function It(e=U){let t="",n=8,o=0;const r=()=>{t=t.replace(/\*+/g,o),o=0};for(;n>=1;){for(let s="a";s<="h";i=s,s=String.fromCharCode(i.charCodeAt(0)+1)){const i=s+n,l=e.find((e=>e.squareId===i));if(!l)throw new Error(`[CHESS_ERROR] Unable to generate FEN due to missing squareId: ${i}`);const{color:c,pieceType:a}=l;if(a){let e="knight"===a?"n":a.charAt(0).toLowerCase();r(),t+="white"===c?e.toUpperCase():e}else t+="*",o++}r(),n>1&&(t+="/"),n--}var i;t+=M?" w ":" b ";let s="",l="h",c="a";"chess960"===$&&(l=B?.kingRookFile,c=B?.queenRookFile),kt("white")||Et("white",`${l}1`)||(s+="K"),kt("white")||Et("white",`${c}1`)||(s+="Q"),kt("black")||Et("black",`${l}8`)||(s+="k"),kt("black")||Et("black",`${c}8`)||(s+="q"),s||(s="-"),t+=s+" ",t+=(V||"-")+" ";const a=Lt();t+=a+" ";const d=Math.floor(D.length/2)+1;return t+=d,t}function Lt(){let e=0;for(let t=0;t<D.length;t++)e++,(D[t].hasCapture||"pawn"===D[t].pieceType||D[t].promotion)&&(e=0);return e}function Rt(e){const t=document.querySelector(".eval.vertical");if(ve=!ve,void 0!==e&&(ve=e),ve?t?.classList.add("flip"):t?.classList.remove("flip"),qe(),Le(),Ce(),D.length){const{from:e,to:t}=D[D.length-1];Oe(e,t)}if(pt(),He(),_e(),j=null,ie.length){ie[ie.length-1].includes("+")&&(M?(ht(F,de),ft(F)):(ht(P,de),ft(P)))}}function $t(e){return{engine:new Worker("./js/engine.js"),scoreRgx:/score cp (-?\d+)/,mateRgx:/score mate (-?\d+)/,pvRgx:/ pv (.+)$/,timeRgx:/time (\d+)/,turn:e.split(" ")[1]}}function xt(e,t){const{engine:n,pvRgx:o,timeRgx:r}=$t(e);re&&re.terminate(),re=n;let i=0;const s=_.findIndex((t=>t===e));if(s<0)return re=null,void n.terminate();let l=null,c=null,a=null;n.onmessage=e=>{const d=e.data;if(o.test(d)){const e=o.exec(d)[1].split(" ")[0],u=D[s];if(e){const n=e.slice(0,2),o=e.slice(2,4),r=e.slice(4,5);l===n&&c===o?i++:i=0,l=n,c=o,r&&(a=r.toUpperCase()),G&&Pt&&Ft&&(J=!0,Pt.style.display="flex",Ft.style.display="none"),t(n,o,r)}let m=!1;if(r.test(d)){const e=r.exec(d)[1];parseInt(e)>=6e4&&(m=!0)}(i>=30||m)&&(re=null,n.terminate(),u&&(u.goodMoveFrom=l,u.goodMoveTo=c,a&&(u.goodMovePromotion=a)),t(l,c,a),G&&Pt&&Ft&&(J=!1,Pt.style.display="none",Ft.style.removeProperty("display")))}},n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),n.postMessage("setoption name uci_elo value 5000"),"chess960"===$&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`),n.postMessage("go movetime 60000")}function Bt(){re&&(re.terminate(),re=null),J=!1,G&&Pt&&Ft&&(Pt.style.display="none",Ft.style.removeProperty("display"))}function At(e=_[_.length-1]){const{engine:t,mateRgx:n,pvRgx:o,scoreRgx:r,turn:i}=$t(e);oe&&oe.terminate(),oe=t,t.onmessage=e=>{const s=e.data,l={success:!1,mate:null,evaluation:null,continuation:""};if(s.includes("info depth")&&s.includes(" pv ")){if(s.includes(`info depth ${X}`)&&(t.terminate(),oe=null),r.test(s)){const e=r.exec(s)[1];l.evaluation=parseInt(e)/100}n.test(s)&&(l.mate=n.exec(s)[1],l.evaluation=null),o.test(s)&&(l.continuation=o.exec(s)[1]),"b"===i&&(l.evaluation&&(l.evaluation*=-1),l.mate&&(l.mate*=-1)),(l.mate||l.evaluation||l.continuation)&&(l.success=!0,function(e,t){null===e&&null!==t&&(e=t>0?X:-1*X);let n=50-e/X*100;n=Math.min(n,98),n=Math.max(n,2);const o=document.querySelector(".eval.vertical .bar"),r=document.querySelector(".eval.vertical .num"),i=document.querySelector(".eval.horizontal .bar"),s=document.querySelector(".eval.horizontal .num");o&&(o.style.height=n+"%");i&&(i.style.width=n+"%");if(r){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),r.textContent=n,e>0?r.classList.add("w"):r.classList.remove("w")}if(s){let n=Math.abs(e).toFixed(1);null!==t&&(n=`M${Math.abs(t)}`),s.textContent=n,e>0?s.classList.add("w"):s.classList.remove("w")}}(l.evaluation,l.mate))}},t.postMessage("isready"),t.postMessage("ucinewgame"),t.postMessage("isready"),t.postMessage("setoption name UCI_Elo value 5000"),t.postMessage("setoption name UCI_LimitStrength value false"),t.postMessage("setoption name Skill Level value 20"),"chess960"===$&&t.postMessage("setoption name UCI_Chess960 value true"),t.postMessage(`position fen ${e}`),t.postMessage(`go depth ${X}`)}function Tt(e,t=_[_.length-1]){if(E)return;if(e&&(W=!1),t=t||x,e&&z.length){const{from:e,to:t}=D[D.length-1],{from:n,to:o}=z.splice(0,1)[0];if(n===e&&o===t){const e=z.splice(0,1)[0];if(e)return void setTimeout((()=>{Pe(e.from,e.to,!0),W=!0}),500)}}const n=document.getElementById("thinking");e&&n&&(n.style.display="inline-block",document.getElementById("btnVsBot").style.display="none"),function(e,t){const{engine:n,mateRgx:o,pvRgx:r,scoreRgx:i,timeRgx:s,turn:l}=$t(e);ne&&ne.terminate(),ne=n;const c=parseInt(Y);let a=-1,d=20,u=X;c>=0&&(a=Z[c],d=ee[c],u=te[c]),n.onmessage=e=>{const t=e.data,c={success:!1,mate:null,evaluation:null,continuation:""};if(t.includes("info depth")&&t.includes(" pv ")){if(t.includes(`info depth ${u}`)&&(n.terminate(),ne=null),i.test(t)){const e=i.exec(t)[1];c.evaluation=parseInt(e)/100}o.test(t)&&(c.mate=o.exec(t)[1],c.evaluation=null),r.test(t)&&(c.continuation=r.exec(t)[1]),"b"===l&&(c.evaluation&&(c.evaluation*=-1),c.mate&&(c.mate*=-1)),(c.mate||c.evaluation||c.continuation)&&(c.success=!0);let e=!1;if(a>=0&&s.test(t)){const n=s.exec(t)[1],o=a;parseInt(n)>=o&&(e=!0,m(c))}!e&&t.includes(`info depth ${u}`)&&m(c)}};const m=e=>{t(e),!E&&Q&&document.getElementById("btnVsBot")?.style.removeProperty("display")};n.postMessage("isready"),n.postMessage("ucinewgame"),n.postMessage("isready"),20===d?(n.postMessage("setoption name UCI_Elo value 5000"),n.postMessage("setoption name UCI_LimitStrength value false"),n.postMessage(`setoption name Skill Level value ${d}`)):(n.postMessage("setoption name UCI_Elo value 1320"),n.postMessage("setoption name UCI_LimitStrength value true"),n.postMessage(`setoption name Skill Level value ${d}`)),"chess960"===$&&n.postMessage("setoption name UCI_Chess960 value true"),n.postMessage(`position fen ${e}`);let p=`go depth ${u}`;a>-1&&(p+=` movetime ${a}`),n.postMessage(p)}(t,(t=>{Mt(t,e)}))}function Mt(e,t){if(!e.success)throw new Error("SF failed");if(!t)return;var n;W=!0,thinking&&(thinking.style.display="none"),n=e.continuation,e.mate,z=n.split(" ").map((e=>({from:e.slice(0,2),to:e.slice(2,5)})));const o=z.splice(0,1);if(!o.length)throw new Error("[SF_ERROR] No more moves found");const{from:r,to:i}=o[0];null!==je(r).pieceId&&Pe(r,i,!0)}we.addEventListener("click",(e=>{if(!E){if(!Ee)return we.innerText="Confirm?",we.style.color="skyblue",we.style.opacity="1",Ee=!0,void(ke=setTimeout((()=>{be()}),3e3));be(),le&&an(),document.querySelectorAll(".piece").forEach((e=>e.remove())),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),Ie(),"standard"===$?(M=!0,A=x.split(" "),T=A[0],Le()):"chess960"===$&&Dt(),Q&&document.getElementById("btnVsBot").style.removeProperty("display"),_.push(It()),Ue(),He(),_e(),pt(),o("analysis"),Q=!1,document.getElementById("thinking").style.display="none",document.getElementById("btnVsBot")?.classList.remove("glow"),ne&&(ne.terminate(),ne=null),Bt(),At(),document.getElementById("opening-name").textContent="",ve&&ye&&Rt(!1)}})),document.getElementById("btnFlip").addEventListener("click",(()=>{Rt()})),document.getElementById("btnVsBot").addEventListener("click",(e=>{E||W&&(Q=!Q,le&&an(),Q?(z=[],e.currentTarget.classList.add("glow"),K=M?"white":"black",W=!1,Tt(!0),j&&(j=null,He(),_e())):e.currentTarget.classList.remove("glow"))}));const Ft=document.getElementById("btnHint"),Pt=document.getElementById("hinting");Ft.addEventListener("click",(e=>{if(E)return;if(le||J)return;G=!G;const t=e.currentTarget;G?(t.classList.add("glow"),ln(D.length)):(t.classList.remove("glow"),Bt())})),document.getElementById("btnUndo").addEventListener("click",(t=>{if(E||!D.length)return;le&&an();let n=D.length,r=_.length,i=se.length,s=ie.length;const l=D[n-1],{from:c,to:a,promotion:d}=l;if("pending"===d)return void e("illegal");W=!0,j&&(He(),_e(),j=null),Q&&(ne&&ne.terminate(),document.getElementById("thinking").style.display="none",E||document.getElementById("btnVsBot").style.removeProperty("display")),Ue(),pt(),o("analysis"),Bt(),r--,_.splice(r,1);const u=_[r-1];A=u.split(" "),T=A[0],V=A[3],M=!A[1]||"w"===A[1],U=[],Le(),Ne(a,c),n--,D.splice(n,1);const m=s;s--,ie.splice(s,1);const p=Math.floor(s/2)+1,h=document.querySelector(`.pgn-row:nth-child(${p})`);if(m%2==0?h.querySelector(".pgn-col:nth-child(3)").textContent="":h.remove(),ie[s-1]?.includes("+")&&ft(M?F:P),i--,se.splice(i,1),Wt(),At(),D.length){const e=D[n-1];Oe(e.to,e.from)}ye&&setTimeout(Rt,300),e("lichess_move")}));const Nt=document.getElementById("btnRematch");function Ut(e,t,n){const o=document.querySelector(".pgn");if(o){let r=Math.floor(e/2)+1;"black"===n&&e%2==0&&(r=Math.max(r-1,1));let i=null,s=null,l=null,c=document.createElement("button");if(document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),"white"===n){i=document.createElement("div"),s=document.createElement("div"),l=document.createElement("span"),l.textContent=r+".",i.append(l),i.append(s);const e=document.createElement("div");e.classList.add("pgn-col"),i.append(e)}else s=document.querySelector(`.pgn-row:nth-child(${r}) .pgn-col:last-child`);c.textContent=t,c.onclick=()=>{cn(),ce=e,sn(e)},le||(ce=e),i&&(i.classList.add("pgn-row"),o.append(i)),s.classList.add("pgn-col"),c.classList.add("active"),s.append(c),c.scrollIntoView()}}Nt.addEventListener("click",(e=>{Nt.style.display="none",E&&b&&("finished"!==b.status&&"closed"!==b.status||mn(w,{type:"c.rematch.request"}))})),Nt.style.display="none",document.getElementById("btnCopyFenPGN").addEventListener("click",(()=>{let e=function(e=ie){let t=jt();for(let n=0;n<e.length;n++){const o=Math.floor(n/2)+1;n%2==0&&(t+=o+". "),t+=e[n]+" "}return t}();navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard")}));const _t=document.getElementById("btnCopyFenPGNALL");_t.addEventListener("click",(()=>{let e="";E&&b.pgnArchive?.length&&(e=function(e){let t="";return e.forEach((e=>{const n=e.rawPgn,{round:o,white:r,black:i,result:s,termination:l,fen:c}=e;let a=jt({round:o,white:r,black:i,result:s,termination:l,fen:c});for(let e=0;e<n.length;e++){const t=Math.floor(e/2)+1;e%2==0&&(a+=t+". "),a+=n[e]+" "}t+=a+"\n\n"})),t}(b.pgnArchive),navigator.clipboard.writeText(e),alert("FEN/PGN copied to clipboard"))})),_t.style.display="none";const Ht=document.getElementById("btnDraw");Ht.addEventListener("click",(()=>{E&&"ongoing"===b?.status&&ae&&confirm("Are you sure want to offer draw?")&&function(){const e=pn();e&&[b.black.rid,b.white.rid].includes(e)&&mn(w,{type:"c.draw.offer",data:pn()})}()})),Ht.style.display="none";const Ot=document.getElementById("btnResign");function jt(e){const t=e?.event??"?",n=e?.site??window.location.hostname,o=e?.date??d(),r=e?.round??"?",i=e?.white??"?",s=e?.black??"?",l=e?.result??"?",c=e?.fen??x,a=e?.termination;let u=`[Event "${t}"]\n`;return u+=`[Site "${n}"]\n`,u+=`[Date "${o}"]\n`,u+=`[Round "${r}"]\n`,u+=`[White "${i}"]\n`,u+=`[Black "${s}"]\n`,u+=`[Result "${l}"]\n`,u+=`[FEN "${c}"]\n`,a&&(u+=`[Termination "${a}"]\n`),u+"\n"}function Wt(e=""){let t=!1,n="";if(e||(n=D.map((e=>{let n=e.from+e.to;return e.promotion&&("pending"!==e.promotion?n+=e.promotion:t=!0),n})).join(",")),t&&!e)return;const o=document.getElementById("opening-name");o&&"chess960"!==$&&(e||(e=n),fetch(`https://explorer.lichess.ovh/masters?play=${e}`).then((e=>e.json())).then((e=>{const t=e?.opening?.name;t?o.innerHTML=t.replace(": ",":<br />"):o.textContent=""})))}function Dt(e=""){$="chess960";const t=a(e);return x=t.fen,A=x.split(" "),T=A[0],M=!A[1]||"w"===A[1],F=t.whiteKingSquareId,P=t.blackKingSquareId,ue=[`${t.kingRookFile}1`,`${t.kingRookFile}8`,`${t.queenRookFile}1`,`${t.queenRookFile}8`],B=t,Le(),t}function Vt(){s.includes("pink")?confettiHearts():confettis()}Ot.addEventListener("click",(()=>{E&&"ongoing"===b?.status&&(b.moveState.length<C||confirm("Are you sure you want to resign?")&&(b.status="finished",Ot.style.display="none",mn(w,{type:"c.resign"})))})),Ot.style.display="none";const zt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="6 3 20 12 6 21 6 3"/></svg>';let Kt=null;const Qt=500;let Gt=Qt;let Jt=!1;const Xt=document.querySelector(".actions.rewind"),Yt=document.getElementById("btnRewindPlay"),Zt=document.getElementById("btnRewindPrev"),en=document.getElementById("btnRewindNext"),tn=document.getElementById("btnRewindStop"),nn=document.getElementById("btnRewindStart"),on=document.getElementById("btnRewindEnd");function rn(){Gt=Math.max(75,Gt-50)}function sn(t,n){if(void 0===t)return;le=!0;const r=Jt;D.length===t+1&&cn();let i=_[t+1];if(-1===t&&(i=_[0]),T===i.split(" ")[0])return;if(o("analysis"),Bt(),t>=0){const e=[];for(let n=0;n<=t;n++)e.push(se[n]);Wt(e.join(","))}if(-1===t){const{from:e,to:t}=D[0];Ne(t,e)}pt(),He(),Ue(),_e(),document.querySelectorAll(".hl-square").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col button.active").forEach((e=>{e.classList.remove("active")})),Xt.style.display="flex";const s=document.querySelectorAll(".pgn-col button")[t];s?.classList.add("active");const l=s?.parentElement,c=l?.parentElement;c?.scrollIntoView({behavior:"smooth"}),c||document.querySelector(".pgn-row span")?.scrollIntoView({behavior:"smooth"}),O=null,j=null,U=[],T=i.split(" ")[0],Le();const a=D[t];if(/left/i.test(n)){const n=D[t+1];n&&(Ne(n.to,n.from),n.castle?e("castle"):n.promotion?e("promote"):e("lichess_move"))}if(!a)return;const{from:d,to:u,color:m,castle:p,promotion:h,hasCapture:f}=a;!/right/i.test(n)&&n||(Ne(d,u),e(p?"castle":h?"promote":f&&Jt?"capture":f&&!Jt?"lichess_capture":"move")),p&&"standard"===$&&bt(m,u);const g="white"===m?"black":"white",y=ie[t],v=y.includes("+"),w=y.includes("#");if(v||w){const t=U.find((e=>e.color===g&&"king"===e.pieceType)).squareId;if(v&&(ht(t),e("check")),w){const n=U.find((e=>e.color===m&&"king"===e.pieceType)).squareId;mt(t),mt(n,"ðŸ’Ž"),r&&(Vt(),e("gameEnd"))}ft(t,w)}Oe(d,u);let k=!0;E&&(k=!1,"finished"===b.status&&(k=!0)),k&&!r&&ln(t)}function ln(e){if(e<=1)return;const r=D[e],i=(e,i,s,l="limegreen")=>{o("analysis");const c=r?.from,a=r?.to;if(r&&e===c&&i===a)n(r?.goodMoveFrom===c&&r?.goodMoveTo===a?{squareId:a}:{squareId:a,emoji:"â˜‘ï¸"});else{l=r?.goodMoveFrom===e&&r?.goodMoveTo===i?"limegreen":l,r||(l="maroon"),r&&t({origSquareId:c,destSquareId:a,color:"rgba(100, 100, 100, 0.5)"}),t({origSquareId:e,destSquareId:i,color:l})}r&&s&&r.promotion!==s&&n({squareId:a,emoji:"âŒ"})},s=_[e],l=r?.goodMoveFrom,c=r?.goodMoveTo,a=r?.goodMovePromotion;r&&l&&c?i(l,c,a):xt(s,((e,t,n)=>{i(e,t,n,"orange")}))}function cn(){clearTimeout(Kt),Jt=!1,Yt.innerHTML=zt,le=!1,Gt=Qt}function an(){le=!1,ce=D.length,O=null,j=null,cn(),e("gameStart");const t=_.length-1;if(document.querySelectorAll(".pgn-col button.active").forEach((e=>e.classList.remove("active"))),document.querySelector(".pgn-row:last-child .pgn-col:last-child button:last-child")?.classList.add("active"),U=[],T=_[t].split(" ")[0],Le(),o("analysis"),Bt(),D.length){const{from:e,to:t}=D[D.length-1];Oe(e,t)}Gt=Qt,clearTimeout(Kt),Xt.style.display="none"}function dn({direction:e,ev:t}){if(!D.length)return;let n=e||t.key;const o=e=>{switch(e){case"ArrowLeft":case"left":ce=Math.max(-1,ce-1);break;case"ArrowRight":case"right":ce=Math.min(D.length-1,ce+1)}if(ce>=-1&&ce<=D.length)return ce};switch(n){case"ArrowLeft":case"left":case"ArrowRight":case"right":sn(o(n),n)}}function un(){mn(w,{data:pn()??"anything",type:"c.connection.ping"})}function mn(e,t){e.send(JSON.stringify(t))}function pn(){return localStorage.getItem("rid")}function hn(){mn(w,{type:"c.rid.register"})}function fn(e){o("analysis"),Bt();const{variant:t,boardState:n,moveState:r,fenState:i,rawPgn:s,white:l,black:c,status:a,scores:d,pgnArchive:m,time:p}=e;if($=t,b=e,x=i[0],U=n,D=r,_=i,ie=s,"chess960"===$&&Dt(x),A=i[i.length-1].split(" "),T=A[0],M=!A[1]||"w"===A[1],Le(),Wt(),document.querySelectorAll(".pgn-row").forEach((e=>e.remove())),document.querySelectorAll(".pgn-col").forEach((e=>e.remove())),document.querySelectorAll("#btnReset").forEach((e=>e.remove())),document.querySelectorAll("#btnAutoFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnFlip").forEach((e=>e.remove())),document.querySelectorAll("#btnUndo").forEach((e=>e.remove())),document.querySelectorAll("#btnHint").forEach((e=>e.remove())),document.querySelectorAll(".eval").forEach((e=>e.remove())),_t.style.display="inline-block","ontouchstart"in window||navigator.maxTouchPoints>0||(document.querySelector("aside").style.marginTop="2.8rem"),r.length>=C&&(Ot.style.display="inline-block"),S=l?.name||null,q=c?.name||null,V=A[3],pn()===c?.rid?Rt(!0):Rt(!1),ie.forEach(((e,t)=>{const n=r[t].color;if(Ut(t,e,n),t+1===r.length&&(e.includes("+")||e.includes("#"))){let t=null;"white"===n?t=P:"black"===n&&(t=F),ft(t,e.includes("#")),e.includes("#")&&mt(t)}})),D.forEach((({from:e,to:t,promotion:n})=>{const o=e+t;n&&(o+=n),se.push(o)})),S&&q){const e=document.querySelector(".score .bottom span.name");e&&(e.textContent=ve?q:S);const t=document.querySelector(".score .top span.name");t&&(t.textContent=ve?S:q)}wn(d),"waiting"!==a&&u(),"ongoing"===a||("finished"===a?(Nt.style.display="block",Ot.style.display="none",W=!1,En(m[0])):"closed"===a&&(Nt.style.display="none")),p?yn(e.time):function(){if(!E)return;const e=document.getElementById("app"),t=document.createElement("div");e.append(t),t.classList.add("form-time-container");[{logo:"ðŸš€",name:"bullet",values:["1+0","1+2","2+1"]},{logo:"âš¡",name:"blitz",values:["3+0","3+2","5+0"]},{logo:"â²ï¸",name:"rapid",values:["10+0","15+10","30+0"]}].forEach((({logo:e,name:n,values:o})=>{const r=document.createElement("div");t.append(r),r.classList.add(n);const i=document.createElement("span");i.textContent=e,r.append(i),o.forEach((e=>{const n=document.createElement("button"),[o,i]=e.split("+");r.append(n);let s=o;+i&&(s+="+"+i),n.textContent=s,n.addEventListener("click",(()=>{mn(w,{type:"c.time.set",data:e}),t.remove()}))}))}))}()}function gn(e,t){mn(w,{type:"c.play.move",data:{from:e,to:t,moveState:D[D.length-1]}})}function yn(e){b.time=e;const t=document.querySelector(".form-time-container");t&&t.remove();let[n]=e.split("+");if(n=n.padStart(2,"0"),bn(),["finished","closed"].includes(b.status))return;const o=document.querySelector(".score .bottom span.time"),r=document.querySelector(".score .top span.time");o&&(o.textContent=`${n}:00`,o.classList.add("active"),o.classList.remove("rush")),r&&(r.textContent=`${n}:00`,r.classList.add("active"),r.classList.remove("rush")),bn(),"waiting"===b.status&&c()}function vn(){const e=pn();if(!E||!b||!e)return!0;return(M?b.white?.rid:b.black?.rid)===e}function wn(e){const t=document.querySelector(".score .bottom span:first-child"),n=e=>e.replace(/\b(\d+)\.(\d+)\b/g,((e,t,n)=>n?"0"===t?"Â½":`${t} Â½`:e));t&&(t.textContent=ve?e[1]:e[0],t.textContent=n(t.textContent),ve?t.parentElement.classList.add("flip"):t.parentElement.classList.remove("flip"));const o=document.querySelector(".score .top span:first-child");o&&(o.textContent=ve?e[0]:e[1],o.textContent=n(o.textContent),ve?o.parentElement.classList.add("flip"):o.parentElement.classList.remove("flip")),"finished"===b.status&&document.querySelectorAll(".time").forEach((e=>e.classList.add("active")))}function kn(){mn(w,{type:"c.draw.accepted",data:!0}),W=!1}function En(e){if(!/resign/i.test(e.termination))return;let t="";t=e.termination.split(" ")[0]===e.black?"white":"black";const n="white"===t?F:P;mt(n,"ðŸš©"),ft(n,!0)}function bn(){if(!(b&&b.time&&b.moveState.length&&b.timeWhite&&b.timeBlack))return;L||h();const{timeWhite:e,timeBlack:t}=b;clearInterval(I);const n=e=>{e=Math.max(e,0);const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);let o=0;e<=1e4&&(o=Math.floor(e%1e3/100));const r=e=>e.toString().padStart(2,"0"),i=e<=1e4?"."+o:"";return`${r(t)}:${r(n)}${i}`},o=e=>`.score .${e} span.time`,r=(e,t)=>{t<=1e4?e.classList.add("rush"):e.classList.remove("rush")};if(["bottom","top"].forEach((i=>{const s=document.querySelector(o(i));let l=0;l="bottom"===i?ve?t.remaining:e.remaining:ve?e.remaining:t.remaining,s.textContent=n(l),r(s,l)})),"ongoing"!==b.status)return;const i=M?"white":"black";let s=null;s="white"===i?b.timeWhite:b.timeBlack;let l=((e,t)=>{if(!t)return e;return e-=Date.now()-t})(s.remaining,s.start);l<=0&&Sn(i);let c=1e3;const a=()=>{if(l-=c,"ongoing"===b.status&&l>0&&(l>=1e4?c=1e3:l<1e4&&90!==c&&(c=90,clearInterval(I),I=null),I||(I=setInterval(a,c))),l<=0)return void Sn(i);const e=n(l);let t="white"===i?"bottom":"top";const s=pn()===b.white.rid&&"white"===i,d=pn()===b.white.rid&&"white"!==i,u=pn()===b.black.rid&&"black"===i,m=pn()===b.black.rid&&"black"!==i;s||u?t="bottom":(d||m)&&(t="top");const p=document.querySelector(o(t));document.querySelectorAll(".time").forEach((e=>e.classList.remove("active"))),p&&(p.textContent=e,p.classList.add("active"),r(p,l))};I=setInterval(a,c)}function Sn(e){b.status="finished",W=!1,clearInterval(I),mn(w,{type:"c.time.out",data:e})}Yt.innerHTML=zt,Zt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>',en.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>',tn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',nn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',on.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>',Yt.addEventListener("click",(()=>{if(Jt=!Jt,Jt){Yt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect x="14" y="4" width="4" height="16" rx="1"/><rect x="6" y="4" width="4" height="16" rx="1"/></svg>';const e=()=>{dn({direction:"right"}),Kt=setTimeout(e,1e3)};e()}else cn()})),tn.addEventListener("click",(()=>{an()})),Zt.addEventListener("pointerdown",(()=>{cn();const e=()=>{dn({direction:"left"}),Kt=setTimeout(e,Gt),rn()};e()})),Zt.addEventListener("pointerup",(()=>{cn()})),en.addEventListener("pointerdown",(()=>{cn();const e=()=>{dn({direction:"right"}),Kt=setTimeout(e,Gt),rn()};e()})),en.addEventListener("pointerup",(()=>{cn()})),nn.addEventListener("click",(()=>{o("analysis"),Bt(),ce=-1,cn(),sn(ce,"left")})),on.addEventListener("click",(()=>{ce=D.length-1,sn(ce,"right")})),window.addEventListener("keydown",(e=>{dn({ev:e})}))})();